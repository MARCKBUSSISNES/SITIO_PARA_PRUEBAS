var indic = "";
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>MTR ONLINE AP</title>

  <style>
    :root{
      --bg:#000000;
      --panel:#e09898;
      --panel2:rgba(192, 191, 255, 0.905);
      --text:#000000;
      --muted:#94b4ff;

      --pink:#ff4fb7;
      --purple:#a855f7;
      --rose:#fb7185;

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --border:rgba(36, 20, 40, .10);
      --shadow: 0 16px 40px rgba(20, 10, 25, .10);
      --shadow2: 0 10px 26px rgba(20, 10, 25, .07);

      --radius: 22px;
      --radius2: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;

      --focus: 0 0 0 4px rgba(255, 79, 182, 0.332);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      overflow-x:hidden;

      background:
        radial-gradient(900px 650px at 18% 8%, rgba(255,79,183,.20), transparent 55%),
        radial-gradient(800px 520px at 85% 5%, rgba(168,85,247,.20), transparent 60%),
        radial-gradient(700px 520px at 70% 90%, rgba(251,113,133,.16), transparent 55%),
        var(--bg);
    }

    /* subtle floating sparkles */
    .sparkle{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.35;
      mix-blend-mode:multiply;
      background-image:
        radial-gradient(circle at 12% 18%, rgba(255,79,183,.22) 0 2px, transparent 3px),
        radial-gradient(circle at 84% 22%, rgba(168,85,247,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 78%, rgba(251,113,133,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 28% 72%, rgba(255,79,183,.14) 0 2px, transparent 3px);
      animation: drift 12s ease-in-out infinite alternate;
      filter: blur(.2px);
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) scale(1); }
      to{ transform: translate3d(-10px, 8px, 0) scale(1.02); }
    }

    .app{
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }

    /* Sidebar */
    .sidebar{
      position: sticky;
      top: 14px;
      align-self: start;
      height: calc(100vh - 28px);
      background: linear-gradient(180deg, rgba(230, 7, 193, 0.92) 0%, rgba(0, 0, 0, 0.92) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;

      animation: pop .35s ease-out both;
    }
    @keyframes pop{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .brand h1{
      font-size: 15px;
      margin:0;
      line-height:1.15;
      letter-spacing:.2px;
      font-weight: 1000;
    }
    .brand small{display:block;color:var(--muted); font-weight:800; margin-top:2px}

    .hamburger{
      width:42px;height:42px;border-radius:16px;
      border:1px solid var(--border);
      background:#000000;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(17,10,20,.07);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .hamburger:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(17,10,20,.10); }
    .hamburger:active{ transform: translateY(0); }
    .burger{ width:18px;height:12px; position:relative; }
    .burger span{
      position:absolute; left:0; right:0;
      height:2px; border-radius:999px;
      background: linear-gradient(90deg, var(--pink), var(--purple));
    }
    .burger span:nth-child(1){top:0}
    .burger span:nth-child(2){top:5px}
    .burger span:nth-child(3){bottom:0}

    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: var(--shadow2);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(164, 86, 204, 0.09);
    }
    .nav button .tag{
      font-weight:1000;
      font-size:12px;
      padding: 4px 10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,79,183,.14), rgba(168,85,247,.14));
      color: #7b2fb4;
      border:1px solid rgba(168,85,247,.18);
      white-space:nowrap;
    }
    .nav button.active{
      border-color: rgba(255,79,183,.55);
      box-shadow: 0 18px 34px rgba(255,79,183,.18);
      background: linear-gradient(180deg, #fff 0%, #fff1fa 100%);
      animation: navPulse 1.1s ease-in-out infinite;
    }
    /* NAV ACTIVE ANIM */
    @keyframes navPulse{
      0%{ transform: translateX(0) scale(1); }
      50%{ transform: translateX(6px) scale(1.01); }
      100%{ transform: translateX(0) scale(1); }
    }

    .sidecard{
      margin-top:14px;
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,79,183,.38);
      background: rgba(255,255,255,.84);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      color:#7b2fb4;
      background: rgba(168,85,247,.12);
      border:1px solid rgba(168,85,247,.25);
      padding: 6px 10px;
      border-radius:999px;
    }
    .sidecard .row{
      display:flex; justify-content:space-between; gap:10px; margin:8px 0;
      color:var(--muted); font-weight:800;
    }
    .sidecard .row b{color:var(--text)}

    /* Main */
    .main{
      min-height: calc(100vh - 36px);
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      overflow: visible; /* key: don't cut the right card */
      animation: pop .35s ease-out both;
      max-width:100%;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 6px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 14px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h2{margin:0;font-size:18px}
    .title p{margin:0;color:var(--muted);font-weight:800;font-size:13px}

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      border:none;
      cursor:pointer;
      font-weight:1000;
      padding: 11px 14px;
      border-radius: 16px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow: 0 10px 22px rgba(135, 77, 160, 0.06);
      color:var(--text);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 16px 30px rgba(17,10,20,.09); }
    .btn:active{ transform: translateY(0); }
    .btn.small{ padding:9px 12px; border-radius:14px; font-weight:1000; }

    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--purple));
      color:white;
      border:none;
      box-shadow: 0 16px 34px rgba(255,79,183,.26);
    }
    .btn.ok{
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(34,197,94,.22);
    }
    .btn.danger{
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(239,68,68,.22);
    }

    /* Key: minmax(0,...) prevents horizontal overflow from inputs/selects */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap: 14px;
      margin-top: 14px;
    }

    .card, .field, .rowflex, .table{ min-width:0; }

    .card{
      background: rgba(255,255,255,.90);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
      position:relative;
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      opacity:0;
      border-radius: calc(var(--radius) + 2px);
      background: radial-gradient(700px 180px at 20% 0%, rgba(255,79,183,.12), transparent 50%),
                  radial-gradient(700px 180px at 80% 0%, rgba(168,85,247,.12), transparent 50%);
      transition: opacity .22s ease;
    }
    .card:hover::after{ opacity:1; }

    .card h3{margin:0 0 10px 0; font-size:15px; font-weight:1000}
    .muted{color:var(--muted); font-weight:800; font-size:13px}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .form.stack{ grid-template-columns: 1fr; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .field input, .field select, .field textarea{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-weight:900;
      color:var(--text);
      min-width:0;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(255,79,183,.55);
      box-shadow: var(--focus);
    }

    .field.full{grid-column:1 / -1}

    .rowflex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .rowflex .grow{ flex:1; }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-weight:900;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      background: rgba(255,79,183,.09);
      color:#6b1f5b;
    }
    .table td small{color:var(--muted); font-weight:900}
    .table tr:last-child td{border-bottom:none}

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      padding:12px;
      border-radius: var(--radius2);
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(17,10,20,.05);
    }
    .kpi .label{ color:var(--muted); font-weight:1000; font-size:12px }
    .kpi .value{ font-size:18px; font-weight:1100; margin-top:4px }
    .kpi .value span{ font-size:12px; color:var(--muted); font-weight:1000 }

    .hide{ display:none !important; }
.hidden{ display:none !important; }

    /* Receipt */
    .receiptWrap{ display:flex; gap:12px; flex-wrap:wrap; }
    .receipt{
      width: 360px; /* default; can be overridden dynamically for ENV√çO */
      background: #ffffff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 34px rgba(0,0,0,.11);
      transform-origin: top center;
      animation: floatIn .35s ease-out both;
      position:relative;
    }
    .cornerLogo{
      position:absolute;
      top:10px;
      right:10px;
      width:60px;
      height:60px;
      object-fit:contain;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      padding:4px;
    }
      ${isEnv ? `
      body{ background:#fff !important; color:#000 !important; }
      .box{ border:2px solid #000 !important; background:#fff !important; }
      .bar{ background:#000 !important; }
      h1{ color:#000 !important; }
      .meta{ color:#000 !important; font-weight:900 !important; }
      th{ background:#fff !important; border-bottom:1px solid #000 !important; }
      th,td{ border-bottom:1px solid #000 !important; color:#000 !important; }
      .label{ color:#000 !important; font-weight:900 !important; }
      .val{ color:#000 !important; font-weight:900 !important; }
      .totalRow{ color:#000 !important; }
      .cornerLogo{ border:1px solid #000 !important; }
    ` : ""}
    @keyframes floatIn{
      from{ transform: translateY(10px) scale(.98); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .receipt .logo{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      margin-bottom:10px;
      padding-right:60px; /* espacio para logo esquina */
    }
    .receipt .logo b{ font-size:14px; letter-spacing:.3px; }
    .receipt .logo small{ display:block; color:#666; font-weight:900 }
    .receipt .line{ display:flex; justify-content:space-between; gap:10px; font-weight:1000; font-size:12px; margin:6px 0 }
    .receipt .line{ align-items:flex-start; }
    .receipt .line span:first-child{ flex:0 0 90px; }
    .receipt .line span:last-child{ flex:1 1 auto; text-align:right; word-break:break-word; overflow-wrap:anywhere; }
    .receipt.envio .line{ font-size:11px; }
    .receipt.envio .big{ font-size:14px; }
    .receipt.envio{ border:2px solid #000; }
    .receipt.envio .hr{ background: rgba(0,0,0,.35); }
    .receipt.envio .cornerLogo{
      /* mantener mismo logo/tama√±o del sitio; solo m√°s contraste general se maneja por tipograf√≠a */
      border:1px solid rgba(0,0,0,.06);
    }
    .receipt .hr{ height:1px; background:rgba(0,0,0,.08); margin:10px 0 }
    .receipt .big{ font-size:16px; font-weight:1200; display:flex; justify-content:space-between; margin-top:10px; }
    .receipt .foot{ margin-top:10px; font-size:11px; color:#666; font-weight:900 }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      font-size:11px;
      padding: 4px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.7);
      margin-top:6px;
    }
    .badge.pending{ border-color: rgba(245,158,11,.40); background: rgba(245,158,11,.12); color:#7a4b00; }
    .badge.paid{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color:#0e5b2a; }

    /* Responsive */
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .receipt{ width:100%; }
    }

    /* Capture mode (para PNG n√≠tido, sin overlays) */
    body.capture-mode .sparkle{ display:none !important; }
    body.capture-mode #receiptBox,
    body.capture-mode #closeBox{
      opacity: 1 !important;
      filter: none !important;
      transform: none !important;
    }
/* Cintillo amarillo simple */
.simpleNotice {
  width: 100%;
  background: #ffd400;
  color: #111;
  text-align: center;
  font-weight: 900;
  font-size: 14px;
  padding: 8px 10px;
  border-bottom: 1px solid rgba(0,0,0,.25);
}

  

/* ===== MODAL C√ìDIGO (EDICI√ìN) ===== */
.mb-modal{
  position:fixed; inset:0; z-index:9999;
  display:none; align-items:center; justify-content:center;
  padding:14px;
  background:rgba(0,0,0,.65);
}
.mb-modal.show{display:flex;}
.mb-modal-card{
  width:min(520px,100%);
  background:linear-gradient(180deg, rgba(28,28,30,.98), rgba(18,18,20,.98));
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 24px 70px rgba(0,0,0,.6);
  overflow:hidden;

  color: var(--pink);
}
.mb-modal-head{
  display:flex; align-items:center; gap:12px;
  padding:14px;
  background:rgba(255,255,255,.03);
  border-bottom:1px solid rgba(255,255,255,.06);
}
.mb-modal-logo{width:46px;height:46px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.06);padding:6px}
.mb-modal-title{font-weight:900;letter-spacing:.2px;color:var(--pink)}
.mb-modal-sub{font-size:12px;opacity:.9;margin-top:2px;color:rgba(255,79,183,.85)}
.mb-modal-x{
  margin-left:auto;
  width:40px;height:40px;
  border-radius:12px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.08);
  color:var(--pink);
  cursor:pointer;
}
.mb-modal-body{padding:14px}
.mb-modal-input{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  color:#fff;
  font-size:16px;
  outline:none;
  margin-top:6px;
}
.mb-modal-input::placeholder{color:rgba(255,79,183,.55)}

.mb-modal-input:focus{border-color: rgba(255,79,183,.85); box-shadow:0 0 0 4px rgba(255,79,183,.22);}
.mb-modal-actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
.mb-modal-actions button{flex:1; min-width:140px}
.mb-modal-err{color:#ff6b6b;font-size:12px;margin-top:8px;min-height:16px}
/* ===== MODAL MENSAJE (OK) ===== */
.ok-modal{position:fixed;inset:0;z-index:9998;display:none;align-items:center;justify-content:center;padding:14px;background:rgba(0,0,0,.65);}
.ok-modal.show{display:flex;}
#genProdOverlayMB.ok-modal{z-index:10050;}
#invOverlayMB.ok-modal{z-index:10050;}
#mixOverlayMB.ok-modal{z-index:10050;}
.ok-card{width:min(520px,100%);background:linear-gradient(180deg, rgba(28,28,30,.98), rgba(18,18,20,.98));border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 24px 70px rgba(0,0,0,.6);overflow:hidden;color:#fff;}
.ok-head{display:flex;align-items:center;gap:12px;padding:14px;background:rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.06);}
.ok-logo{width:46px;height:46px;object-fit:contain;border-radius:12px;background:rgba(255,255,255,.06);padding:6px}
.ok-title{font-weight:900;letter-spacing:.2px}
.ok-body{padding:14px}
.ok-msg{font-size:13px;opacity:.9;line-height:1.45}
.ok-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}


#view-products .productsGrid{ grid-template-columns:1fr; }

/* ===== LOADING SPINNER (COBRAR) ===== */
#checkoutLoading.ok-modal{ z-index:9999; }
.loading-card{
  width:min(420px,100%);
  background:linear-gradient(180deg, rgba(28,28,30,.98), rgba(18,18,20,.98));
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 24px 70px rgba(0,0,0,.6);
  overflow:hidden;
  color:#fff;
}
.loading-body{ padding:18px; display:flex; align-items:center; gap:14px; }
.loading-spinner{
  width:56px; height:56px;
  border-radius:999px;
  border:6px solid rgba(255,255,255,.20);
  border-top-color: var(--pink);
  animation: spin 1s linear infinite;
  flex:0 0 auto;
}
@keyframes spin{ to{ transform: rotate(360deg); } }
.loading-text b{ display:block; font-weight:1000; letter-spacing:.2px; }
.loading-text small{ display:block; margin-top:4px; opacity:.85; font-weight:800; }


/* --- UI cleanup: Generador --- */
#genCreatePanelMB{display:none!important;}

</style>
</head>
<body>
<div class="simpleNotice">
  ‚úÖ  PAGO AL DIA / V.56 / 07-FEB-26
</div>

  <div class="sparkle"></div>
<div class="menuOverlay" id="menuOverlay"></div>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
  <img src="LOGO1.png" alt="Logo" style="
    width:90px;
    height:90px;
    object-fit:contain;
    border-radius:12px;
  ">
  <div>
    <h1>MTR ONLINE <small>ATLANTIC PLAZA</small></h1>
  </div>
        <button class="hamburger" id="btnToggle" title="Men√∫">
          <div class="burger"><span></span><span></span><span></span></div>
        </button>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="pos"><span>üßæ Registro de Ventas</span><span class="tag">VENTA</span></button>
        <button data-view="shipments"><span>üöö Env√≠os pendientes</span><span class="tag">ENV√çO</span></button>
        <button data-view="clients"><span>üë©‚Äçüíº Clientes</span><span class="tag">DB</span></button>
        <button data-view="reports"><span>üìä Reportes</span><span class="tag">D/W/M</span></button>
                <button type="button" onclick="openLabelsModal()"><span>üè∑Ô∏è Generador</span><span class="tag">ETI</span></button>
<button data-view="products"><span>üß∑ Productos</span><span class="tag">SKU</span></button>
        <button data-action="prodform"><span>‚ûï Crear productos / Mod</span><span class="tag">FORM</span></button>
        <button data-view="inventory"><span>üì¶ Inventarios</span><span class="tag">STOCK</span></button>
        <button data-view="kardex"><span>üìä</span><b>Kardex</b><i>Movimientos</i></button>
<button data-view="close"><span>üßæ Cierres</span><span class="tag">D√çA</span></button>
        <button data-view="settings"><span>‚öôÔ∏è Ajustes</span><span class="tag">LOCAL</span></button>
      </div>

      <div class="sidecard">
        <div class="pill">üíó TUS VENTAS HOY</div>
        <div class="row"><span>Clientes</span><b id="kClients">0</b></div>
        <div class="row"><span>Productos</span><b id="kProducts">0</b></div>
        <div class="row"><span>Ventas (hoy)</span><b id="kSalesToday">0</b></div>
        <div class="row"><span>Total (hoy)</span><b id="kTotalToday">Q0.00</b></div>
        <div class="row"><span>Env√≠os pendientes</span><b id="kShipPending">0</b></div>
        <div class="muted" style="margin-top:10px">
          Tip: usa <b>Escanear</b> y pasa el lector. (F2 enfoca el campo)
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="viewTitle">DASH PRINCIPAL</h2>
          <p id="viewSub">Soporte tecnico tel: 58140-621</p>
        </div>
        <div class="actions">
          <button class="btn small" id="btnBackup">Exportar Back Up</button>
          <button class="btn small" id="btnRestore">Importar Back Up</button>
	  <button id="btnPickBackupFolder">üìÅ Elegir carpeta de Backups</button>
        </div>
      </div>

      <!-- POS VIEW -->
      <section id="view-pos">
        <div class="grid">
          <div class="card">
            <h3>üßæ Venta</h3>

            <div class="form" style="margin-bottom:10px">
              <div class="field full">
                <label>Escanear c√≥digo de barras (SKU / C√≥digo)</label>
                <div class="rowflex">
                  <input id="scanInput" class="grow" inputmode="text" placeholder="ESCANEE EL CODIGO DE BARRAS" autocomplete="off" />
                  <button class="btn primary" id="btnScan">Escanear</button>
                </div>
                <div class="muted">.</div>
              </div>

              <div class="field">
                <label>Cantidad</label>
                <input id="qtyInput" type="number" min="1" value="1"/>
              </div>
              <div class="field">
                <label>Buscar producto (por nombre)</label>
                <input id="productSearch" placeholder="Ej: blusa, jeans..." />
              </div>

              <div class="field full">
                <label>Productos encontrados</label>
                <div class="rowflex">
                  <select id="productPicker" class="grow"></select>
                  <button class="btn" id="btnAddPicked">Agregar</button>
                </div>
              </div>
            </div>

            <table class="table" id="cartTable">
              <thead>
                <tr>
                  <th style="width:70px">Cant</th>
                  <th>Producto</th>
                  <th style="width:110px">Precio</th>
                  <th style="width:120px">Desc</th>
                  <th style="width:110px">Total</th>
                  <th style="width:110px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>

            <div class="totals">
              <div class="kpi">
                <div class="label">Subtotal</div>
                <div class="value" id="subTotal">Q0.00</div>
              </div>
              <div class="kpi">
                <div class="label">Total</div>
                <div class="value" id="grandTotal">Q0.00 <span>(Q)</span></div>
              </div>
            </div>

            <div class="muted" style="margin-top:8px">
              Descuento aplicado: <b id="discTotal">Q0.00</b>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∏ Descuento</h3>
              <div class="rowflex">
                <select id="discType" class="grow">
                  <option value="NONE">SIN DESCUENTO</option>
                  <option value="Q">DESCUENTO (Q)</option>
                  <option value="PCT">DESCUENTO (%)</option>
                </select>
               <input id="discValue" type="number" min="0" step="0.01" value="0" style="max-width:160px">
                <button class="btn" id="btnApplyDisc">Aplicar</button>
                <button class="btn danger" id="btnClearDisc">Quitar</button>
              </div>
              <div class="muted" style="margin-top:8px">
                El descuento se refleja en el ticket/PDF/PNG y el texto de WhatsApp.
              </div>
            </div>

            <div class="rowflex" style="margin-top:12px">
              <button class="btn" id="btnClearCart">Limpiar</button>
              <button class="btn ok" id="btnCheckout">Cobrar</button>
            </div>

            <div class="muted" style="margin-top:10px">
              *Si eliges <b>ENV√çO</b>, se crea un <b>env√≠o pendiente</b>. Solo al marcarlo como <b>PAGADO</b> contar√° como venta.
            </div>
          </div>

          <div class="card">
            <h3>üí≥ Pago + Cliente</h3>

            <div class="form">
              <div class="field">
                <label>Forma de pago</label>
                <select id="payMethod">
                  <option value="EFECTIVO">EFECTIVO</option>
                  <option value="TARJETA">TARJETA</option>
                  <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                  <option value="MIXTO">MIXTO (EFECTIVO + TARJETA)</option>
                </select>
              </div>

              <div class="field" id="mixPayWrap" style="display:none">
                <label>Pago mixto</label>
                <div class="rowflex" style="gap:10px">
                  <div style="flex:1">
                    <div class="muted" style="margin-bottom:6px">Efectivo (Q)</div>
                    <input id="mixCash" type="number" min="0" step="0.01" placeholder="0.00"/>
                  </div>
                  <div style="flex:1">
                    <div class="muted" style="margin-bottom:6px">Tarjeta (Q)</div>
                    <input id="mixCard" type="number" min="0" step="0.01" placeholder="0.00"/>
                  </div>
                </div>
                <div class="muted" style="margin-top:6px">La suma debe ser igual al total.</div>
              </div>

              <div class="field">
                <label>Tipo de venta</label>
                <select id="saleType">
                  <option value="MOSTRADOR">MOSTRADOR</option>
                  <option value="ENVIO">ENV√çO</option>
                </select>
              </div>

              <div class="field full">
                <label>Tel√©fono (para buscar/crear cliente)</label>
                <div class="rowflex">
                  <input id="cPhone" class="grow" placeholder="Ej: 5555-5555" />
                  <button class="btn" id="btnFindClient">Buscar</button>
                </div>
                <div class="muted">En <b>ENV√çO</b> es obligatorio tener cliente.</div>
              </div>

              <div class="field">
                <label>Nombres</label>
                <input id="cNames" placeholder="Ej: Karina"/>
              </div>
              <div class="field">
                <label>Apellidos</label>
                <input id="cLast" placeholder="Ej: L√≥pez"/>
              </div>

              <div class="field">
                <label>NIT</label>
                <input id="cNit" placeholder="Ej: CF / 1234567-8"/>
              </div>

              <div class="field full">
                <label>Direcci√≥n</label>
                <textarea id="cAddr" rows="3" placeholder="Ej: Col. X, casa #, zona..., referencias..."></textarea>
              </div>

              <div class="field full">
                  <label>Indicaciones (referencias / comentario)</label>
                  <textarea id="cIndic" rows="3" placeholder="Ej: Port√≥n negro, llamar al llegar, casa con rejas..."></textarea>
              </div>

              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveClient">Guardar cliente</button>
                  <button class="btn" id="btnUseWalkIn">Venta sin cliente</button>
                </div>
                <div class="muted">‚ÄúVenta sin cliente‚Äù solo aplica para MOSTRADOR.</div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üßæ Comprobante</h3>
              <div class="rowflex">
                <button class="btn" id="btnCopyReceipt">Copiar texto</button>
                <button class="btn" id="btnPDF">PDF</button>
                <button class="btn" id="btnDownloadReceipt">PNG</button>
                <button class="btn primary" id="btnWhatsApp">WhatsApp</button>
              </div>
              <div class="muted" style="margin-top:10px">
                PDF abre impresi√≥n (Guardar como PDF). WhatsApp abre texto listo.
              </div>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="receiptBox">
                <img class="cornerLogo" src="LOGO1.png" onerror="this.style.display='none'" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="rShop">Tienda de Ropa</b>
                    <small id="rMeta">Recibo ‚Ä¢ Offline</small>
                    <div id="rStatusBadge" class="badge paid hide">‚úÖ PAGADO</div>
                  </div>
                  <div style="text-align:right">
                    <b id="rNo">#000001</b>
                    <small id="rDate">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Cliente</span><span id="rClient">MOSTRADOR</span></div>
                <div class="line"><span>Tel√©fono</span><span id="rPhone">‚Äî</span></div>
                <div class="line"><span>NIT</span><span id="rNit">‚Äî</span></div>
                <div class="line"><span>Direcci√≥n</span><span id="rAddr">‚Äî</span></div>
                <div class="line"><span>Indicaciones</span><span id="rIndic">‚Äî</span></div>
                <div class="hr"></div>

                <div id="rItems"></div>

                <div class="hr"></div>
                <div class="line" id="rSubLine"><span>Subtotal</span><span id="rSub">Q0.00</span></div>
                <div class="line" id="rDiscLine"><span>Descuento</span><span id="rDisc">Q0.00</span></div>
                <div class="line" id="rPayLine"><span>Pago</span><span id="rPay">EFECTIVO</span></div>
                <div class="big" id="rTotalLine"><span>Total</span><span id="rTotal">Q0.00</span></div>
                <div class="foot">¬°Gracias por tu compra! üíó</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SHIPMENTS VIEW -->
      <section id="view-shipments" class="hide">
        <div class="card">
          <h3>üöö Env√≠os pendientes (solo ENV√çO)</h3>
          <div class="rowflex">
            <input id="shipSearch" class="grow" placeholder="Buscar por tel√©fono, nombre o #recibo..."/>
            <select id="shipFilter" style="max-width:220px">
              <option value="ALL">Todos</option>
              <option value="PENDIENTE">Pendientes</option>
              <option value="PAGADO">Pagados</option>
            </select>
            <button class="btn" id="btnShipRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">
            Al cobrar en <b>ENV√çO</b>, el env√≠o queda <b>PENDIENTE</b>. Solo al marcar <b>PAGADO</b> se crea la venta (aparece en reportes/cierres).
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Recibo</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th>Estatus</th>
                  <th style="width:240px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="shipBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLIENTS VIEW -->
      <section id="view-clients" class="hide">
        <div class="card">
          <h3>üë©‚Äçüíº Clientes (base de datos local)</h3>
          <div class="rowflex">
            <input id="clientSearch" class="grow" placeholder="Buscar por tel√©fono o nombre..."/>
            <button class="btn" id="btnClientRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Tel√©fono es el identificador. Se guarda en tu navegador (IndexedDB).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Tel√©fono</th>
                  <th>Nombre</th>
                  <th>Direcci√≥n</th>
                  <th style="width:140px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="clientsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS VIEW -->
      <section id="view-reports" class="hide">
        <div class="card">
          <h3>üìä Reportes (Diario / Semanal / Mensual)</h3>

          <div class="rowflex">
            <button class="btn" id="btnRepDaily">Hoy</button>
            <button class="btn" id="btnRepWeekly">Semana</button>
            <button class="btn" id="btnRepMonthly">Mes</button>
          </div>
	 <div class="card" style="margin-top:12px">
  <h3 style="margin:0 0 10px 0">üïí Rango (Fecha + Hora)</h3>
  <div class="rowflex">
    <div class="field" style="min-width:180px">
      <label>Desde (fecha)</label>
      <input id="repFromDate" type="date">
    </div>
    <div class="field" style="min-width:160px">
      <label>Desde (hora)</label>
      <input id="repFromTime" type="time" value="00:00">
    </div>
    <div class="field" style="min-width:180px">
      <label>Hasta (fecha)</label>
      <input id="repToDate" type="date">
    </div>
    <div class="field" style="min-width:160px">
      <label>Hasta (hora)</label>
      <input id="repToTime" type="time" value="23:59">
    </div>
    <button class="btn primary" id="btnRepRange">Aplicar rango</button>
  </div>
  <div class="muted" style="margin-top:8px">
    Filtra ventas PAGADAS entre dos fechas/horas exactas.
  </div>
</div>

          <div class="totals" style="margin-top:12px">
            <div class="kpi">
              <div class="label">Ventas</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="kpi">
              <div class="label">Total</div>
              <div class="value" id="repTotal">Q0.00</div>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th style="width:160px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUCTS VIEW -->
      <section id="view-products" class="hide">
        <div class="grid productsGrid">
          <div class="card">
            <h3>üì¶ Lista de productos</h3>
            <div class="rowflex">
              <input id="prodSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
              <button class="btn" id="btnProdRefresh">Refrescar</button>
              <button class="btn ghost" id="btnGoProdForm">Crear / Modificar</button>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>C√≥digo</th>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Costo</th>
                    <th>Stock</th>
                    <th style="width:140px">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="productsBody"></tbody>
              </table>
            </div>
          </div>

          <div class="card" id="prodFormCard">
            <h3>üß∑ Productos (SKU / C√≥digo)</h3>
            <div class="form stack">
              <div class="field">
                <label>C√≥digo (SKU / Barras)</label>
                <input id="pCode" placeholder="Ej: 7501234567890"/>
              </div>
              <div class="field">
                <label>Nombre</label>
                <input id="pName" placeholder="Ej: Blusa rosa"/>
              </div>
              <div class="field">
                <label>Precio (Q)</label>
                <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ej: 125"/>
              </div>
              <div class="field">
                <label>Costo (Q)</label>
                <input id="pCost" type="number" min="0" step="0.01" placeholder="Ej: 80"/>
              </div>
              <div class="field">
                <label>Stock</label>
                <input id="pStock" type="number" min="0" step="1" placeholder="Ej: 10"/>
              </div>
              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveProduct">Guardar producto</button>
                  <button class="btn danger" id="btnLogoutAdmin" type="button">Cerrar sesi√≥n admin</button>
                </div>
                <div class="muted">Puedes agregar tus productos manualmente con c√≥digo, nombre, precio y stock.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- INVENTORY VIEW -->
      <section id="view-inventory" class="hide">
        <div class="card">
          <h3>üì¶ Inventarios (Stock actual)</h3>
          <div class="rowflex">
            <input id="invSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
            <button class="btn" id="btnInvRefresh">Refrescar</button>
            <button class="btn ghost" id="btnInvExportXLS" title="Exportar a Excel">üü© Excel</button>
          </div>
          <div class="muted" style="margin-top:8px">Muestra el stock actual. Se descuenta autom√°ticamente al cobrar (y tambi√©n cuando se crea un env√≠o pendiente).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Costo</th>
                  <th>Stock</th>
                </tr>
              </thead>
              <tbody id="invBody"></tbody>
            </table>
          </div>
        </div>
      </section>
<section class="view hide" id="view-kardex">
  <div class="panel">
    <h2 style="margin:0 0 10px">Kardex perpetuo</h2>
    <div class="grid2">
      <div class="field">
        <label>Buscar (c√≥digo / nombre)</label>
        <input id="kSearch" class="input" placeholder="Ej: blusa, 12345..." />
      </div>
      <div class="field">
        <label>Tipo</label>
        <select id="kType" class="input">
          <option value="">Todos</option>
          <option value="INGRESO">INGRESO</option>
          <option value="AJUSTE">AJUSTE</option>
          <option value="SALIDA">SALIDA</option>
          <option value="ENTRADA">ENTRADA</option>
        </select>
      </div>
    </div>

    <div class="panel2" style="margin-top:12px; overflow:auto">
      <table class="tbl" style="min-width:860px">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>C√≥digo</th>
            <th>Producto</th>
            <th style="text-align:right">Cantidad</th>
            <th style="text-align:right">Stock</th>
            <th>Ref</th>
            <th>Nota</th>
          </tr>
        </thead>
        <tbody id="kBody"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap">
      <button class="btn" id="btnKRefresh">Actualizar</button>
      <button class="btn danger" id="btnKClear" title="Esto borra el kardex (NO recomendado)">Borrar kardex</button>
    </div>
  </div>
</section>


      <!-- CLOSE VIEW -->
      <section id="view-close" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üßæ Cierres de ventas (m√∫ltiples por d√≠a)</h3>

            <div class="rowflex">
              <div class="field" style="min-width:220px">
                <label>Fecha</label>
                <input id="closeDate" type="date" />
              </div>
              <div class="field" style="min-width:180px">
                <label>Desde (hora)</label>
                <input id="closeFrom" type="time" value="00:00"/>
              </div>
              <div class="field" style="min-width:180px">
                <label>Hasta (hora)</label>
                <input id="closeTo" type="time" value="23:59"/>
              </div>
              <button class="btn primary" id="btnBuildClose">Generar cierre</button>
              <button class="btn ok" id="btnSaveClose">Guardar cierre</button>
            </div>

            <div class="muted" style="margin-top:10px">
              El cierre toma <b>solo ventas PAGADAS</b> dentro del rango (fecha + horas). Puedes guardar varios cierres por d√≠a.
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∞ Cuadre por forma de pago</h3>
              <div class="form">
                <div class="field">
                  <label>EFECTIVO contado (real)</label>
                  <input id="realCash" type="number" min="0" step="0.01" value="0"/>
                </div>
                <div class="field">
                  <label>TARJETA (real)</label>
                  <input id="realCard" type="number" min="0" step="0.01" value="0"/>
                </div>
                <div class="field full">
                  <label>TRANSFERENCIA (real)</label>
                  <input id="realTrans" type="number" min="0" step="0.01" value="0"/>
                </div>
              </div>
              <div class="muted" style="margin-top:8px">
                Diferencia = Real - Sistema. (positivo = sobra, negativo = falta)
              </div>
              <div class="totals">
                <div class="kpi">
                  <div class="label">Dif. EFECTIVO</div>
                  <div class="value" id="diffCash">Q0.00</div>
                </div>
                <div class="kpi">
                  <div class="label">Dif. TARJETA</div>
                  <div class="value" id="diffCard">Q0.00</div>
                </div>
              </div>
              <div class="totals">
                <div class="kpi">
                  <div class="label">Dif. TRANSFER.</div>
                  <div class="value" id="diffTrans">Q0.00</div>
                </div>
                <div class="kpi">
                  <div class="label">Dif. TOTAL</div>
                  <div class="value" id="diffTotal">Q0.00</div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Pago</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="closeHistBody"></tbody>
              </table>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üóÇÔ∏è Historial de cierres guardados (por fecha)</h3>
              <div class="rowflex">
                <button class="btn" id="btnCloseListRefresh">Refrescar</button>
              </div>
              <div style="margin-top:10px; overflow:auto">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Rango</th>
                      <th>Ventas</th>
                      <th>Total</th>
                      <th style="width:180px">Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody id="closeSavedBody"></tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:8px">
                Borrar cierre guardado requiere c√≥digo <b>363534</b>.
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üìÑ Ticket de cierre</h3>
            <div class="rowflex">
              <button class="btn" id="btnCloseCopy">Copiar texto</button>
              <button class="btn" id="btnClosePDF">PDF</button>
              <button class="btn" id="btnClosePNG">PNG</button>
              <button class="btn primary" id="btnCloseWA">WhatsApp</button>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="closeBox">
                <img class="cornerLogo" src="LOGO1.png" onerror="this.style.display='none'" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="cShop">Tienda de Ropa</b>
                    <small id="cMeta">Cierre ‚Ä¢ D√≠a</small>
                  </div>
                  <div style="text-align:right">
                    <b id="cDate">‚Äî</b>
                    <small id="cTime">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Ventas</span><span id="cSales">0</span></div>
                <div class="line"><span>Mostrador</span><span id="cMost">0</span></div>
                <div class="line"><span>Env√≠os</span><span id="cEnv">0</span></div>
                <div class="hr"></div>

                <div class="line"><span>EFECTIVO</span><span id="cCash">Q0.00</span></div>
                <div class="line"><span>TARJETA</span><span id="cCard">Q0.00</span></div>
                <div class="line"><span>TRANSFER.</span><span id="cTrans">Q0.00</span></div>
                <div class="hr"></div>

                <div class="line"><span>Subtotal</span><span id="cSub">Q0.00</span></div>
                <div class="line"><span>Descuentos</span><span id="cDisc">Q0.00</span></div>
                <div class="big"><span>Total</span><span id="cTotal">Q0.00</span></div>

                <div class="hr"></div>
                <div class="muted">Cuadre (Real - Sistema)</div>
                <div class="line"><span>Real EFECTIVO</span><span id="cRealCash">Q0.00</span></div>
                <div class="line"><span>Dif. EFECTIVO</span><span id="cDiffCash">Q0.00</span></div>
                <div class="line"><span>Real TARJETA</span><span id="cRealCard">Q0.00</span></div>
                <div class="line"><span>Dif. TARJETA</span><span id="cDiffCard">Q0.00</span></div>
                <div class="line"><span>Real TRANSFER.</span><span id="cRealTrans">Q0.00</span></div>
                <div class="line"><span>Dif. TRANSFER.</span><span id="cDiffTrans">Q0.00</span></div>
                <div class="line"><span>Dif. TOTAL</span><span id="cDiffTotal">Q0.00</span></div>

                <div class="hr"></div>
                <div class="muted">Productos vendidos</div>
                <div id="cProducts" style="margin-top:8px"></div>

                <div class="foot">Cierre generado ‚úÖ</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="hide">
        <div class="card">
          <h3>‚öôÔ∏è Ajustes</h3>

          <div class="form">
            <div class="field full">
              <label>Nombre de la tienda (sale en el recibo)</label>
              <input id="sShopName" placeholder="Ej: Boutique Karina"/>
            </div>

            
            <div class="field full">
              <label>Formas de pago (una por l√≠nea o separadas por coma)</label>
              <textarea id="sPayMethods" rows="3" placeholder="EFECTIVO&#10;TARJETA&#10;TRANSFERENCIA"></textarea>
              <div class="muted" style="margin-top:6px">Estas opciones aparecen en <b>Forma de pago</b> al vender.</div>
            </div>
<div class="field">
              <label>Auto PDF al cobrar</label>
              <select id="sAutoPDF">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field">
              <label>Auto PNG al cobrar</label>
              <select id="sAutoPNG">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field full">
              <h3 style="margin:8px 0 0 0">üìè Tama√±os (solo para ENV√çO)</h3>
              <div class="muted">Cambiar estos tama√±os requiere c√≥digo <b>363534</b>. MOSTRADOR sigue con tama√±o actual.</div>
            </div>

            <div class="field">
              <label>PNG: Ancho recibo (px)</label>
              <input id="sEnvPngWidth" type="number" min="260" step="1" placeholder="Ej: 360"/>
            </div>

            <div class="field">
              <label>PNG: Escala (1 a 4)</label>
              <input id="sEnvPngScale" type="number" min="1" max="4" step="1" placeholder="Ej: 2"/>
            </div>

            <div class="field">
              <label>PDF: Ancho papel (mm)</label>
              <input id="sEnvPdfWidth" type="number" min="50" max="120" step="1" placeholder="Ej: 80"/>
            </div>

            <div class="field">
              <label>PDF: Margen (mm)</label>
              <input id="sEnvPdfMargin" type="number" min="0" max="20" step="1" placeholder="Ej: 6"/>
            </div>

            <div class="field full">
              <button class="btn primary" id="btnSaveSettings">Guardar</button>
            </div>
          </div>

          <div class="muted" style="margin-top:10px">
            Nota: todo se guarda en tu navegador. Si cambias de PC/navegador, exporta e importa el JSON.
          </div>
        </div>
      </section>

      <input type="file" id="restoreFile" accept="application/json" class="hide"/>
      <canvas id="cnv" class="hide"></canvas>
    </main>
  </div>

  <!-- html2canvas (mejora PNG) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js">
document.addEventListener("change", function(e){
  const el = e.target;
  if(!el || el.dataset.act!=="discVal") return;
  const id = el.dataset.id;
  const it = (state.cart||[]).find(x=>String(x.id)===String(id));
  if(!it) return;
  it.discValue = Math.max(0, Number(el.value||0));
  renderCart();
});
</script>

<script>

/* ============================================================
   POS Boutique Offline (IndexedDB)
   - Mantiene dise√±o y funciones originales
   - + Inventarios en men√∫
   - + Descuentos (Q/%)
   - + Cierres m√∫ltiples por d√≠a + cuadre por forma de pago
   - + Env√≠os pendientes: PENDIENTE/PAGADO (solo PAGADO pasa a ventas)
   - + Tama√±os PNG/PDF configurables SOLO para ENV√çO (con c√≥digo 363534)
============================================================ */

const DB_NAME = "pos_boutique_offline_v1";
const DB_VER = 8; // bumped for movements+kardex // subimos versi√≥n
let db;
let appReady = false; // evita clicks antes de que IndexedDB est√© lista

// ============================================================
// Logo seguro para exportaci√≥n PNG (evita "Tainted canvas")
// - Intenta inline (DataURL) desde localStorage o LOGO1.png
// - Si no puede (por ejemplo file://), pide al usuario cargar el logo 1 vez
// ============================================================
const LOGO_DATAURL_KEY = "MB_LOGO_DATAURL_V1";

async function fileToDataURL(file){
  return await new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = ()=>reject(new Error("No se pudo leer el archivo."));
    r.readAsDataURL(file);
  });
}

async function promptLogoUpload(){
  return await new Promise((resolve)=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "image/*";
    inp.style.position = "fixed";
    inp.style.left = "-99999px";
    document.body.appendChild(inp);
    inp.addEventListener("change", async ()=>{
      try{
        const f = inp.files && inp.files[0];
        if(!f){ resolve(null); return; }
        const data = await fileToDataURL(f);
        localStorage.setItem(LOGO_DATAURL_KEY, data);
        resolve(data);
      }catch(e){
        resolve(null);
      }finally{
        inp.remove();
      }
    }, {once:true});
    inp.click();
  });
}

async function getInlineLogoDataURL(){
  let data = localStorage.getItem(LOGO_DATAURL_KEY);
  if(data) return data;

  // intento 0: si el logo YA est√° cargado en el DOM, lo convertimos a DataURL (funciona incluso en file:// en muchos navegadores)
  try{
    const img = document.getElementById("siteLogo") || document.querySelector(".cornerLogo") || document.querySelector("img[src*='LOGO']");
    if(img && img.complete && img.naturalWidth>0){
      const c = document.createElement("canvas");
      c.width = img.naturalWidth; c.height = img.naturalHeight;
      const ctx = c.getContext("2d");
      ctx.drawImage(img,0,0);
      const durl = c.toDataURL("image/png", 1.0);
      if(durl && durl.startsWith("data:image")){
        localStorage.setItem(LOGO_DATAURL_KEY, durl);
        return durl;
      }
    }
  }catch(e){ /* ignore */ }

  // intento 1: fetch LOGO1.png (funciona bien en http/https)
  try{
    if(location.protocol==="file:") throw new Error("skip file fetch");
    const _logoFile = (document.getElementById("siteLogo")?.getAttribute("src") || "LOGO1.png");
    const resp = await fetch(_logoFile, {cache:"no-store"});
    if(resp && resp.ok){
      const blob = await resp.blob();
      data = await fileToDataURL(blob);
      localStorage.setItem(LOGO_DATAURL_KEY, data);
      return data;
    }
  }catch(e){ /* ignore */ }

  // intento 2: en file:// o si fall√≥ fetch, pedimos al usuario seleccionar el logo
  return null;
}

async function ensureLogosSafe(root){
  if(!root) return;
  const siteSrc = (document.getElementById("siteLogo")?.getAttribute("src") || "LOGO1.png").trim();
  const siteFile = siteSrc.split("/").pop();
  // set crossOrigin siempre
  root.querySelectorAll("img").forEach(img=>{ try{ img.crossOrigin = "anonymous"; }catch(e){} });

  const data = await getInlineLogoDataURL();
  if(!data) return;

  root.querySelectorAll("img").forEach(img=>{
    const src = (img.getAttribute("src")||"").trim();
    if(src === siteSrc || src.endsWith('/'+siteFile) || src.includes(siteFile) || src.includes('LOGO1.png')){
      img.setAttribute("src", data);
    }
  });
}

async function ensureLogoOrAsk(node){
  if(!node) return;
  // 1) intenta sanear (DOM->DataURL / fetch->DataURL) y reemplazar
  await ensureLogosSafe(node);

  // En file:// muchos navegadores bloquean export PNG si el logo no est√° inline.
  // Pedimos el logo 1 sola vez para guardarlo como DataURL y evitar canvases 'tainted'.
  try{
    const hasInline = !!localStorage.getItem(LOGO_DATAURL_KEY);
    const prompted = localStorage.getItem("MB_LOGO_PROMPTED_V1")==="1";
    if(location.protocol==="file:" && !hasInline && !prompted){
      localStorage.setItem("MB_LOGO_PROMPTED_V1","1");
      const picked = await promptLogoUpload();
      if(picked){ await ensureLogosSafe(node); }
    }
  }catch(e){}

  // 2) espera a que carguen im√°genes
  await new Promise(r=>setTimeout(r, 60));

  // 3) si el logo sigue sin cargar, pedimos cargarlo 1 vez
  const imgs = Array.from(node.querySelectorAll("img"));
  const logoImgs = imgs.filter(img=>{
    const src = (img.getAttribute("src")||"").trim();
    const siteFile = (document.getElementById('siteLogo')?.getAttribute('src')||'LOGO1.png').split('/').pop();
    return src.includes(siteFile) || src.includes('LOGO1') || src.startsWith('data:image/');
  });

  // Si hay al menos una imagen y ninguna carg√≥, forzamos selecci√≥n
  const anyBad = logoImgs.length && logoImgs.every(img=> !(img.naturalWidth > 0));
  if(anyBad){
    const picked = await promptLogoUpload();
    if(picked){
      await ensureLogosSafe(node);
      await new Promise(r=>setTimeout(r, 60));
    }
  }
}



const state = {
  view: "pos",
  cart: [],
  selectedClient: null,
  lastReceipt: null,  // puede ser venta o env√≠o (pending/paid)
  lastClose: null,
  discount: { type:"Q", value:0 },
  settings: {
    shopName: "Tienda de Ropa",
    autoPDF:true,
    autoPNG:true,
    envPngWidth: 360,
    envPngScale: 2,
    envPdfWidthMM: 80,
    envPdfMarginMM: 6
  }
};
state.backup = {
  dirHandle: null,
  enabled: true
};
const $ = (id)=>document.getElementById(id);
// Sincroniza UI de descuentos con el estado actual
function syncDiscUI(){
  const d = state.discount || {type:"NONE", value:0};
  const typeEl = $("discType");
  const valEl  = $("discValue");
  if(typeEl) typeEl.value = d.type || "NONE";

  // Si no hay descuento, dejamos vac√≠o para que no moleste
  if(valEl){
    if(!d.type || d.type==="NONE") valEl.value = "";
    else valEl.value = String(d.value ?? 0);
    valEl.disabled = (!d.type || d.type==="NONE");
  }
}

const money = (n)=> "Q" + (Number(n||0)).toFixed(2);

// ===== DESCUENTO POR PRODUCTO (FUNCIONAL) =====
function makeLineId(){
  return "L" + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

function lineGross(it){
  return Number(it?.price||0) * Number(it?.qty||0);
}

function lineItemDiscount(it){
  const gross = lineGross(it);
  const v = Math.max(0, Number(it?.discValue||0));
  return Math.min(gross, v);
}

function lineNet(it){
  return Math.max(0, lineGross(it) - lineItemDiscount(it));
}

// ---------- Cart math + UI ----------
function calcSubtotal(){
  return (state.cart||[]).reduce((sum,it)=> sum + lineGross(it),0);
}

function calcDiscount(){
  return (state.cart||[]).reduce((sum,it)=> sum + lineItemDiscount(it),0);
}

function calcGrand(){
  return Math.max(0, calcSubtotal() - calcDiscount());
}
// -------- Compat helpers (evita errores por funciones renombradas) --------
function cartSubtotal(){ return calcSubtotal(); }
function cartDiscountAmount(){ return calcDiscount(); }
function cartTotal(){ return calcGrand(); }
// Alias usado por paneles antiguos
const idbGetAll = idbAll;

function renderCart(){
  const tbody = $("cartBody");
  if(!tbody) return;

  // Compat: asegura id y descuento por l√≠nea
  (state.cart||[]).forEach(it=>{
    if(!it.id) it.id = makeLineId();
    if(it.discValue==null) it.discValue = 0;
  });

  const cart = state.cart || [];
  if(!cart.length){
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Carrito vac√≠o</td></tr>`;
  }else{
    tbody.innerHTML = cart.map(it=>{
      const id = String(it.id);
      const qty = Number(it.qty||0);
      const price = Number(it.price||0);
      const disc = lineItemDiscount(it);
      const net  = lineNet(it);

      return `
        <tr>
          <td class="qty">
            <button class="mini" data-act="minus" data-id="${id}">‚àí</button>
            <span class="q">${qty}</span>
            <button class="mini" data-act="plus" data-id="${id}">+</button>
          </td>
          <td class="name">
            <div class="t">${escapeHtml(String(it.name||""))}</div>
            <div class="s muted">${escapeHtml(String(it.code||""))}</div>
          </td>
          <td class="price">${money(price)}</td>
          <td class="disc">
            <input type="number" class="mini"
                   min="0" step="0.01"
                   value="${Number(it.discValue||0) ? Number(it.discValue||0) : ""}"
                   placeholder="0.00"
                   data-act="discVal" data-id="${id}"
                   style="width:92px; text-align:right;" />
            <div class="muted" style="font-size:11px; text-align:right; margin-top:4px;">
              -${money(disc)}
            </div>
          </td>
          <td class="line">${money(net)}</td>
          <td class="act">
            <button class="mini danger" data-act="del" data-id="${id}">‚úï</button>
          </td>
        </tr>`;
    }).join("");
  }

  // Totales
  const subEl = $("subTotal"); if(subEl) subEl.textContent = money(calcSubtotal());
  const discEl = $("discTotal"); if(discEl) discEl.textContent = money(calcDiscount());
  const grandEl = $("grandTotal"); if(grandEl) grandEl.textContent = money(calcGrand());

  if(typeof updateReceiptPreview === "function") updateReceiptPreview();
}

// ---------- IndexedDB ----------
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;

      if(!db.objectStoreNames.contains("clients")){
        const s = db.createObjectStore("clients", { keyPath:"phone" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("products")){
        const s = db.createObjectStore("products", { keyPath:"code" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("sales")){
        const s = db.createObjectStore("sales", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
      }
      // NUEVO: shipments (env√≠os pendientes)
      if(!db.objectStoreNames.contains("shipments")){
        const s = db.createObjectStore("shipments", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("status", "status", { unique:false });
      }
      // NUEVO: closes (cierres guardados)
      if(!db.objectStoreNames.contains("closes")){
        const s = db.createObjectStore("closes", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("dateKey", "dateKey", { unique:false });
      }

      
      // NUEVO: movements (kardex perpetuo)
      if(!db.objectStoreNames.contains("movements")){
        const s = db.createObjectStore("movements", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("code", "code", { unique:false });
      }

if(!db.objectStoreNames.contains("meta")){
        db.createObjectStore("meta", { keyPath:"key" });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}

function tx(store, mode="readonly"){
  if(!db){
    throw new Error("DB no est√° lista todav√≠a (db undefined). Recarga la p√°gina y espera 1-2 segundos.");
  }
  return db.transaction(store, mode).objectStore(store);
}
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store).get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(store, val){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").put(val);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbDel(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").delete(key);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbAll(store){
  return new Promise((res,rej)=>{
    const r = tx(store).getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbClearAll(){
  return Promise.all([
    new Promise((res,rej)=>{ const r=db.transaction("clients","readwrite").objectStore("clients").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("products","readwrite").objectStore("products").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("sales","readwrite").objectStore("sales").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("shipments","readwrite").objectStore("shipments").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("closes","readwrite").objectStore("closes").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("meta","readwrite").objectStore("meta").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
  ]);
}


// ---------- Movements (Kardex) ----------
function mkMoveId(){
  return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
}
async function logMovement(mv){
  // mv: {type, code, name, qty, stockAfter, refType, refId, note}
  const row = {
    id: mkMoveId(),
    ts: Date.now(),
    type: mv.type || "MOV",
    code: mv.code || "",
    name: mv.name || "",
    qty: Number(mv.qty||0),
    stockAfter: (mv.stockAfter===undefined? null : Number(mv.stockAfter)),
    refType: mv.refType || "",
    refId: mv.refId || "",
    note: mv.note || ""
  };
  await idbPut("movements", row);
}
async function getShiftStartTs(){
  const m = await idbGet("meta","shiftStartTs");
  return m?.value ? Number(m.value) : null;
}

async function setShiftStartTs(ts){
  await idbPut("meta", { key:"shiftStartTs", value: Number(ts||Date.now()) });
}

// ===== √öLTIMO CIERRE (para cierres m√∫ltiples por d√≠a) =====
async function getLastCloseTs(dateKey){
  const m = await idbGet("meta", "lastCloseTs_" + (dateKey||todayKey()));
  return m?.value ? Number(m.value) : null;
}
async function setLastCloseTs(dateKey, ts){
  await idbPut("meta", { key: "lastCloseTs_" + (dateKey||todayKey()), value: Number(ts||Date.now()) });
}

async function clearPaidShipments(){
  const all = await idbAll("shipments");
  const paid = all.filter(s => (s.status||"PENDIENTE")==="PAGADO" && (s.saleId || s.paidAt));
  for(const s of paid){
    await idbDel("shipments", s.id);
  }
  return true;
}
async function clearAllShipments(){
  // borra SOLO shipments
  return new Promise((res, rej)=>{
    const r = db.transaction("shipments","readwrite").objectStore("shipments").clear();
    r.onsuccess = ()=>res(true);
    r.onerror = ()=>rej(r.error);
  });
}
function toLocalTs(dateStr, timeStr){
  const d = String(dateStr||"").trim();
  const t = String(timeStr||"00:00").trim();
  if(!d) return null;
  // "YYYY-MM-DDTHH:MM" en local
  const dt = new Date(`${d}T${t}:00`);
  const ts = dt.getTime();
  return Number.isFinite(ts) ? ts : null;
}

async function renderReportRange(){
  const all = await idbAll("sales");

  const fd = $("repFromDate")?.value || todayKey();
  const ft = $("repFromTime")?.value || "00:00";
  const td = $("repToDate")?.value || fd;
  const tt = $("repToTime")?.value || "23:59";

  const a = toLocalTs(fd, ft);
  const b = toLocalTs(td, tt);
  if(a===null || b===null) return alert("Rango inv√°lido. Revisa fechas/horas.");

  const start = Math.min(a,b);
  const end   = Math.max(a,b);

  const list = all.filter(s => {
    const ts = Number(s.ts||0);
    return ts >= start && ts <= end;
  });

  const total = list.reduce((sum,s)=> sum + Number(s.total||0), 0);
  $("repCount").textContent = list.length;
  $("repTotal").textContent = money(total);

  const tb = $("salesBody");
  tb.innerHTML = "";
  for(const s of list.sort((x,y)=>Number(y.ts||0)-Number(x.ts||0))){
    const when = new Date(s.ts).toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total)}</td>
      <td>
        <button class="btn small" data-viewsale="${escapeHtml(s.id)}">Ver</button>
        <button class="btn danger small" data-delsale="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}



// ---------- Helpers ----------
function todayKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function weekKey(ts=Date.now()){
  const d = new Date(ts);
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = tmp.getUTCDay() || 7;
  tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
  return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}
function monthKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normKey(s){
  return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
}
function pad(n,len=6){ return String(n).padStart(len,"0"); }
function timeToMinutes(hhmm){
  const [h,m] = String(hhmm||"00:00").split(":").map(x=>Number(x||0));
  return (h*60)+(m||0);
}
function isWithinDateRange(ts, dateKey, fromHHMM, toHHMM){
  const d = new Date(ts);
  const dk = todayKey(ts);
  if(dk !== dateKey) return false;
  const mins = d.getHours()*60 + d.getMinutes();
  const a = timeToMinutes(fromHHMM);
  const b = timeToMinutes(toHHMM);
  // rango normal (no cruzando medianoche)
  return mins >= a && mins <= b;
}
async function clearStore(store){
  return new Promise((res, rej)=>{
    const tx = db.transaction(store, "readwrite");
    const os = tx.objectStore(store);
    const r = os.clear();

    r.onsuccess = () => res(true);
    r.onerror   = () => rej(r.error);
  });
}

// ---------- UI Nav ----------
const views = {
  pos: {title:"Registro de Ventas)", sub:""},
  shipments: {title:"Env√≠os pendientes", sub:"Gesti√≥n de env√≠os: PENDIENTE/PAGADO."},
  kardex: {title:"Kardex", sub:"Movimientos perpetuos de inventario (entradas y salidas)."},
  clients: {title:"Clientes", sub:"Busca por tel√©fono, edita y usa para env√≠os."},
  reports: {title:"Reportes", sub:"Diario / Semanal / Mensual con historial de ventas (solo pagadas)."},
  products: {title:"Productos", sub:"Agrega productos con c√≥digo, nombre, precio y stock."},
  inventory: {title:"Inventarios", sub:"Tabla de productos + stock actual."},
  close: {title:"Cierres", sub:"Cierres m√∫ltiples + cuadre por forma de pago."},
  settings: {title:"Ajustes", sub:"Nombre de tienda, tama√±os ENV√çO y respaldos (exportar/importar)."}
};


async function renderReports(){
  // Wrapper requerido por setView("reports"). Mantiene compatibilidad sin alterar l√≥gica existente.
  try{
    await renderReport("daily");
  }catch(err){
    console.error("renderReports failed:", err);
  }
}


function setView(v){
  // Robust: evita crasheos si llega un data-view inexistente
  if(!v || !views[v]){
    console.warn("Vista desconocida:", v);
    return;
  }

  state.view = v;


  // üî• Nav: resaltar el bot√≥n activo
  try{
    document.querySelectorAll("#nav button[data-view]").forEach(b=>{
      b.classList.toggle("active", b.dataset.view===v);
    });
  }catch(e){}

  const tEl = $("viewTitle");
  const sEl = $("viewSub");
  if(tEl) tEl.textContent = views[v].title || "";
  if(sEl) sEl.textContent = views[v].sub || "";

  // Mostrar/ocultar vistas solo si existen en el DOM
  for(const k in views){
    const el = $("view-"+k);
    if(el) el.classList.toggle("hide", k !== v);
  }

  // Acciones al entrar en ciertas vistas
  if(v==="kardex"){ renderKardex(); }
  if(v==="shipments"){ renderShipments(); }
  if(v==="products"){ renderProducts(); }
  if(v==="clients"){ renderClients(); }
  if(v==="inventory"){ renderInventory(); }

  // ‚úÖ AQU√ç el cambio
  if(v==="reports"){
    const t = todayKey();

    if($("repFromDate")) $("repFromDate").value = t;
    if($("repToDate"))   $("repToDate").value   = t;

    if($("repFromTime")) $("repFromTime").value = "00:00";
    if($("repToTime"))   $("repToTime").value   = "23:59";

    renderReports();
  }

  if(v==="close"){ renderClosePanel(); }

  // POS Totales
  if(v==="pos"){
    const subtotal = calcSubtotal();
    const disc = calcDiscount();
    const total = Math.max(0, subtotal - disc);

    const st = $("subTotal");
    const dt = $("discTotal");
    const gt = $("grandTotal");
    if(st) st.textContent = money(subtotal);
    if(dt) dt.textContent = money(disc);
    if(gt) gt.textContent = money(total);

    updateReceiptPreview();
  }
}

function cartAdd(product, qty=1){
  qty = Number(qty||1);
  if(qty<1) qty=1;

  state.cart.push({
    id: makeLineId(),
    code: product.code,
    name: product.name,
    price: Number(product.price||0),
    qty: qty,
    discValue: 0
  });

  renderCart();
}

function cartInc(lineId, delta){
  const it = state.cart.find(x=>String(x.id)===String(lineId));
  if(!it) return;
  it.qty += delta;
  if(it.qty<=0) state.cart = state.cart.filter(x=>String(x.id)!==String(lineId));
  renderCart();
}

function cartClear(){
  state.cart = [];
  renderCart();
}

// ---------- Clients ----------
async function findClientByPhone(phone){
  phone = String(phone||"").trim();
  if(!phone) return null;
  return await idbGet("clients", phone);
}

async function saveClientFromForm(){
  const phone = $("cPhone").value.trim();
  const names = $("cNames").value.trim();
  const last  = $("cLast").value.trim();
  const nit   = ($("cNit")?.value || "").trim();
  const addr  = $("cAddr").value.trim();
  const indic = $("cIndic").value.trim();

  if(!phone) return alert("Ingrese tel√©fono.");
  if(!names || !last || !addr) return alert("Complete Nombres, Apellidos y Direcci√≥n.");

  const client = {
    phone,
    names, last, nit, addr, indic,
    nameKey: normKey(names+" "+last),
    updatedAt: Date.now()
  };
  await idbPut("clients", client);
  state.selectedClient = client;
  showOkModal("Registro exitoso","Registro guardado.", {enter:true});;
  await refreshKPIs();
  if(state.view==="clients") renderClients();
  updateReceiptPreview();
}

async function renderClients(){
  const q = normKey($("clientSearch").value);
  const all = await idbAll("clients");
  const list = q ? all.filter(c => normKey(c.phone).includes(q) || (c.nameKey||"").includes(q) || normKey(c.addr).includes(q)) : all;

  const tb = $("clientsBody");
  tb.innerHTML = "";
  for(const c of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(c.phone)}</td>
      <td>${escapeHtml(c.names)} ${escapeHtml(c.last)}</td>
      <td><small>${escapeHtml(c.addr)}</small></td>
      <td>
        <button class="btn small" data-useclient="${escapeHtml(c.phone)}">Usar</button>
        <button class="btn danger small" data-delclient="${escapeHtml(c.phone)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Products ----------
async function saveProductFromForm(){
  const code = $("pCode").value.trim();
  const name = $("pName").value.trim();
  const price = Number($("pPrice").value);
  const cost = Number($("pCost").value);
  const stock = Number($("pStock").value);

  if(!code) return alert("Ingrese C√≥digo (SKU/barras).");
  if(!name) return alert("Ingrese Nombre.");
  if(isNaN(price) || price<0) return alert("Precio inv√°lido.");
  if(isNaN(cost) || cost<0) return alert("Costo inv√°lido.");
  if(isNaN(stock) || stock<0) return alert("Stock inv√°lido.");

  const exists = await idbGet("products", code);
  if(exists){
    if(!requireCode("editar producto")) return;
  }

  const product = {
    code, name,
    price, cost, stock,
    nameKey: normKey(name),
    updatedAt: Date.now()
  };
  await idbPut("products", product);
  // Kardex: registra cambio de stock (ingreso/ajuste)
  {
    const prev = exists ? Number(exists.stock||0) : 0;
    const delta = Number(stock) - prev;
    if(delta !== 0){
      await logMovement({
        type: (delta>0 ? "INGRESO" : "AJUSTE"),
        code, name,
        qty: delta,
        stockAfter: stock,
        refType: "PRODUCTO",
        refId: code,
        note: exists ? "Edici√≥n de stock" : "Alta de producto"
      });
    }
  }
  showOkModal("Registro exitoso","Producto guardado.", {enter:true});;
  $("pCode").value=""; $("pName").value=""; $("pPrice").value=""; $("pStock").value="";
  await refreshKPIs();
  renderProducts();
  refreshProductPicker();
}

async function getProductByCode(code){
  return await idbGet("products", code);
}

async function renderProducts(){
  const q = normKey($("prodSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("productsBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${money(p.cost||0)}</td>
      <td>${Number(p.stock||0)}</td>
      <td>
        <button class="btn small" data-fillprod="${escapeHtml(p.code)}">Editar</button>
        <button class="btn danger small" data-delprod="${escapeHtml(p.code)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function refreshProductPicker(){
  const q = normKey($("productSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p=> (p.nameKey||"").includes(q) || normKey(p.code).includes(q)) : all;

  const sel = $("productPicker");
  sel.innerHTML = "";
  if(list.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay productos (agrega en Productos)";
    sel.appendChild(opt);
    return;
  }
  for(const p of list.slice(0,300)){
    const opt = document.createElement("option");
    opt.value = p.code;
    opt.textContent = `${p.name} ‚Äî ${p.code} ‚Äî ${money(p.price)} ‚Äî Stock:${p.stock}`;
    sel.appendChild(opt);
  }
}

// ---------- Inventory ----------
async function renderInventory(){
  const q = normKey($("invSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("invBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${money(p.cost||0)}</td>
      <td>${Number(p.stock||0)}</td>
    `;
    tb.appendChild(tr);
  }
}


// ---------- Kardex UI ----------

function exportInventoryExcel(){
  // Exporta a Excel (HTML .xls) con tabla formateada (no CSV)
  idbAll("products").then((products)=>{
    const rows = (products || []).slice().sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""));
    const now = new Date();
    const title = `Inventario (Stock actual) - ${now.toLocaleString()}`;

    const header = `
      <html><head><meta charset="utf-8">
      <style>
        body{font-family:Arial, sans-serif;}
        h2{margin:0 0 10px 0;}
        table{border-collapse:collapse; width:100%;}
        th,td{border:1px solid #333; padding:8px; font-size:12px;}
        th{background:#e6f4ea; font-weight:700;}
        .num{text-align:right;}
        .muted{color:#555; font-size:11px; margin:6px 0 12px;}
      </style></head><body>
      <h2>${escapeHtml(title)}</h2>
      <div class="muted">Exportado desde MTR ONLINE AP</div>
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th class="num">Precio (Q)</th>
            <th class="num">Costo (Q)</th>
            <th class="num">Stock</th>
          </tr>
        </thead>
        <tbody>
    `;

    const body = rows.map(p=>{
      const code = escapeHtml(p.code||"");
      const name = escapeHtml(p.name||"");
      const price = Number(p.price||0).toFixed(2);
      const cost = Number(p.cost||0).toFixed(2);
      const stock = Number(p.stock||0);
      return `<tr>
        <td>${code}</td>
        <td>${name}</td>
        <td class="num">${price}</td>
        <td class="num">${cost}</td>
        <td class="num">${stock}</td>
      </tr>`;
    }).join("");

    const footer = `
        </tbody>
      </table>
      
<!-- Modal: Crear producto (desde Generador) -->
<div class="ok-modal" id="genProdOverlayMB" aria-hidden="true" style="display:none">
  <div class="ok-modal-card" role="dialog" aria-modal="true" aria-labelledby="genProdTitleMB" style="max-width:520px">
    <div class="ok-modal-head">
      <div class="ok-modal-title" id="genProdTitleMB">‚ûï Crear producto</div>
      <button class="btn mb-modal-x" type="button" onclick="closeGenProdModalMB()">‚úï</button>
    </div>
    <div class="ok-modal-body">
      <div class="form stack">
        <div class="field">
          <label>C√≥digo / SKU</label>
          <input id="mbNewPCode" placeholder="Ej: 7501234567890"/>
        </div>
        <div class="field">
          <label>Nombre</label>
          <input id="mbNewPName" placeholder="Ej: Camisa Oxford"/>
        </div>
        <div class="row" style="gap:10px">
          <div class="field grow">
            <label>Precio (Q)</label>
            <input id="mbNewPPrice" inputmode="decimal" placeholder="129.00"/>
          </div>
          <div class="field grow">
            <label>Costo (Q)</label>
            <input id="mbNewPCost" inputmode="decimal" placeholder="80.00"/>
          </div>
        </div>
        <div class="field">
          <label>Stock</label>
          <input id="mbNewPStock" inputmode="numeric" placeholder="0"/>
        </div>
      </div>
    </div>
    <div class="ok-modal-foot">
      <button class="btn primary" type="button" onclick="saveGenProductMB()">Guardar en inventario</button>
      <button class="btn" type="button" onclick="closeGenProdModalMB()">Cancelar</button>
    </div>
  </div>
</div>

</body></html>
    `;

    const html = header + body + footer;

    const blob = new Blob([html], {type:"application/vnd.ms-excel;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    a.download = `inventario_${y}-${m}-${d}.xls`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
  }).catch((e)=>{
    console.warn(e);
    alert("No se pudo exportar el inventario.");
  });
}

async function renderKardex(){
  const q = ($("kSearch")?.value || "").trim().toLowerCase();
  const t = ($("kType")?.value || "").trim();

  let rows = await idbGetAll("movements");
  rows.sort((a,b)=>(b.ts||0)-(a.ts||0));

  if(t) rows = rows.filter(r=>String(r.type||"")===t);
  if(q){
    rows = rows.filter(r=>{
      const code = String(r.code||"").toLowerCase();
      const name = String(r.name||"").toLowerCase();
      const note = String(r.note||"").toLowerCase();
      return code.includes(q) || name.includes(q) || note.includes(q);
    });
  }

  const body = $("kBody");
  if(!body) return;
  body.innerHTML = rows.map(r=>{
    const dt = new Date(r.ts||0);
    const f = dt.toLocaleString("es-GT");
    const qty = Number(r.qty||0);
    const qtyTxt = (qty>0? `+${qty}` : String(qty));
    const stockTxt = (r.stockAfter===null || r.stockAfter===undefined) ? "" : String(r.stockAfter);
    const ref = [r.refType, r.refId].filter(Boolean).join(": ");
    return `
      <tr>
        <td>${escapeHtml(f)}</td>
        <td><b>${escapeHtml(String(r.type||""))}</b></td>
        <td>${escapeHtml(String(r.code||""))}</td>
        <td>${escapeHtml(String(r.name||""))}</td>
        <td style="text-align:right">${escapeHtml(qtyTxt)}</td>
        <td style="text-align:right">${escapeHtml(stockTxt)}</td>
        <td>${escapeHtml(ref)}</td>
        <td>${escapeHtml(String(r.note||""))}</td>
      </tr>
    `;
  }).join("");
}

async function clearKardex(){
  if(!confirm("¬øSeguro? Esto borrar√° TODOS los movimientos del kardex.")) return;
  await clearStore("movements");
  await renderKardex();
}



// ---------- Sales / Shipments / Checkout ----------
async function nextReceiptNo(){
  const meta = await idbGet("meta","receiptNo");
  const n = meta?.value ? Number(meta.value) : 1;
  await idbPut("meta",{key:"receiptNo", value:n+1});
  return n;
}

function requireClientIfShipping(){
  const type = $("saleType").value;
  if(type==="ENVIO"){
    const c = state.selectedClient;
    if(!c || !c.phone || !c.names || !c.last || !c.addr){
      return {ok:false, msg:"En ENV√çO es obligatorio seleccionar/crear un cliente con tel√©fono, nombre y direcci√≥n."};
    }
  }
  return {ok:true};
}

async function validateStockForCart(){
  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    if(!p) return {ok:false, msg:"Producto no existe: " + it.code};
    if(Number(p.stock||0) < it.qty) return {ok:false, msg:`Stock insuficiente para "${p.name}". Stock:${p.stock} Cant:${it.qty}`};
  }
  return {ok:true};
}

async function deductStockForCart(refType="VENTA", refId="", note=""){
  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    p.stock = Number(p.stock||0) - it.qty;
    p.updatedAt = Date.now();
    await idbPut("products", p);
    // Kardex: salida por venta/env√≠o
    await logMovement({
      type: "SALIDA",
      code: it.code,
      name: p.name || it.name || "",
      qty: -Number(it.qty||0),
      stockAfter: p.stock,
      refType: refType,
      refId: refId,
      note: note || (refType==="ENVIO" ? "Env√≠o" : "Venta")
    });
  }
}

async function restoreStockForItems(items, refType="", refId="", note=""){
  for(const it of (items||[])){
    const p = await getProductByCode(it.code);
    if(!p) continue;
    p.stock = Number(p.stock||0) + Number(it.qty||0);
    p.updatedAt = Date.now();
    await idbPut("products", p);
    // Kardex: entrada por devoluci√≥n/anulaci√≥n
    await logMovement({
      type: "ENTRADA",
      code: it.code,
      name: p.name || it.name || "",
      qty: Number(it.qty||0),
      stockAfter: p.stock,
      refType: refType,
      refId: refId,
      note: note || "Restock"
    });
  }
}


function playSaleTone(){
  try{
    const a = document.getElementById('saleTone');
    if(!a) return;
    a.currentTime = 0;
    const p = a.play();
    if(p && typeof p.catch === 'function') p.catch(()=>{});
  }catch(e){}
}

async function checkout(){
  if(state._checkoutBusy) return;
  state._checkoutBusy = true;
  try{
  if(state.cart.length===0) return alert("No hay productos en la venta.");
  const clientRule = requireClientIfShipping();
  if(!clientRule.ok) return alert(clientRule.msg);

  const saleType = $("saleType").value;
  let payMethod = $("payMethod").value;
  let paySplit = null;
  if(payMethod==="MIXTO"){
    const subtotalTmp = cartSubtotal();
    const discountAmountTmp = cartDiscountAmount(subtotalTmp);
    const totalTmp = Math.max(subtotalTmp - discountAmountTmp, 0);

    const cash = Number($("mixCash")?.value || 0);
    const card = Number($("mixCard")?.value || 0);
    if(!isFinite(cash) || cash<0) return alert("Efectivo inv√°lido.");
    if(!isFinite(card) || card<0) return alert("Tarjeta inv√°lida.");

    const sum = Number((cash + card).toFixed(2));
    const tot = Number(totalTmp.toFixed(2));
    if(Math.abs(sum - tot) > 0.01){
      return alert("Pago mixto: la suma de Efectivo + Tarjeta debe ser igual al total.");
    }
    paySplit = { EFECTIVO: Number(cash.toFixed(2)), TARJETA: Number(card.toFixed(2)) };
  }

  // WhatsApp auto (si hay tel√©fono). Abrimos una pesta√±a en blanco YA (para evitar bloqueos por popups en async).
  const _waPhonePre = normalizePhoneForWA(state.selectedClient?.phone || $("cPhone")?.value || "");
  let _waWin = null;
  if(_waPhonePre){
    try{ _waWin = window.open("about:blank", "_blank"); }catch(e){ _waWin = null; }
  }

  const subtotal = cartSubtotal();
  const discountAmount = cartDiscountAmount(subtotal);
  const total = Math.max(subtotal - discountAmount, 0);

  const ts = Date.now();
  const id = "S-" + ts + "-" + Math.random().toString(16).slice(2,8);
  const receiptNo = await nextReceiptNo();

  // Validar stock siempre (MOSTRADOR y ENV√çO)
  const st = await validateStockForCart();
  if(!st.ok) return alert(st.msg);

  // Opci√≥n A: ENVI√ì descuenta stock al crear el env√≠o pendiente (lo que t√∫ elegiste).
  await deductStockForCart(saleType, receiptNo, "Venta");

  const client = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);

  if(saleType === "ENVIO"){
    // Crear ENV√çO pendiente (no entra a ventas/reporte/cierre hasta que se marque PAGADO)
    const shipment = {
      id: "E-" + ts + "-" + Math.random().toString(16).slice(2,8),
      ts,
      dateKey: todayKey(ts),
      weekKey: weekKey(ts),
      monthKey: monthKey(ts),
      saleType, payMethod,
    paySplit,
      status: "PENDIENTE",
      client: client ? { phone:client.phone, names:client.names, last:client.last, nit:(client.nit||""), addr:client.addr, indic:client.indic } : null,
      items: state.cart.map(x=>({...x})),
      subtotal: Number(subtotal.toFixed(2)),
      discountType: state.discount.type,
      discountValue: Number(state.discount.value||0),
      discountAmount: Number(discountAmount.toFixed(2)),
      total: Number(total.toFixed(2)),
      receiptNo: pad(receiptNo, 6),
      shop: state.settings.shopName || "Tienda de Ropa",
      stockDeducted: true,
      paidAt: null,
      saleId: null
    };

    await idbPut("shipments", shipment);
    state.lastReceipt = shipment;

    // ‚úÖ ENV√çO: dispara acciones autom√°ticas dentro del click (evita bloqueos del navegador)
    try{
      // Pre-abrir WhatsApp en blanco (mantiene gesto del usuario)
      const __ph = getClientPhoneFromReceipt(shipment);
      if(__ph){
        _waWin = _waWin || window.open("about:blank","_blank");
      }
      // Lanzar descarga sin await para no perder gesto del usuario
      if(state.settings.autoPNG){
        try{
          // üî• asegurar que el ticket est√© actualizado antes de capturar PNG
          if(typeof updateReceiptPreview === "function"){
            try{ updateReceiptPreview(); }catch(e){}
          }
          // peque√±o delay para que el DOM pinte (evita PNG vac√≠o / bloqueado)
          setTimeout(()=>{
            try{ downloadReceiptPNG(); }catch(e){}
          }, 80);
        }catch(e){}
      }else if(state.settings.autoPDF){
        try{ generatePDF(); }catch(e){}
      }
      // Enviar a WhatsApp (si hay tel√©fono)
      if(__ph){
        const __url = "https://wa.me/" + __ph + "?text=" + encodeURIComponent(saleToReceiptText(shipment));
        if(_waWin) _waWin.location.href = __url;
        else { const w = window.open(__url, "_blank"); if(!w) window.location.href = __url; }
      }
    }catch(e){}


 await autoBackupToFolder("envio_pendiente");

    // reset carrito + descuento
    state.discount = {type:"NONE", value:0};
    syncDiscUI();
    cartClear();

    // limpiar UI + KPIs
    await refreshKPIs();
    refreshProductPicker();
    if(state.view==="inventory") renderInventory();
    updateReceiptPreview();
    if(state.view==="shipments") renderShipments();

    showOkModal("Registro exitoso","", {enter:true});
    return;
  }

  // MOSTRADOR: s√≠ es venta directa
  const sale = {
    id, ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType, payMethod,
    client: client ? { phone:client.phone, names:client.names, last:client.last, nit:(client.nit||""), addr:client.addr } : null,
    items: state.cart.map(x=>({...x})),
    subtotal: Number(subtotal.toFixed(2)),
    discountType: state.discount.type,
    discountValue: Number(state.discount.value||0),
    discountAmount: Number(discountAmount.toFixed(2)),
    total: Number(total.toFixed(2)),
    receiptNo: pad(receiptNo, 6),
    shop: state.settings.shopName || "Tienda de Ropa",
    source: "DIRECT"
  };

  await idbPut("sales", sale);
  state.lastReceipt = sale;
  await autoBackupToFolder("venta");

  // reset carrito + descuento
  state.discount = {type:"NONE", value:0};
  syncDiscUI();

  cartClear();
  await refreshKPIs();
  refreshProductPicker();
  if(state.view==="inventory") renderInventory();
  updateReceiptPreview();

  // Auto descargas (solo 1 descarga autom√°tica para evitar bloqueo del navegador)
  // Para MOSTRADOR (no ENV√çO):
  // - Si autoPNG => descarga PNG
  // - Si no, pero autoPDF => descarga PDF
  if(sale.saleType !== "ENVIO"){
    if(state.settings.autoPNG){
      try{ await downloadReceiptPNG(); }catch(e){}
    }else if(state.settings.autoPDF){
      try{ generatePDF(); }catch(e){}
    }
  }


  // WhatsApp auto: si hay tel√©fono, abre chat con el recibo
  try{
    const __url = (function(){
      const txt = saleToReceiptText(sale);
      const ph = getClientPhoneFromReceipt(sale);
      return ph ? ("https://wa.me/" + ph + "?text=" + encodeURIComponent(txt)) : "";
    })();
    if(__url){
      if(_waWin) _waWin.location.href = __url;
      else { const w = window.open(__url, "_blank"); if(!w) window.location.href = __url; }
    }else if(_waWin){
      try{ _waWin.close(); }catch(e){}
    }
  }catch(e){}
playSaleTone();
  try{ sessionStorage.setItem("mt_post_reload_ok", JSON.stringify({title:"Registro exitoso", msg:"Venta registrada."})); }catch(e){}
  showCheckoutLoading("Espera un momento‚Ä¶");
  setTimeout(()=>location.reload(), 3000);
  } finally { state._checkoutBusy = false; }
}

// ---------- Shipments ----------
function shipmentClientName(s){
  return s.client ? `${s.client.names} ${s.client.last}` : "‚Äî";
}
function shipmentSearchKey(s){
  return normKey(`${s.receiptNo||""} ${s.client?.phone||""} ${shipmentClientName(s)} ${s.client?.addr||""}`);
}
async function renderShipments(){
  const q = normKey($("shipSearch").value);
  const f = $("shipFilter").value || "ALL";
  const all = await idbAll("shipments");

  let list = all;
  if(f !== "ALL") list = list.filter(s => (s.status||"PENDIENTE") === f);
  if(q) list = list.filter(s => shipmentSearchKey(s).includes(q));

  list.sort((a,b)=>b.ts-a.ts);

  const tb = $("shipBody");
  tb.innerHTML = "";

  for(const s of list){
    const d = new Date(s.ts).toLocaleString();
    const tr = document.createElement("tr");
    const status = s.status || "PENDIENTE";
    const statusHtml = status==="PAGADO"
      ? `<span style="font-weight:1000;color:#0e5b2a">‚úÖ PAGADO</span>`
      : `<span style="font-weight:1000;color:#7a4b00">‚è≥ PENDIENTE</span>`;

    tr.innerHTML = `
      <td><small>${escapeHtml(d)}</small></td>
      <td><b>#${escapeHtml(s.receiptNo||"")}</b></td>
      <td>${escapeHtml(shipmentClientName(s))}<br><small>${escapeHtml(s.client?.phone||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
      <td>${statusHtml}</td>
      <td>
        <button class="btn small" data-viewship="${escapeHtml(s.id)}">Ver</button>
        <button class="btn ok small" data-payship="${escapeHtml(s.id)}">Marcar PAGADO</button>
        <button class="btn danger small" data-delship="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function markShipmentPaid(id){
  const s = await idbGet("shipments", id);
  if(!s) return alert("Env√≠o no encontrado.");
  if((s.status||"PENDIENTE")==="PAGADO"){
    alert("Ya est√° PAGADO.");
    return;
  }

  // Crear venta desde el env√≠o (NO tocar stock, ya se descont√≥ en creaci√≥n)
  const ts = Date.now();
  const saleId = "S-" + ts + "-" + Math.random().toString(16).slice(2,8);

  const sale = {
    id: saleId,
    ts: ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType: "ENVIO",
    payMethod: s.payMethod,
    client: s.client || null,
    items: (s.items||[]).map(x=>({...x})),
    subtotal: Number((s.subtotal ?? s.total ?? 0).toFixed(2)),
    discountType: s.discountType || "NONE",
    discountValue: Number(s.discountValue||0),
    discountAmount: Number((s.discountAmount ?? 0).toFixed(2)),
    total: Number((s.total ?? 0).toFixed(2)),
    receiptNo: s.receiptNo,
    shop: s.shop || state.settings.shopName || "Tienda de Ropa",
    source: "SHIPMENT",
    shipmentId: s.id,
    paidAt: ts
  };

  await idbPut("sales", sale);
await autoBackupToFolder("envio_pagado");

  // Actualizar env√≠o a PAGADO (mantener, para historial)
  s.status = "PAGADO";
  s.paidAt = ts;
  s.saleId = saleId;
  await idbPut("shipments", s);

  state.lastReceipt = sale;
  await refreshKPIs();
  if(state.view==="shipments") renderShipments();
  if(state.view==="reports") renderReport("daily");
  updateReceiptPreview();
  buildClose();

  alert("Env√≠o marcado como PAGADO. Ya cuenta como venta en Reportes y Cierres.");
}

// (removido) bot√≥n pendiente eliminado


async function deleteShipment(id){
  if(!requireCode("borrar env√≠o")) return;
  const s = await idbGet("shipments", id);
  if(!s) return;
  if(!confirm("¬øBorrar env√≠o #"+(s.receiptNo||"") + "?")) return;

  // Si era pendiente (o incluso pagado), restauramos stock SOLO si fue descontado y todav√≠a est√° en shipments.
  // Nota: Si ya se vendi√≥ (saleId), normalmente NO se deber√≠a restaurar porque la venta existe. Lo protegemos:
  if(s.stockDeducted && !s.saleId){
    await restoreStockForItems(s.items||[]);
  }

  await idbDel("shipments", id);
  await refreshKPIs();
  renderShipments();
  renderInventory();
  refreshProductPicker();
  alert("Env√≠o borrado.");
}

// ---------- Reports ----------
async function renderReport(mode){
  const all = await idbAll("sales");
  const now = Date.now();
  let list = [];

  if(mode==="daily"){
    const k = todayKey(now);
    list = all.filter(s=>s.dateKey===k);
  }else if(mode==="weekly"){
    const k = weekKey(now);
    list = all.filter(s=>s.weekKey===k);
  }else{
    const k = monthKey(now);
    list = all.filter(s=>s.monthKey===k);
  }

  const total = list.reduce((a,s)=>a+Number(s.total||0),0);
  $("repCount").textContent = list.length;
  $("repTotal").textContent = money(total);

  const tb = $("salesBody");
  tb.innerHTML = "";
  for(const s of list.sort((a,b)=>b.ts-a.ts)){
    const d = new Date(s.ts);
    const when = d.toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total)}</td>
      <td>
        <button class="btn small" data-viewsale="${escapeHtml(s.id)}">Ver</button>
        <button class="btn danger small" data-delsale="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Receipt (text + preview + PDF + PNG) ----------
function applyEnvReceiptSizing(saleType){
  const node = $("receiptBox");
  if(!node) return;

  // Clase para estilos ENV√çO (autoajuste / tipograf√≠a)
  node.classList.toggle("envio", saleType === "ENVIO");

  // Solo ENV√çO aplica tama√±o configurable
  if(saleType === "ENVIO"){
    const w = Number(state.settings.envPngWidth || 360);
    node.style.width = Math.max(260, Math.min(520, w)) + "px";
  }else{
    node.style.width = ""; // vuelve a CSS default
  }
}

function makeLiveReceipt(){
  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;
  const c = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);
  return {
    ts: Date.now(),
    receiptNo: state.lastReceipt?.receiptNo || String($("rNo").textContent||"").replace("#","") || "------",
    shop: state.settings.shopName,
    saleType, payMethod,
    status: (saleType==="ENVIO") ? "PENDIENTE" : "PAGADO",
    client: c ? {phone:c.phone, names:c.names, last:c.last, nit:(c.nit||""), addr:c.addr, indic:c.indic} : null,
    items: state.cart.map(x=>({...x})),
    subtotal: cartSubtotal(),
    discountAmount: cartDiscountAmount(cartSubtotal()),
    total: cartTotal()
  };
}

function saleToReceiptText(s){
  if(!s) return "No hay recibo todav√≠a.";
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone  = s.client?.phone || "‚Äî";
  const nitVal = (s.client?.nit || "").trim();
  const addr   = s.client?.addr  || "‚Äî";
  const status = s.status ? `Estatus: ${s.status}` : "";
  const lines = [];
  lines.push(`üßæ *${s.shop}*`);
  lines.push(`Recibo #${s.receiptNo}`);
  lines.push(`Fecha: ${d}`);
  if(status) lines.push(status);
  if(s.payMethod==="MIXTO" && s.paySplit){
  lines.push(`Tipo: ${s.saleType} | Pago: MIXTO (E:${money(s.paySplit.EFECTIVO||0)} + T:${money(s.paySplit.TARJETA||0)})`);
}else{
  lines.push(`Tipo: ${s.saleType} | Pago: ${s.payMethod}`);
}
  lines.push(`Cliente: ${client}`);
  lines.push(`Tel: ${phone}`);
  if(nitVal) lines.push(`NIT: ${nitVal}`);
  lines.push(`Dir: ${addr}`);
  lines.push(`--------------------------------`);
  for(const it of (s.items||[])){
    lines.push(`${it.qty} x ${it.name} = ${money(it.qty*it.price)}`);
  }
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(s.subtotal ?? s.total)}`);
  lines.push(`DESCUENTO: ${money(s.discountAmount ?? 0)}`);
  lines.push(`TOTAL: *${money(s.total)}*`);
  lines.push(`Gracias por tu compra üíó`);
  return lines.join("\n"); // <- SALTOS REALES
}

function updateReceiptPreview(){
  const s = state.lastReceipt || makeLiveReceipt();
  const saleType = s.saleType || $("saleType").value;

  applyEnvReceiptSizing(saleType);

  $("rShop").textContent = s.shop || state.settings.shopName || "Tienda de Ropa";
  $("rMeta").textContent = `Recibo ‚Ä¢ ${s.saleType || "MOSTRADOR"} ‚Ä¢ ${s.payMethod || "EFECTIVO"}`;
  $("rNo").textContent = "#" + (s.receiptNo || "------");
  $("rDate").textContent = new Date(s.ts || Date.now()).toLocaleString();

  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  $("rClient").textContent = client;
  $("rPhone").textContent = s.client?.phone || "‚Äî";
  if($("rNit")) $("rNit").textContent = s.client?.nit || "‚Äî";
  $("rAddr").textContent  = s.client?.addr || "‚Äî";
  $("rPay").textContent   = s.payMethod || $("payMethod").value;

  const badge = $("rStatusBadge");
  const status = s.status || (saleType==="ENVIO" ? "PENDIENTE" : "PAGADO");
  badge.classList.remove("hide","pending","paid");
  if(status === "PENDIENTE"){
    badge.textContent = "‚è≥ PENDIENTE";
    badge.classList.add("pending");
  }else{
    badge.textContent = "‚úÖ PAGADO";
    badge.classList.add("paid");
  }

  // Indicaciones (cliente)
  $("rIndic").textContent = s.client?.indic || "‚Äî";

  const itemsDiv = $("rItems");
  itemsDiv.innerHTML = "";

  const isEnvio = (saleType === "ENVIO");
  const pay = (s.payMethod || $("payMethod").value || "EFECTIVO");

  // En ENV√çO: NO mostramos detalle de productos.
  // - Si es EFECTIVO: mostramos SOLO el TOTAL.
  // - Si es TARJETA/TRANSFERENCIA: mostramos SOLO la forma de pago.
  if(isEnvio){
    const subLine  = $("rSubLine");
    const discLine = $("rDiscLine");
    const payLine  = $("rPayLine");
    const totLine  = $("rTotalLine");
    if(subLine) subLine.classList.add("hide");
    if(discLine) discLine.classList.add("hide");
    if(payLine) payLine.classList.add("hide");
    if(totLine) totLine.classList.add("hide");

    const line = document.createElement("div");
    line.className = "line";
    if(pay === "EFECTIVO"){
      line.innerHTML = `<span>Total</span><span>${money(s.total ?? cartTotal())}</span>`;
    }else{
      line.innerHTML = `<span>Pago</span><span>${escapeHtml(pay)}</span>`;
    }
    itemsDiv.appendChild(line);
  }else{
    // MOSTRADOR: comportamiento actual (detalle + totales)
    const subLine  = $("rSubLine");
    const discLine = $("rDiscLine");
    const payLine  = $("rPayLine");
    const totLine  = $("rTotalLine");
    if(subLine) subLine.classList.remove("hide");
    if(discLine) discLine.classList.remove("hide");
    if(payLine) payLine.classList.remove("hide");
    if(totLine) totLine.classList.remove("hide");

    for(const it of (s.items||[])){
      const line = document.createElement("div");
      line.className="line";
      {
      const gross = Number(it.qty||0)*Number(it.price||0);
      const disc = Math.min(gross, Math.max(0, Number(it.discValue||0)));
      const net = Math.max(0, gross - disc);

      line.innerHTML = `<span>${it.qty} x ${escapeHtml(it.name)}</span><span>${money(net)}</span>`;
      itemsDiv.appendChild(line);

      // üÜï mostrar descuento por producto si existe
      if(disc>0){
        const dline = document.createElement("div");
        dline.className = "line muted";
        dline.innerHTML = `<span>Descuento</span><span>-${money(disc)}</span>`;
        itemsDiv.appendChild(dline);
      }
      continue;
    }
}

    $("rSub").textContent = money(s.subtotal ?? cartSubtotal());
    $("rDisc").textContent = money(s.discountAmount ?? cartDiscountAmount(s.subtotal ?? cartSubtotal()));
    $("rTotal").textContent = money(s.total ?? cartTotal());
  }
  // Asegura logo visible tambi√©n en MOSTRADOR (usa DataURL si ya se carg√≥)
  try{ ensureLogosSafe($("receiptBox")); }catch(e){}
}

function handlePayMethodUI(){
  const pm = $("payMethod")?.value || "EFECTIVO";
  const wrap = $("mixPayWrap");
  if(!wrap) return;
  if(pm==="MIXTO"){
    wrap.style.display = "";
    // Autocompletar tarjeta con el restante
    const subtotal = cartSubtotal();
    const disc = cartDiscountAmount(subtotal);
    const total = Math.max(subtotal - disc, 0);
    const cash = Number($("mixCash")?.value || 0);
    const card = Math.max(0, Number((total - cash).toFixed(2)));
    if($("mixCard")) $("mixCard").value = isFinite(card) ? card : 0;
  }else{
    wrap.style.display = "none";
  }
}


async function copyReceipt(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  try{
    await navigator.clipboard.writeText(text);
    alert("Recibo copiado. P√©galo en WhatsApp.");
  }catch{
    alert("No se pudo copiar autom√°ticamente. Intenta copiar manualmente desde WhatsApp.");
  }
}

function normalizePhoneForWA(phone){
  const raw = String(phone||"").trim();
  if(!raw) return "";
  // Deja solo d√≠gitos (WhatsApp wa.me usa solo n√∫meros)
  let d = raw.replace(/\D+/g,"");
  if(!d) return "";
  // Guatemala: si son 8 d√≠gitos, asumimos +502
  if(d.length === 8) d = "502" + d;
  // Si viene con 00 prefix (ej. 00502...), lo normalizamos
  if(d.startsWith("00")) d = d.slice(2);
  return d;
}
function getClientPhoneFromReceipt(s){
  // 1) del recibo guardado 2) del draft del panel 3) del cliente seleccionado
  const a = s?.client?.phone;
  const b = $("cPhone")?.value;
  const c = state.selectedClient?.phone;
  return normalizePhoneForWA(a || b || c || "");
}
function openWhatsAppForReceipt(s){
  const r = s || state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(r);
  const phone = getClientPhoneFromReceipt(r);

  // Si hay tel√©fono, abre chat directo. Si no, abre WhatsApp con el texto listo.
  const url = phone
    ? ("https://wa.me/" + phone + "?text=" + encodeURIComponent(text))
    : ("https://wa.me/?text=" + encodeURIComponent(text));

  window.open(url, "_blank");
}
function openWhatsApp(){
  openWhatsAppForReceipt(state.lastReceipt || makeLiveReceipt());
}


// --- Seguridad (c√≥digo para borrar/editar) ---
// ===== C√ìDIGO DE EDICI√ìN (solo 1 vez por sesi√≥n) =====
const EDIT_CODE = "363534";
const EDIT_OK_KEY = "mb_edit_ok_v1";

// ===== MODAL MENSAJE (OK) =====
let __okModalEnter = false;
let __okModalReload = false;

function showCheckoutLoading(msg){
  const ov = document.getElementById("checkoutLoading");
  const m = document.getElementById("checkoutLoadingMsg");
  if(m) m.textContent = String(msg || "Espera un momento.");
  if(ov){
    ov.classList.add("show");
    ov.setAttribute("aria-hidden","false");
  }
}
function hideCheckoutLoading(){
  const ov = document.getElementById("checkoutLoading");
  if(ov){
    ov.classList.remove("show");
    ov.setAttribute("aria-hidden","true");
  }
}
function postReloadOkCheck(){
  try{
    const s = sessionStorage.getItem("mt_post_reload_ok");
    if(!s) return;
    sessionStorage.removeItem("mt_post_reload_ok");
    const o = JSON.parse(s || "{}");
    setTimeout(()=>showOkModal(o.title || "Registro exitoso", o.msg || "Venta registrada.", {enter:true}), 120);
  }catch(e){}
}

function showOkModal(title, msg, opts){
  const ov = document.getElementById("okModalOverlay");
  const t = document.getElementById("okModalTitle");
  const m = document.getElementById("okModalMsg");
  const b = document.getElementById("okModalBtn");
  if(!ov || !t || !m || !b){ alert(msg || title); return; }
  t.textContent = title || "Mensaje";
  m.textContent = msg || "";
  __okModalEnter = !!(opts && opts.enter);
  __okModalReload = !!(opts && opts.reload);
  ov.classList.add("show");
  setTimeout(()=>{ try{ b.focus(); }catch(e){} }, 30);
}
function closeOkModal(){
  const ov = document.getElementById("okModalOverlay");
  if(ov) ov.classList.remove("show");
  if(__okModalReload){ try{ location.reload(); }catch(e){} }
}
// Enter para aceptar cuando el modal est√° abierto
document.addEventListener("keydown", (e)=>{
  const ov = document.getElementById("okModalOverlay");
  if(!ov || !ov.classList.contains("show")) return;
  if(e.key === "Enter"){
    e.preventDefault();
    closeOkModal();
  }
});
function showBlockedProducts(){
  showOkModal("Modificaci√≥n de productos bloqueada","", {enter:true, reload:true});
}



function requireCode(action){
  // ya autorizado en esta pesta√±a
  if(sessionStorage.getItem(EDIT_OK_KEY) === "1") return true;

  // abrir modal personalizado (sin prompt del navegador)
  openEditCodeModal(action);
  return false; // el usuario reintenta el bot√≥n despu√©s de autorizar
}


function logoutAdmin(){
  try{ sessionStorage.removeItem(EDIT_OK_KEY); }catch(e){}
  try{ closeEditCodeModal(); }catch(e){}
}

function openEditCodeModal(action){
  const ov = document.getElementById("editCodeOverlay");
  const title = document.getElementById("editCodeTitle");
  const msg = document.getElementById("editCodeMsg");
  const inp = document.getElementById("editCodeInput");

  if(!ov || !inp) return alert("No se pudo abrir el cuadro de c√≥digo.");

  title.textContent = "Acceso requerido";
  msg.textContent = `Ingrese el c√≥digo para ${action}:`;
  inp.value = "";
  ov.classList.add("show");

  setTimeout(()=>{ try{ inp.focus(); }catch(e){} }, 30);
}

function closeEditCodeModal(){
  const ov = document.getElementById("editCodeOverlay");
  if(ov) ov.classList.remove("show");
}

function confirmEditCode(){
  const inp = document.getElementById("editCodeInput");
  const err = document.getElementById("editCodeErr");
  const code = (inp && inp.value ? String(inp.value).trim() : "");
  if(code !== EDIT_CODE){
    // √∫nico mensaje permitido
    showBlockedProducts();
    return;
  }
  sessionStorage.setItem(EDIT_OK_KEY, "1");
  if(err) err.textContent = "";
  closeEditCodeModal();
  }

// Cerrar modal con ESC
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    const ov = document.getElementById("editCodeOverlay");
    if(ov && ov.classList.contains("show")) closeEditCodeModal();
  }
});


// --- Seguridad (c√≥digo para backup/restore) ---
function requireBackupCode(action){
  const code = prompt(`Ingrese el c√≥digo para ${action}:`);
  if(code===null) return false;
  if(String(code).trim() !== "22782522"){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}

// --- Captura PNG robusta (evita blanco/opaco) ---
async function capturePNG(node, filename, scaleOverride=null){
  if(!node) throw new Error("Nodo no encontrado.");
  if(!window.html2canvas) throw new Error("html2canvas no disponible.");

  document.body.classList.add("capture-mode");
  await new Promise(r=>requestAnimationFrame(r));

  const scale = scaleOverride ? Number(scaleOverride) : 2;

  // 1) Antes de capturar, intentamos "sanear" logos para evitar canvas tainted
  await ensureLogosSafe(node);

  async function doCapture(){
    const canvas = await html2canvas(node, {
      backgroundColor:"#ffffff",
      scale: Math.max(1, Math.min(4, scale)),
      useCORS: true,
      allowTaint: false,      // importante: si queda tainted, preferimos fallar y reintentar con logo inline
      logging: false,
      removeContainer: true
    });

    return await new Promise((resolve,reject)=>{
      canvas.toBlob((blob)=>{
        if(!blob) return reject(new Error("PNG bloqueado o en blanco."));
        const a = document.createElement("a");
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 3000);
        resolve(true);
      }, "image/png", 1.0);
    });
  }

  try{
    return await doCapture();
  }catch(e){
    const msg = (e && e.message) ? String(e.message) : String(e||"");
    // Error t√≠pico: "Tainted canvases may not be exported"
    if(/tainted|exported|toBlob/i.test(msg)){
      // Si no tenemos logo inline guardado, pedimos cargarlo una vez y reintentamos
      let data = localStorage.getItem(LOGO_DATAURL_KEY);
      if(!data){
        const picked = await promptLogoUpload();
        if(picked){
          await ensureLogosSafe(node);
          return await doCapture();
        }
      }else{
        await ensureLogosSafe(node);
        return await doCapture();
      }
    }
    throw e;
  }finally{
    document.body.classList.remove("capture-mode");
  }
}
// ====== LABEL 10x10 (ENV√çO) helpers ======
const ENV_LABEL_MM = 100;                 // 10cm
const ENV_LABEL_MARGIN_MM = 3;            // margen impresi√≥n (ajusta si tu impresora lo necesita)
const ENV_LABEL_PX = Math.round(ENV_LABEL_MM * 96 / 25.4); // 100mm -> ~378px (a 96dpi)

/** Construye un nodo 10x10 para ENV√çO (para PNG) */
/** Construye un nodo 10x10 para ENV√çO (para PNG) */
function buildEnvLabelNode(s){
  const wrap = document.createElement("div");
  wrap.id = "envLabelTmp";
  wrap.style.width = ENV_LABEL_PX + "px";
  wrap.style.height = ENV_LABEL_PX + "px";
  wrap.style.background = "#fff";
  wrap.style.position = "fixed";
  wrap.style.left = "-99999px";
  wrap.style.top = "0";
  wrap.style.padding = "10px";
  wrap.style.boxSizing = "border-box";
  wrap.style.border = "2px solid #000";
  wrap.style.overflow = "hidden";
  wrap.style.fontFamily = "Arial, sans-serif";
  wrap.style.color = "#000";
  wrap.style.fontWeight = "900";

  // Layout: header + contenido + footer (footer pegado abajo)
  wrap.style.display = "flex";
  wrap.style.flexDirection = "column";
  wrap.style.gap = "6px";

  // ====== DATOS ======
  const shop = (s.shop || state?.settings?.shopName || "Tienda").toString();
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const envioNo = (s.receiptNo || "----").toString();
  const status = (s.status || "PENDIENTE").toString().toUpperCase();

  const client = s.client ? `${s.client.names || ""} ${s.client.last || ""}`.trim() : "MOSTRADOR";
  const phone  = s.client?.phone || "‚Äî";
  const nit    = s.client?.nit   || "‚Äî";
  const addr   = s.client?.addr  || "‚Äî";

  // Comentario / indicaciones (varios nombres posibles)
  const indic = (s.client?.indic ?? s.client?.comment ?? s.comment ?? s.shipComment ?? "‚Äî");

  // Total / Pago
  const total = (s.total ?? s.grandTotal ?? 0);
  const pay   = (s.payMethod || s.paymentMethod || "EFECTIVO").toString().toUpperCase();
  const isCash = (pay === "EFECTIVO" || pay === "CASH");

  // Logo: preferir DataURL guardado para evitar fallos al exportar
  const logoSrc = localStorage.getItem(LOGO_DATAURL_KEY) || (document.getElementById("siteLogo")?.getAttribute("src") || "LOGO1.png");

  // ====== CABECERA (Logo + Tienda + # Env√≠o) ======
  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.alignItems = "center";
  header.style.justifyContent = "space-between";
  header.style.gap = "8px";

  const left = document.createElement("div");
  left.style.lineHeight = "1.05";
  left.innerHTML = `
    <div style="font-weight:1000;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(shop)}</div>
    <div style="font-weight:1000;font-size:14px;">ENV√çO #${escapeHtml(envioNo)}</div>
    <div style="font-weight:900;font-size:10px;color:#555;">${escapeHtml(d)}</div>
  `;

  const logo = document.createElement("img");
  logo.src = logoSrc;
  logo.alt = "LOGO";
  logo.style.height = "80px";
  logo.style.width = "80px";
  logo.style.objectFit = "contain";
  logo.style.borderRadius = "10px";
  logo.style.border = "1px solid rgba(0,0,0,.08)";
  logo.style.padding = "3px";
  logo.style.background = "#fff";
  logo.onerror = ()=>{ logo.style.display="none"; };

  header.appendChild(left);
  header.appendChild(logo);
  wrap.appendChild(header);

  // ====== CLIENTE / TEL (tel m√°s grande) ======
  const info = document.createElement("div");
  info.style.lineHeight = "1.12";
  info.innerHTML = `
    <div style="font-weight:1100;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(client)}</div>

    <div style="margin-top:4px;display:inline-block;border:2px solid #000;border-radius:14px;padding:6px 10px;font-weight:1200;font-size:24px;letter-spacing:.3px;">
      ${escapeHtml(phone)}
    </div>

    <div style="margin-top:4px;font-weight:1100;font-size:13px;">NIT: ${escapeHtml(nit)}</div>

    <div style="margin-top:4px;font-weight:1100;font-size:12px;color:#000;">
      ESTATUS: <span style="font-weight:1300;font-size:14px;">${escapeHtml(status)}</span>
    </div>
  `;
  wrap.appendChild(info);

  // ====== CONTENIDO (Direcci√≥n + Indicaciones) ======
  const content = document.createElement("div");
  content.style.flex = "1 1 auto";
  content.style.minHeight = "0";
  content.style.border = "2px solid #000";
  content.style.borderRadius = "8px";
  content.style.padding = "6px";
  content.style.boxSizing = "border-box";
  content.style.overflow = "hidden";
  content.style.lineHeight = "1.15";

  const addrEl = document.createElement("div");
  addrEl.style.fontWeight = "1000";
  addrEl.style.whiteSpace = "pre-wrap";
  addrEl.style.wordBreak = "break-word";
  addrEl.style.overflowWrap = "anywhere";
  addrEl.textContent = "Direcci√≥n: " + (addr || "‚Äî");

  const commEl = document.createElement("div");
  commEl.style.marginTop = "5px";
  commEl.style.fontWeight = "900";
  commEl.style.whiteSpace = "pre-wrap";
  commEl.style.wordBreak = "break-word";
  commEl.style.overflowWrap = "anywhere";
  commEl.textContent = "Indicaciones: " + (indic || "‚Äî");

    // Layout interno: 2 bloques con altura fija y auto-ajuste
  content.style.display = "flex";
  content.style.flexDirection = "column";
  content.style.gap = "6px";

  const addrBox = document.createElement("div");
  addrBox.style.flex = "0 0 48%";
  addrBox.style.minHeight = "0";
  addrBox.style.overflow = "hidden";
  addrBox.style.borderBottom = "2px solid #000";
  addrBox.style.paddingBottom = "4px";

  const commBox = document.createElement("div");
  commBox.style.flex = "1 1 auto";
  commBox.style.minHeight = "0";
  commBox.style.overflow = "hidden";

  addrEl.style.fontSize = "18px";
  commEl.style.fontSize = "16px";

  addrBox.appendChild(addrEl);
  commBox.appendChild(commEl);
  content.appendChild(addrBox);
  content.appendChild(commBox);
  wrap.appendChild(content);

  // Auto-ajuste: grande si cabe, peque√±o si no cabe (por campo)
  requestAnimationFrame(()=>{
    autoFitTextToBox(addrBox, addrEl, 20, 9);
    autoFitTextToBox(commBox, commEl, 18, 8);
  });

  // ====== FOOTER (pegado abajo) ======
  const payBox = document.createElement("div");
  payBox.style.marginTop = "auto";
  payBox.style.borderTop = "2px solid #000";
  payBox.style.paddingTop = "6px";
  payBox.style.lineHeight = "1.05";

  payBox.innerHTML = isCash
    ? `
      <div style="display:flex;justify-content:space-between;font-weight:1300;font-size:22px;">
        <span>TOTAL</span><span>${money(total)}</span>
      </div>
      <div style="margin-top:4px;font-weight:1200;font-size:18px;">
        <span style="opacity:.95">PAGO:</span> <span style="font-weight:1400">${escapeHtml(pay)}</span>
      </div>
    `
    : `
      <div style="display:flex;justify-content:space-between;font-weight:1300;font-size:20px;">
        <span>PAGO</span><span style="font-weight:1400">${escapeHtml(pay)}</span>
      </div>
    `;

  wrap.appendChild(payBox);

  return wrap;
}


function autoFitTextToBox(boxEl, textEl, maxPx, minPx){
  if(!boxEl || !textEl) return;
  const max = Number(maxPx||18);
  const min = Number(minPx||8);
  for(let fs=max; fs>=min; fs-=0.5){
    textEl.style.fontSize = fs + "px";
    // fuerza layout
    if(textEl.scrollHeight <= boxEl.clientHeight && textEl.scrollWidth <= boxEl.clientWidth){
      break;
    }
  }
}

function fitEnvLabelToBox(node){
  // bajamos font-size global del contenedor hasta que no desborde
  let fs = 12; // arranque
  node.style.fontSize = fs + "px";

  // intentamos hasta 6px
  for(let i=0;i<20;i++){
    // si desborda, bajamos
    if(node.scrollHeight > node.clientHeight || node.scrollWidth > node.clientWidth){
      fs -= 0.5;
      node.style.fontSize = fs + "px";
      if(fs <= 6) break;
    }else{
      break;
    }
  }
}


// PNG (preferir html2canvas; fallback SVG)
// PNG (preferir html2canvas; fallback SVG)
async function downloadReceiptPNG(){
  // Evitar doble descarga (el navegador bloquea descargas m√∫ltiples)
  const now = Date.now();
  if(state && state._dlInProgress) return;
  if(state && state._dlLock && (now - state._dlLock) < 8000) return;
  if(state){ state._dlLock = now; state._dlInProgress = true; }

  try{
  const s = state.lastReceipt || makeLiveReceipt();
  const isEnv = (s.saleType === "ENVIO");

  // ====== ENV√çO: PNG 10x10 usando label temporal ======
  if(isEnv){
    if(!window.html2canvas){
      alert("html2canvas no est√° disponible. Usa PDF.");
      return;
    }

    const node = buildEnvLabelNode(s);
    document.body.appendChild(node);
    fitEnvLabelToBox(node);
    // ensureLogoOrAsk removed to prevent browser blocking

    try{
      const scale = Number(state.settings.envPngScale || 2);
      await capturePNG(node, `envio_${(s.receiptNo||"----")}_10x10.png`, scale);
    }catch(e){
      alert("No se pudo generar PNG de ENV√çO. Intenta con PDF. " + (e?.message||""));
    }finally{
      node.remove();
    }
    return;
  }

  // ====== MOSTRADOR: PNG desde #receiptBox ======
  const node = $("receiptBox");
  if(!node) return;

  // 1) html2canvas robusto
  if(window.html2canvas){
    try{
      await capturePNG(node, `recibo_${(s.receiptNo||"----")}.png`, 2);
      return;
    }catch(e){
      // seguimos al fallback
    }
  }

  // 2) fallback SVG foreignObject
  const w = node.offsetWidth;
  const h = node.offsetHeight;

  const clone = node.cloneNode(true);
  clone.style.boxShadow="none";

  const wrapper = document.createElement("div");
  wrapper.style.width = w+"px";
  wrapper.style.height = h+"px";
  wrapper.style.background = "#fff";
  wrapper.appendChild(clone);

  const html = new XMLSerializer().serializeToString(wrapper);
  const data = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
      <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">
          ${html}
        </div>
      </foreignObject>
    </svg>
  `;
  const svgBlob = new Blob([data], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = ()=>{
    const cnv = $("cnv");
    const sc = 2;
    cnv.width = w*sc;
    cnv.height = h*sc;

    const ctx = cnv.getContext("2d");
    ctx.setTransform(sc,0,0,sc,0,0);
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,w,h);
    ctx.drawImage(img, 0,0);
    URL.revokeObjectURL(url);

    cnv.toBlob((blob)=>{
      if(!blob) return alert("Tu navegador bloque√≥ el PNG. Usa PDF o Copiar texto.");
      const a = document.createElement("a");
      const u = URL.createObjectURL(blob);
      a.href = u;
      a.download = `recibo_${(s.receiptNo||"----")}.png`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(u), 1000);
    }, "image/png");
  };
  img.onerror = ()=>{
    URL.revokeObjectURL(url);
    alert("Tu navegador bloque√≥ el PNG. Usa PDF o Copiar texto.");
  };
  img.src = url;
  }finally{
    if(state) state._dlInProgress = false;
  }
}

function receiptToPrintableHTML(s){
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const clientName = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const nit   = (s.client?.nit || "‚Äî");
  const addr  = s.client?.addr  || "‚Äî";

  const rows = (s.items||[]).map(it=>{
    const line = (it.qty||0) * (it.price||0);
    return `
      <tr>
        <td style="text-align:center">${it.qty}</td>
        <td>${escapeHtml(it.name)}</td>
        <td style="text-align:right">${money(it.price)}</td>
        <td style="text-align:right">${money(line)}</td>
      </tr>
    `;
  }).join("");

  const sub = Number(s.subtotal ?? 0);
  const disc = Number(s.discountAmount ?? 0);
  const total = Number(s.total ?? 0);
  const pay = (s.payMethod || s.paymentMethod || "EFECTIVO").toString().toUpperCase();

  const logoSrc = localStorage.getItem(LOGO_DATAURL_KEY) || (document.getElementById("siteLogo")?.getAttribute("src") || "LOGO1.png");

  const isEnv = (s.saleType === "ENVIO");

  const pageW = ENV_LABEL_MM;        // 100mm
  const pageH = ENV_LABEL_MM;        // 100mm
  const pageM = ENV_LABEL_MARGIN_MM; // 3mm

  const pageCss = isEnv
    ? `@page{ size: ${pageW}mm ${pageH}mm; margin: ${pageM}mm; }`
    : `@page{ margin: 12mm; }`;

  const boxWidth = isEnv
    ? `max-width: ${Math.max(50, Math.min(120, pageW))}mm;`
    : `max-width: 820px;`;

  // Para ENV√çO, forzamos una altura real (√°rea imprimible) para que el "fit" funcione y no se corte.
  const boxExtra = isEnv
    ? `height: ${Math.max(10, (pageH - (pageM*2)))}mm; display:flex; flex-direction:column;`
    : ``;

  const statusLine = s.status
    ? `<div class="meta" style="margin-top:6px;color:#111;font-weight:1000;font-size:14px">Estatus: ${escapeHtml(s.status)}</div>`
    : ``;

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Recibo ${escapeHtml(s.receiptNo || "")}</title>

    <style>
      ${pageCss}
      body{ font-family: Arial, sans-serif; margin: 0; color:#111; background:#fff7fb; }
      .box{ position:relative; ${boxWidth} ${boxExtra} margin: 0 auto; border:2px solid #fbcfe8; border-radius:16px; padding:16px; background:#fff; box-sizing:border-box; overflow:hidden; }
      .cornerLogo{ position:absolute; top:12px; right:12px; width:60px; height:60px; object-fit:contain; border-radius:14px; border:1px solid #eee; padding:4px; background:#fff; }
      .bar{ height:8px; border-radius:999px; background: linear-gradient(90deg, #ff4fb7, #a855f7); margin-bottom:12px; }
      h1{ margin:0; font-size:18px; color:#7b2fb4; padding-right:70px; }
      .meta{ margin-top:4px; color:#444; font-size:12px; font-weight:700; }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
      .card{ border:1px solid #eee; border-radius:12px; padding:12px; }
      .label{ color:#666; font-size:12px; font-weight:700; }
      .val{ font-size:13px; font-weight:900; margin-top:3px; white-space:pre-wrap; word-break:break-word; }
      .fitField{ height:64px; overflow:hidden; }
      table{ width:100%; border-collapse:collapse; margin-top:14px; }
      th,td{ border-bottom:1px solid #eee; padding:8px; font-size:13px; }
      th{ background:#ffe4f1; text-align:left; }
      .totalRow{ display:flex; justify-content:space-between; margin-top:10px; font-weight:1200; font-size:16px; }
      .box .footer .totalRow{ font-size:20px; }
      .foot{ margin-top:12px; color:#444; font-size:12px; font-weight:700; }
      .content{ flex:1 1 auto; min-height:0; }
      .footer{ margin-top:auto; }
      .phoneBig{ display:inline-block; font-size:24px; font-weight:1000; border:2px solid #111; border-radius:14px; padding:6px 10px; letter-spacing:.3px; }

      @media print{
        body{ background:#fff; }
        .box{ border:none; border-radius:0; }
      }
    
/* ===== LOADING SPINNER (COBRAR) ===== */
#checkoutLoading.ok-modal{ z-index:9999; }
.loading-card{
  width:min(420px,100%);
  background:linear-gradient(180deg, rgba(28,28,30,.98), rgba(18,18,20,.98));
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 24px 70px rgba(0,0,0,.6);
  overflow:hidden;
  color:#fff;
}
.loading-body{ padding:18px; display:flex; align-items:center; gap:14px; }
.loading-spinner{
  width:56px; height:56px;
  border-radius:999px;
  border:6px solid rgba(255,255,255,.20);
  border-top-color: var(--pink);
  animation: spin 1s linear infinite;
  flex:0 0 auto;
}
@keyframes spin{ to{ transform: rotate(360deg); } }
.loading-text b{ display:block; font-weight:1000; letter-spacing:.2px; }
.loading-text small{ display:block; margin-top:4px; opacity:.85; font-weight:800; }

</style>

    <script>
      // Ajusta el contenido SOLO para ENV√çO (10x10) bajando font-size si se desborda
      (function(){
        var IS_ENV = ${isEnv ? "true" : "false"};

        function fit(){
          if(!IS_ENV) return;

          var box = document.querySelector('.box');
          if(!box) return;

          // Si no hay una altura real, no intentes medir
          if(box.clientHeight === 0 || box.clientWidth === 0) return;

          var fs = 12;
          box.style.fontSize = fs + 'px';

          for(var i=0;i<40;i++){
            var overflowH = box.scrollHeight > box.clientHeight;
            var overflowW = box.scrollWidth  > box.clientWidth;

            if(overflowH || overflowW){
              fs -= 0.5;
              box.style.fontSize = fs + 'px';
              if(fs <= 6) break;
            }else{
              break;
            }
          }

          // Auto-fit por campo (Direcci√≥n / Indicaciones)
          var fitField = function(sel, max, min){
            var el = document.querySelector(sel);
            if(!el) return;
            var fs2 = max;
            for(var k=0;k<60;k++){
              el.style.fontSize = fs2 + "px";
              if(el.scrollHeight <= el.clientHeight && el.scrollWidth <= el.clientWidth) break;
              fs2 -= 0.5;
              if(fs2 <= min){ el.style.fontSize = min + "px"; break; }
            }
          };
          if(IS_ENV){
            fitField(".fitAddr", 18, 8);
            fitField(".fitIndic", 16, 7.5);
          }
        }

window.addEventListener('load', function(){
  // 2 pasadas para asegurar layout + im√°genes
  if(typeof fit === "function"){
    fit();
    setTimeout(fit, 150);
    setTimeout(fit, 350);
  }

  // Bot√≥n para elegir carpeta de backups
  const btnPick = document.getElementById("btnPickBackupFolder");
  if(btnPick){
    btnPick.addEventListener("click", async function(){
      try{
        await pickBackupFolder();
      }catch(err){
        console.error(err);
        alert("No se pudo abrir el selector de carpeta. Usa Chrome/Edge y abre en https/localhost.\n\nDetalle: " + (err?.message || err));
      }
    });
  }else{
    // Solo para debug
    console.warn("No existe #btnPickBackupFolder al cargar (puede estar en otra vista).");
  }
});


      })();
    <\/script>
  </head>

  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <img class="cornerLogo" src="${logoSrc}" onerror="this.style.display='none'" alt="Logo" />
      <div class="bar"></div>
      <h1>${escapeHtml(s.shop || "Tienda de Ropa")} ‚Äî Recibo #${escapeHtml(s.receiptNo || "")}</h1>
      <div class="meta">${escapeHtml(d)} ‚Ä¢ Tipo: ${escapeHtml(s.saleType || "MOSTRADOR")}${isEnv ? "" : " ‚Ä¢ Pago: " + escapeHtml(s.payMethod || "EFECTIVO")}</div>
      ${statusLine}

      <div class="content">
      <div class="grid">
        <div class="card">
          <div class="label">Cliente</div>
          <div class="val">${escapeHtml(clientName)}</div>
          <div class="label" style="margin-top:10px">Tel√©fono</div>
          <div class="val ${isEnv ? "phoneBig" : ""}">${escapeHtml(phone)}</div>
          <div class="label" style="margin-top:10px">NIT</div>
          <div class="val">${escapeHtml(nit)}</div>
        </div>
        <div class="card">
          <div class="label">Direcci√≥n</div>
          <div class="val fitField fitAddr">${escapeHtml(addr)}</div>
        </div>
        ${isEnv ? `
        <div class="card">
          <div class="label">Indicaciones</div>
          <div class="val fitField fitIndic">${escapeHtml(indic)}</div>
        </div>
        ` : ``}
      </div>

      ${isEnv ? `` : `
      <table>
        <thead>
          <tr>
            <th style="width:70px;text-align:center">Cant</th>
            <th>Producto</th>
            <th style="width:120px;text-align:right">Precio</th>
            <th style="width:120px;text-align:right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="4">Sin items</td></tr>`}
        </tbody>
      </table>
      `}
      </div>
      <div class="footer">

      ${isEnv
        ? ( (pay === "EFECTIVO" || pay === "CASH")
            ? `<div class="totalRow"><div>TOTAL</div><div>${money(total)}</div></div>`
            : `<div class="totalRow"><div>PAGO</div><div>${escapeHtml(pay)}</div></div>` )
        : `
      <div class="totalRow"><div>SUBTOTAL</div><div>${money(sub)}</div></div>
      <div class="totalRow"><div>DESCUENTO</div><div>${money(disc)}</div></div>
      <div class="totalRow"><div>TOTAL</div><div>${money(total)}</div></div>
      `}

      <div class="foot">Gracias por tu compra üíó</div>
      </div>
    </div>
  </body>
  </html>
  `;
}


function generatePDF(){
  const now = Date.now();
  if(state && state._pdfLock && (now - state._pdfLock) < 1500) return;
  if(state) state._pdfLock = now;
  const s = state.lastReceipt || makeLiveReceipt();

  if(s.saleType === "ENVIO"){
    const ok = s.client && s.client.phone && s.client.names && s.client.last && s.client.addr;
    if(!ok) return alert("Para ENV√çO debes tener cliente completo antes de generar el PDF.");
  }

  const html = receiptToPrintableHTML(s);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para generar PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// ---------- Cierre ----------
function closeToText(c){
  if(!c) return "No hay cierre todav√≠a.";
  const lines = [];
  lines.push(`üßæ *${c.shop}*`);
  lines.push(`CIERRE DE VENTAS ‚Äî ${c.dateKey} (${c.fromHHMM} - ${c.toHHMM})`);
  lines.push(`Generado: ${new Date(c.ts).toLocaleString()}`);
  lines.push(`--------------------------------`);
  lines.push(`Ventas: ${c.salesCount}`);
  lines.push(`Mostrador: ${c.mostradorCount} | Env√≠os: ${c.envioCount}`);
  lines.push(`--------------------------------`);
  lines.push(`EFECTIVO: ${money(c.pay.EFECTIVO)}`);
  lines.push(`TARJETA: ${money(c.pay.TARJETA)}`);
  lines.push(`TRANSFERENCIA: ${money(c.pay.TRANSFERENCIA)}`);
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(c.subtotal)}`);
  lines.push(`DESCUENTOS: ${money(c.discounts)}`);
  lines.push(`TOTAL: *${money(c.total)}*`);
  lines.push(`--------------------------------`);
  lines.push(`CUADRE (Real - Sistema):`);
  lines.push(`EFECTIVO: ${money(c.diff?.EFECTIVO||0)}`);
  lines.push(`TARJETA: ${money(c.diff?.TARJETA||0)}`);
  lines.push(`TRANSFER.: ${money(c.diff?.TRANSFERENCIA||0)}`);
  lines.push(`TOTAL: ${money(c.diffTotal||0)}`);
  lines.push(`--------------------------------`);
  lines.push(`Productos vendidos:`);
  for(const p of c.products){
    lines.push(`- ${p.qty} x ${p.name} (${p.code})`);
  }
  lines.push(`--------------------------------`);
  lines.push(`Cierre generado ‚úÖ`);
  return lines.join("\n");
}

function closeToPrintableHTML(c){
  const rows = c.products.map(p=>`
    <tr>
      <td style="text-align:center">${p.qty}</td>
      <td>${escapeHtml(p.name)}<br><small>${escapeHtml(p.code)}</small></td>
    </tr>
  `).join("");

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Cierre ${escapeHtml(c.dateKey)}</title>
    <style>
      body{ font-family: Arial, sans-serif; margin: 20px; color:#111; background:#fff7fb; }
     <style>
  body{ 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    color:#111; 
    background:#fff7fb; 
  }

  .box{
    position:relative;
    width:100mm;
    height:100mm;
    overflow:hidden;
    margin:0 auto;
    border:2px solid #fbcfe8;
    border-radius:16px;
    padding:10px;
    background:#fff;
    box-sizing:border-box;
  }

  .cornerLogo{ 
    position:absolute; 
    top:12px; 
    right:12px; 
    width:60px; 
    height:60px; 
    object-fit:contain; 
    border-radius:14px; 
    border:1px solid #eee; 
    padding:4px; 
    background:#fff; 
  }

  .bar{ 
    height:8px; 
    border-radius:999px; 
    background: linear-gradient(90deg, #ff4fb7, #a855f7); 
    margin-bottom:12px; 
  }

  h1{ 
    margin:0; 
    font-size:18px; 
    color:#7b2fb4; 
    padding-right:70px; 
  }

  .meta{ 
    margin-top:4px; 
    color:#444; 
    font-size:12px; 
    font-weight:700; 
  }

  .line{ 
    display:flex; 
    justify-content:space-between; 
    gap:12px; 
    font-weight:800; 
    margin:6px 0; 
  }

  table{ 
    width:100%; 
    border-collapse:collapse; 
    margin-top:14px; 
  }

  th,td{ 
    border-bottom:1px solid #eee; 
    padding:8px; 
    font-size:13px; 
  }

  th{ 
    background:#ffe4f1; 
    text-align:left; 
  }

  @media print{
    body{ margin:0; }
    .box{ border:none; border-radius:0; }
  }

    
/* ===== LOADING SPINNER (COBRAR) ===== */
#checkoutLoading.ok-modal{ z-index:9999; }
.loading-card{
  width:min(420px,100%);
  background:linear-gradient(180deg, rgba(28,28,30,.98), rgba(18,18,20,.98));
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 24px 70px rgba(0,0,0,.6);
  overflow:hidden;
  color:#fff;
}
.loading-body{ padding:18px; display:flex; align-items:center; gap:14px; }
.loading-spinner{
  width:56px; height:56px;
  border-radius:999px;
  border:6px solid rgba(255,255,255,.20);
  border-top-color: var(--pink);
  animation: spin 1s linear infinite;
  flex:0 0 auto;
}
@keyframes spin{ to{ transform: rotate(360deg); } }
.loading-text b{ display:block; font-weight:1000; letter-spacing:.2px; }
.loading-text small{ display:block; margin-top:4px; opacity:.85; font-weight:800; }

</style>
  </head>
  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <img class="cornerLogo" src="LOGO1.png" onerror="this.style.display='none'" alt="Logo" />
      <div class="bar"></div>
      <h1>${escapeHtml(c.shop)} ‚Äî Cierre ${escapeHtml(c.dateKey)} (${escapeHtml(c.fromHHMM)}-${escapeHtml(c.toHHMM)})</h1>
      <div class="meta">Generado: ${escapeHtml(new Date(c.ts).toLocaleString())}</div>

      <div class="line"><span>Ventas</span><span>${c.salesCount}</span></div>
      <div class="line"><span>Mostrador</span><span>${c.mostradorCount}</span></div>
      <div class="line"><span>Env√≠os</span><span>${c.envioCount}</span></div>
      <hr>

      <div class="line"><span>EFECTIVO</span><span>${money(c.pay.EFECTIVO)}</span></div>
      <div class="line"><span>TARJETA</span><span>${money(c.pay.TARJETA)}</span></div>
      <div class="line"><span>TRANSFERENCIA</span><span>${money(c.pay.TRANSFERENCIA)}</span></div>
      <hr>

      <div class="line"><span>SUBTOTAL</span><span>${money(c.subtotal)}</span></div>
      <div class="line"><span>DESCUENTOS</span><span>${money(c.discounts)}</span></div>
      <div class="line"><span>TOTAL</span><span>${money(c.total)}</span></div>

      <div style="font-size:12px; font-weight:900; margin:8px 0 6px; color:#666">CUADRE (Real - Sistema)</div>
      <div class="line"><span>Real EFECTIVO</span><span>${money((c.real?.EFECTIVO||0))}</span></div>
      <div class="line"><span>Dif. EFECTIVO</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diff?.EFECTIVO||0)}</span></div>
      <div class="line"><span>Real TARJETA</span><span>${money((c.real?.TARJETA||0))}</span></div>
      <div class="line"><span>Dif. TARJETA</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diff?.TARJETA||0)}</span></div>
      <div class="line"><span>Real TRANSF.</span><span>${money((c.real?.TRANSFERENCIA||0))}</span></div>
      <div class="line"><span>Dif. TRANSF.</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diff?.TRANSFERENCIA||0)}</span></div>
      <div class="line"><span>Dif. TOTAL</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diffTotal||0)}</span></div>

      <h3 style="margin-top:14px">Cuadre (Real - Sistema)</h3>
      <div class="line"><span>EFECTIVO</span><span>${money(c.diff?.EFECTIVO||0)}</span></div>
      <div class="line"><span>TARJETA</span><span>${money(c.diff?.TARJETA||0)}</span></div>
      <div class="line"><span>TRANSFER.</span><span>${money(c.diff?.TRANSFERENCIA||0)}</span></div>
      <div class="line"><span>TOTAL</span><span>${money(c.diffTotal||0)}</span></div>

      <h3 style="margin-top:14px">Productos vendidos</h3>
      <table>
        <thead><tr><th style="width:80px;text-align:center">Cant</th><th>Producto</th></tr></thead>
        <tbody>${rows || `<tr><td colspan="2">Sin ventas</td></tr>`}</tbody>
      </table>

      <div style="margin-top:12px; color:#444; font-size:12px; font-weight:700;">Cierre generado ‚úÖ</div>
    </div>
  </body>
  </html>
  `;
}

async function buildClose(){
  const dateKey = $("closeDate").value || todayKey();
  const rawFrom = $("closeFrom").value;
  const rawTo   = $("closeTo").value;
  let fromHHMM = rawFrom;
  let toHHMM   = rawTo;

  // ‚úÖ Si no defines rango manual, usamos TURNO (desde el √∫ltimo cierre guardado hasta ahora)
  // Regla: se hacen varios cierres en el d√≠a => el siguiente cierre SOLO toma ventas DESPU√âS del √∫ltimo cierre.
  let autoStartTs = null;
  let autoEndTs = null;

  // ‚úÖ TURNO: siempre cortamos por √∫ltimo cierre (y/o inicio de turno) cuando la fecha es HOY.
  // Esto permite varios cierres en el d√≠a: cada cierre toma ventas DESPU√âS del √∫ltimo cierre guardado.
  if(dateKey===todayKey()){
    const shiftStart = await getShiftStartTs();                // inicio de turno (meta)
    const lastClose  = await getLastCloseTs(dateKey);          // √∫ltimo cierre guardado (meta)
    const startTs    = Math.max(Number(shiftStart||0), Number(lastClose||0)) || null;

    if(startTs){
      autoStartTs = startTs;
      autoEndTs   = Date.now();

      // Si el usuario no defini√≥ rango manual, autollenamos HH:MM desde el corte
      if((!fromHHMM || !toHHMM)){
        const a = new Date(startTs);
        const b = new Date(autoEndTs);
        if(!fromHHMM) fromHHMM = a.toTimeString().slice(0,5);
        if(!toHHMM)   toHHMM   = b.toTimeString().slice(0,5);
        if(!rawFrom) $("closeFrom").value = fromHHMM;
        if(!rawTo)   $("closeTo").value   = toHHMM;
      }
    }
  }

  fromHHMM = fromHHMM || "00:00";
  toHHMM   = toHHMM   || "23:59";

  const all = await idbAll("sales");
  let list = all.filter(s=> isWithinDateRange(s.ts, dateKey, fromHHMM, toHHMM)).sort((a,b)=>a.ts-b.ts);

  // Si estamos en modo TURNO autom√°tico, aseguramos corte por timestamp (no solo HH:MM)
  if(autoStartTs && autoEndTs){
    list = list.filter(s=> (Number(s.ts||0) >= autoStartTs) && (Number(s.ts||0) <= autoEndTs));
  }

  const pay = {EFECTIVO:0, TARJETA:0, TRANSFERENCIA:0};
  let subtotal = 0;
  let discounts = 0;
  let total = 0;
  let envioCount = 0;
  let mostradorCount = 0;

  const prodMap = new Map();

  for(const s of list){
    subtotal += Number(s.subtotal ?? s.total ?? 0);
    discounts += Number(s.discountAmount ?? 0);
    total += Number(s.total ?? 0);

    if(s.saleType==="ENVIO") envioCount++; else mostradorCount++;

    if(s.payMethod==="MIXTO" && s.paySplit){
      pay.EFECTIVO = (pay.EFECTIVO||0) + Number(s.paySplit.EFECTIVO||0);
      pay.TARJETA  = (pay.TARJETA||0)  + Number(s.paySplit.TARJETA||0);
    }else{
      pay[s.payMethod] = (pay[s.payMethod]||0) + Number(s.total||0);
    }

    for(const it of (s.items||[])){
      const key = it.code;
      const cur = prodMap.get(key) || {code:it.code, name:it.name, qty:0};
      cur.qty += Number(it.qty||0);
      cur.name = it.name;
      prodMap.set(key, cur);
    }
  }

  const products = [...prodMap.values()].sort((a,b)=>b.qty-a.qty);

  // render historial tabla
  const hb = $("closeHistBody");
  hb.innerHTML = "";
  for(const s of list){
    const tr = document.createElement("tr");
    const d = new Date(s.ts);
    const when = d.toLocaleTimeString();
    const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(client)}</td>
      <td>${escapeHtml(s.saleType||"")}</td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
    `;
    hb.appendChild(tr);
  }

  // Cuadre
  const realCash = Number($("realCash").value||0);
  const realCard = Number($("realCard").value||0);
  const realTrans= Number($("realTrans").value||0);

  const diff = {
    EFECTIVO: Number((realCash - (pay.EFECTIVO||0)).toFixed(2)),
    TARJETA: Number((realCard - (pay.TARJETA||0)).toFixed(2)),
    TRANSFERENCIA: Number((realTrans - (pay.TRANSFERENCIA||0)).toFixed(2))
  };
  const diffTotal = Number((diff.EFECTIVO + diff.TARJETA + diff.TRANSFERENCIA).toFixed(2));

  // mostrar difs
  $("diffCash").textContent = money(diff.EFECTIVO);
  $("diffCard").textContent = money(diff.TARJETA);
  $("diffTrans").textContent = money(diff.TRANSFERENCIA);
  $("diffTotal").textContent = money(diffTotal);

  const close = {
    id: "C-TMP",
    ts: Date.now(),
    dateKey,
    fromHHMM,
    toHHMM,
    shop: state.settings.shopName || "Tienda de Ropa",
    salesCount: list.length,
    envioCount,
    mostradorCount,
    pay,
    subtotal: Number(subtotal.toFixed(2)),
    discounts: Number(discounts.toFixed(2)),
    total: Number(total.toFixed(2)),
    products,
    real: {EFECTIVO: realCash, TARJETA: realCard, TRANSFERENCIA: realTrans},
    diff,
    diffTotal
  };

  state.lastClose = close;

  // pintar ticket de cierre
  $("cShop").textContent = close.shop;
  $("cMeta").textContent = `Cierre ‚Ä¢ ${close.fromHHMM}-${close.toHHMM}`;
  $("cDate").textContent = close.dateKey;
  $("cTime").textContent = new Date(close.ts).toLocaleString();

  $("cSales").textContent = String(close.salesCount);
  $("cMost").textContent = String(close.mostradorCount);
  $("cEnv").textContent = String(close.envioCount);

  $("cCash").textContent = money(close.pay.EFECTIVO||0);
  $("cCard").textContent = money(close.pay.TARJETA||0);
  $("cTrans").textContent = money(close.pay.TRANSFERENCIA||0);

  $("cSub").textContent = money(close.subtotal);
  $("cDisc").textContent = money(close.discounts);
  $("cTotal").textContent = money(close.total);

  // ‚úÖ Cuadre en el ticket (con etiqueta SOBRA/FALTA)
  const fmtDiffTag = (v)=>{
    const n = Number(v||0);
    const tag = n>0 ? "SOBRA" : (n<0 ? "FALTA" : "CUADRADO");
    return `${money(n)} (${tag})`;
  };
  if($("cRealCash")) $("cRealCash").textContent = money(close.real?.EFECTIVO||0);
  if($("cRealCard")) $("cRealCard").textContent = money(close.real?.TARJETA||0);
  if($("cRealTrans")) $("cRealTrans").textContent = money(close.real?.TRANSFERENCIA||0);
  if($("cDiffCash")) $("cDiffCash").textContent = fmtDiffTag(close.diff?.EFECTIVO||0);
  if($("cDiffCard")) $("cDiffCard").textContent = fmtDiffTag(close.diff?.TARJETA||0);
  if($("cDiffTrans")) $("cDiffTrans").textContent = fmtDiffTag(close.diff?.TRANSFERENCIA||0);
  if($("cDiffTotal")) $("cDiffTotal").textContent = fmtDiffTag(close.diffTotal||0);

  const cp = $("cProducts");
  cp.innerHTML = "";
  if(close.products.length===0){
    const div = document.createElement("div");
    div.className="muted";
    div.textContent = "Sin ventas en este rango.";
    cp.appendChild(div);
  }else{
    for(const p of close.products.slice(0,50)){
      const div = document.createElement("div");
      div.className="line";
      div.innerHTML = `<span>${p.qty} x ${escapeHtml(p.name)}</span><span><small>${escapeHtml(p.code)}</small></span>`;
      cp.appendChild(div);
    }
  }
}

async function saveClose(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
 

  const c = {...state.lastClose};
  c.id = "C-" + c.ts + "-" + Math.random().toString(16).slice(2,8);
  await idbPut("closes", c);
  await setLastCloseTs(c.dateKey, c.ts);

  await clearPaidShipments();
  await renderSavedCloses();

  await autoBackupToFolder("cierre"); // ya lo tienes ‚úÖ

  // ‚úÖ reset por turno
  await setShiftStartTs(Date.now());
  await refreshKPIs();

  // ‚úÖ Reset del panel de previsualizaci√≥n para el siguiente cierre
  $("realCash").value = 0;
  $("realCard").value = 0;
  $("realTrans").value = 0;
  $("diffCash").textContent = money(0);
  $("diffCard").textContent = money(0);
  $("diffTrans").textContent = money(0);
  $("diffTotal").textContent = money(0);
  $("closeFrom").value = "";
  $("closeTo").value = "";
  $("closeDate").value = todayKey();
  state.lastClose = null;
  await buildClose();

  showOkModal("Registro exitoso","Cierre guardado.", {enter:true});;
}


async function renderSavedCloses(){
  const dateKey = $("closeDate").value || todayKey();
  const all = await idbAll("closes");
  const list = all.filter(x=>x.dateKey===dateKey).sort((a,b)=>b.ts-a.ts);

  const tb = $("closeSavedBody");
  tb.innerHTML = "";
  for(const c of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(c.dateKey)}</small><br><small>${escapeHtml(new Date(c.ts).toLocaleString())}</small></td>
      <td><b>${escapeHtml(c.fromHHMM||"")}</b> - <b>${escapeHtml(c.toHHMM||"")}</b></td>
      <td>${escapeHtml(String(c.salesCount||0))}</td>
      <td>${money(c.total||0)}</td>
      <td>
        <button class="btn small" data-viewclose="${escapeHtml(c.id)}">Ver</button>
        <button class="btn danger small" data-delclose="${escapeHtml(c.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function viewSavedClose(id){
  const c = await idbGet("closes", id);
  if(!c) return;
  state.lastClose = c;
  // cargar inputs (sin tocar los reales)
  $("closeDate").value = c.dateKey;
  $("closeFrom").value = c.fromHHMM;
  $("closeTo").value = c.toHHMM;

  $("realCash").value = c.real?.EFECTIVO ?? 0;
  $("realCard").value = c.real?.TARJETA ?? 0;
  $("realTrans").value = c.real?.TRANSFERENCIA ?? 0;

  // render ticket / difs
  $("diffCash").textContent = money(c.diff?.EFECTIVO||0);
  $("diffCard").textContent = money(c.diff?.TARJETA||0);
  $("diffTrans").textContent = money(c.diff?.TRANSFERENCIA||0);
  $("diffTotal").textContent = money(c.diffTotal||0);

  // pintar ticket cierre como en buildClose:
  $("cShop").textContent = c.shop;
  $("cMeta").textContent = `Cierre ‚Ä¢ ${c.fromHHMM}-${c.toHHMM}`;
  $("cDate").textContent = c.dateKey;
  $("cTime").textContent = new Date(c.ts).toLocaleString();

  $("cSales").textContent = String(c.salesCount);
  $("cMost").textContent = String(c.mostradorCount);
  $("cEnv").textContent = String(c.envioCount);

  $("cCash").textContent = money(c.pay?.EFECTIVO||0);
  $("cCard").textContent = money(c.pay?.TARJETA||0);
  $("cTrans").textContent = money(c.pay?.TRANSFERENCIA||0);

  $("cSub").textContent = money(c.subtotal||0);
  $("cDisc").textContent = money(c.discounts||0);
  $("cTotal").textContent = money(c.total||0);

  const fmtDiffTag = (v)=>{
    const n = Number(v||0);
    const tag = n>0 ? "SOBRA" : (n<0 ? "FALTA" : "CUADRADO");
    return `${money(n)} (${tag})`;
  };
  if($("cRealCash")) $("cRealCash").textContent = money(c.real?.EFECTIVO||0);
  if($("cRealCard")) $("cRealCard").textContent = money(c.real?.TARJETA||0);
  if($("cRealTrans")) $("cRealTrans").textContent = money(c.real?.TRANSFERENCIA||0);
  if($("cDiffCash")) $("cDiffCash").textContent = fmtDiffTag(c.diff?.EFECTIVO||0);
  if($("cDiffCard")) $("cDiffCard").textContent = fmtDiffTag(c.diff?.TARJETA||0);
  if($("cDiffTrans")) $("cDiffTrans").textContent = fmtDiffTag(c.diff?.TRANSFERENCIA||0);
  if($("cDiffTotal")) $("cDiffTotal").textContent = fmtDiffTag(c.diffTotal||0);

  const cp = $("cProducts");
  cp.innerHTML = "";
  if((c.products||[]).length===0){
    const div = document.createElement("div");
    div.className="muted";
    div.textContent = "Sin ventas en este rango.";
    cp.appendChild(div);
  }else{
    for(const p of (c.products||[]).slice(0,50)){
      const div = document.createElement("div");
      div.className="line";
      div.innerHTML = `<span>${p.qty} x ${escapeHtml(p.name)}</span><span><small>${escapeHtml(p.code)}</small></span>`;
      cp.appendChild(div);
    }
  }
}

async function deleteSavedClose(id){
  if(!requireCode("borrar cierre")) return;
  if(!confirm("¬øBorrar cierre guardado?")) return;
  await idbDel("closes", id);
  await renderSavedCloses();
  alert("Cierre borrado.");
}

async function copyClose(){
  const text = closeToText(state.lastClose);
  try{
    await navigator.clipboard.writeText(text);
    alert("Cierre copiado.");
  }catch{
    alert("No se pudo copiar autom√°ticamente.");
  }
}
function openCloseWhatsApp(){
  const text = closeToText(state.lastClose);
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
}
function generateClosePDF(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const html = closeToPrintableHTML(state.lastClose);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}
async function downloadClosePNG(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const node = $("closeBox");
  if(!node) return;

  if(window.html2canvas){
    try{
      await capturePNG(node, `cierre_${state.lastClose.dateKey}_${state.lastClose.fromHHMM.replace(":","")}-${state.lastClose.toHHMM.replace(":","")}.png`, 2);
      return;
    }catch(e){
      // sigue al aviso abajo
    }
  }
  alert("No se pudo generar PNG. Intenta con PDF.");
}


async function exportJSON(){
  const clients   = await idbAll("clients");
  const products  = await idbAll("products");
  const sales     = await idbAll("sales");
  const shipments = await idbAll("shipments");
  const closes    = await idbAll("closes");
  const meta      = await idbAll("meta");
  const movements = await idbAll("movements"); // ‚úÖ NUEVO

  const data = {
    exportedAt: new Date().toISOString(),
    settings: state.settings,
    clients, products, sales, shipments, closes, meta, movements
  };

  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pos_boutique_backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

async function importJSON(file){
  const text = await file.text();
  const data = JSON.parse(text);
  if(!data || typeof data!=="object") throw new Error("JSON inv√°lido.");

  await idbClearAll();
  if(data.clients) for(const c of data.clients) await idbPut("clients", c);
  if(data.products)for(const p of data.products) await idbPut("products", p);
  if(data.sales)   for(const s of data.sales) await idbPut("sales", s);
  if(data.shipments) for(const s of data.shipments) await idbPut("shipments", s);
  if(data.closes) for(const c of data.closes) await idbPut("closes", c);
  if(data.meta)    for(const m of data.meta) await idbPut("meta", m);
  if(data.movements) for(const m of data.movements) await idbPut("movements", m);
  if(data.settings) state.settings = data.settings;

  await loadSettings();
  await refreshKPIs();
  refreshProductPicker();
  renderProducts();
  renderInventory();
  renderClients();
  renderReport("daily");
  renderShipments();
  updateReceiptPreview();
  buildClose();
  syncDiscUI();
  renderSavedCloses();
  alert("Backup importado.");
}
async function pickBackupFolder(){
  if(!window.showDirectoryPicker){
    alert("Tu navegador no soporta carpeta autom√°tica. Usa Chrome/Edge.");
    return;
  }
  // Evita: NotAllowedError: File picker already active
  if(!window.state) window.state = {};
  state._uiLocks = state._uiLocks || {};
  if(state._uiLocks.pickBackupFolder) return;
  state._uiLocks.pickBackupFolder = true;

  try{
    const handle = await window.showDirectoryPicker();
    if(!handle) return;
    state.backup = state.backup || {};
    state.backup.dirHandle = handle;
    alert("Carpeta de backups configurada ‚úÖ");
  }catch(err){
    // AbortError = el usuario cerr√≥/cancel√≥ el di√°logo (no es problema)
    if(err && (err.name === "AbortError" || err.message?.includes("aborted"))){
      // silencioso
    } else if(err && err.name === "NotAllowedError"){
      // si sigue ocurriendo, suele ser doble click; ya lo bloqueamos arriba
      console.warn("No permitido abrir selector de carpeta:", err);
    } else {
      console.error(err);
      alert("No se pudo seleccionar la carpeta. Intenta de nuevo.");
    }
  }finally{
    state._uiLocks.pickBackupFolder = false;
  }
}
async function autoBackupToFolder(tag="auto"){
  try{
    if(!state.backup?.enabled) return;

    // Si no hay carpeta elegida, hacemos fallback a descarga normal
    if(!state.backup?.dirHandle){
      await exportJSON();
      return;
    }

    const clients   = await idbAll("clients");
    const products  = await idbAll("products");
    const sales     = await idbAll("sales");
    const shipments = await idbAll("shipments");
    const closes    = await idbAll("closes");
    const meta      = await idbAll("meta");
    const movements = await idbAll("movements");

    const data = {
      exportedAt: new Date().toISOString(),
      tag,
      settings: state.settings,
      clients, products, sales, shipments, closes, meta, movements
    };

    const ts = new Date();
    const name =
      `backup_${tag}_` +
      ts.getFullYear() +
      String(ts.getMonth()+1).padStart(2,"0") +
      String(ts.getDate()).padStart(2,"0") + "_" +
      String(ts.getHours()).padStart(2,"0") +
      String(ts.getMinutes()).padStart(2,"0") +
      String(ts.getSeconds()).padStart(2,"0") +
      ".json";

    const fileHandle = await state.backup.dirHandle.getFileHandle(name, { create:true });
    const writable = await fileHandle.createWritable();
    await writable.write(new Blob([JSON.stringify(data,null,2)], {type:"application/json"}));
    await writable.close();
  }catch(e){
    console.warn("AutoBackup fall√≥:", e);
    // fallback a descarga
    try{ await exportJSON(); }catch(_){}
  }
}


async function refreshKPIs(){
  const clients = await idbAll("clients");
  const products= await idbAll("products");
  const sales   = await idbAll("sales");
  const shipments = await idbAll("shipments");

  const now = Date.now();
  let shiftStart = await getShiftStartTs();

  // Si no existe turno a√∫n, lo inicializamos al inicio del d√≠a
  if(!shiftStart){
    const d = new Date();
    d.setHours(0,0,0,0);
    shiftStart = d.getTime();
    await setShiftStartTs(shiftStart);
  }

  // Ventas del TURNO = desde shiftStart hasta ahora
  const turnoSales = sales.filter(s => Number(s.ts||0) >= shiftStart && Number(s.ts||0) <= now);
  const total = turnoSales.reduce((a,s)=>a+Number(s.total||0),0);

  const pending = shipments.filter(s=> (s.status||"PENDIENTE")==="PENDIENTE").length;

  const kClients = $("kClients"); if(kClients) kClients.textContent = clients.length;

  // ‚úÖ Productos vendidos en el TURNO (suma de cantidades de items)
  const soldQty = turnoSales.reduce((acc,s)=> acc + (Array.isArray(s.items) ? s.items.reduce((a,it)=>a+Number(it.qty||0),0) : 0), 0);

  const kProducts= $("kProducts"); if(kProducts) kProducts.textContent = String(soldQty);
  const kSalesToday = $("kSalesToday"); if(kSalesToday) kSalesToday.textContent = turnoSales.length;
  const kTotalToday = $("kTotalToday"); if(kTotalToday) kTotalToday.textContent = money(total);
  const kShipPending= $("kShipPending"); if(kShipPending) kShipPending.textContent = pending;

  // Opcional: cambia el t√≠tulo visual del panel para que diga TURNO ACTUAL
  const pill = document.querySelector(".sidecard .pill");
  if(pill) pill.textContent = "üíó TUS VENTAS TURNO ACTUAL";
}

function sanitizeSettings(){
  if(state.settings.envPngWidth===undefined) state.settings.envPngWidth = 360;
  if(state.settings.envPngScale===undefined) state.settings.envPngScale = 2;
  if(state.settings.envPdfWidthMM===undefined) state.settings.envPdfWidthMM = 80;
  if(state.settings.envPdfMarginMM===undefined) state.settings.envPdfMarginMM = 6;
  if(state.settings.payMethods===undefined) state.settings.payMethods = ["EFECTIVO","TARJETA","TRANSFERENCIA"];
}


function getPayMethods(){
  const raw = state.settings?.payMethods;
  let list = [];
  if(Array.isArray(raw)) list = raw.slice();
  else if(typeof raw === "string") list = raw.split(/[\n,]+/g);
  else list = ["EFECTIVO","TARJETA","TRANSFERENCIA"];

  list = list.map(s=>String(s||"").trim()).filter(Boolean);
  // normaliza y evita duplicados
  const seen = new Set();
  const out = [];
  for(const x of list){
    const key = x.toUpperCase();
    if(seen.has(key)) continue;
    seen.add(key);
    out.push(key);
  }
  return out.length ? out : ["EFECTIVO","TARJETA","TRANSFERENCIA"];
}

function renderPayMethodSelect(){
  const sel = $("payMethod");
  if(!sel) return;
  const current = String(sel.value || "").toUpperCase();
  const methods = getPayMethods();
  sel.innerHTML = "";
  for(const m of methods){
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = m;
    sel.appendChild(opt);
  }
  sel.value = methods.includes(current) ? current : methods[0];
}

async function loadSettings(){
  const meta = await idbGet("meta","settings");
  if(meta?.value) state.settings = meta.value;

  if(state.settings.autoPDF===undefined) state.settings.autoPDF = true;
  if(state.settings.autoPNG===undefined) state.settings.autoPNG = true;

  sanitizeSettings();

  $("sShopName").value = state.settings.shopName || "Tienda de Ropa";
  $("sAutoPDF").value = state.settings.autoPDF ? "1" : "0";
  $("sAutoPNG").value = state.settings.autoPNG ? "1" : "0";

  if($("sPayMethods")) $("sPayMethods").value = (Array.isArray(state.settings.payMethods)? state.settings.payMethods.join("\n") : (state.settings.payMethods||""));

  $("sEnvPngWidth").value = state.settings.envPngWidth;
  $("sEnvPngScale").value = state.settings.envPngScale;
  $("sEnvPdfWidth").value = state.settings.envPdfWidthMM;
  $("sEnvPdfMargin").value = state.settings.envPdfMarginMM;


  renderPayMethodSelect();

  $("rShop").textContent = state.settings.shopName || "Tienda de Ropa";
  $("cShop").textContent = state.settings.shopName || "Tienda de Ropa";
}

async function saveSettings(){
  const prev = {...state.settings};

  const shopName = $("sShopName").value.trim() || "Tienda de Ropa";
  const autoPDF = $("sAutoPDF").value==="1";
  const autoPNG = $("sAutoPNG").value==="1";

  const payMethodsRaw = ($("sPayMethods")?.value || "").trim();

  const envPngWidth = Number($("sEnvPngWidth").value||360);
  const envPngScale = Number($("sEnvPngScale").value||2);
  const envPdfWidthMM = Number($("sEnvPdfWidth").value||80);
  const envPdfMarginMM = Number($("sEnvPdfMargin").value||6);

  // Si cambian tama√±os ENV√çO, pedimos c√≥digo 363534
  const advancedChanged =
    Number(prev.envPngWidth||360) !== envPngWidth ||
    Number(prev.envPngScale||2) !== envPngScale ||
    Number(prev.envPdfWidthMM||80) !== envPdfWidthMM ||
    Number(prev.envPdfMarginMM||6) !== envPdfMarginMM;

  if(advancedChanged){
    if(!requireCode("cambiar tama√±os de impresi√≥n (ENV√çO)")) return;
  }

  state.settings.shopName = shopName;
  state.settings.autoPDF = autoPDF;
  state.settings.autoPNG = autoPNG;


  // Formas de pago (una por l√≠nea o coma)
  state.settings.payMethods = payMethodsRaw
    ? payMethodsRaw.split(/[\n,]+/g).map(s=>String(s||"").trim()).filter(Boolean).map(s=>s.toUpperCase())
    : (state.settings.payMethods || ["EFECTIVO","TARJETA","TRANSFERENCIA"]);

  state.settings.envPngWidth = Math.max(260, Math.min(520, envPngWidth));
  state.settings.envPngScale = Math.max(1, Math.min(4, envPngScale));
  state.settings.envPdfWidthMM = Math.max(50, Math.min(120, envPdfWidthMM));
  state.settings.envPdfMarginMM = Math.max(0, Math.min(20, envPdfMarginMM));

  await idbPut("meta",{key:"settings", value: state.settings});
  renderPayMethodSelect();
  showOkModal("Registro exitoso","Ajustes guardados.", {enter:true});;
  updateReceiptPreview();
  buildClose();
}
function getClientDraftFromForm(){
  const phone = $("cPhone")?.value?.trim() || "";
  const names = $("cNames")?.value?.trim() || "";
  const last  = $("cLast")?.value?.trim() || "";
  const addr  = $("cAddr")?.value?.trim() || "";
  const indic = $("cIndic")?.value?.trim() || "";

  if(!(phone || names || last || addr || indic)) return null; // nada escrito
  return { phone, names, last, addr, indic };
}

function syncClientDraftLive(){
  const draft = getClientDraftFromForm();

  // En ENVIO: el recibo SIEMPRE debe reflejar lo escrito
  // En MOSTRADOR: si escribes algo, tambi√©n lo reflejamos
  state.selectedClient = draft;

  updateReceiptPreview();
}


// ---------- Events ----------
function wireEvents(){
  if(!window.state) window.state = {};
  if(state._wired) return; // evita doble enlace de eventos
  state._wired = true;
  // Helpers (safe binding)
  const on = (id, ev, fn)=>{ const el = $(id); if(el) el.addEventListener(ev, fn); };
  const onClick = (id, fn)=>on(id, 'click', fn);
// Descuento (corrige IDs aqu√≠ (robusto)
  // En este sistema el input se llama: id="discValue"
  // Si ma√±ana cambias el id, solo agrega el nuevo aqu√≠.
  const discInput = $("discValue") || $("discountValue") || $("descuento") || $("discount");
  if(!discInput){
    // No es cr√≠tico: solo no habr√° descuento manual desde UI
    // (evitamos warnings ruidosos en consola)
  } else {
    const safeRecalc = ()=>{
      try{
        if(typeof recalcCartTotals === "function") recalcCartTotals();
        if(typeof calcTotals === "function") calcTotals();
      }catch(_){}
    };
    discInput.addEventListener("input", ()=>{
      const v = Number(discInput.value || 0);
      // soporta ambos formatos: state.discount.value o state.discount
      if(!window.state) window.state = {};
      if(typeof state.discount === "object" && state.discount){
        state.discount.value = v;
      } else {
        state.discount = { value: v };
      }
      safeRecalc();
      if(typeof updateReceiptPreview === "function") updateReceiptPreview();
    });
  }
  // ====== HAMBURGER / SIDEBAR TOGGLE ======
  const isMobile = ()=> window.matchMedia("(max-width: 980px)").matches;

  function applySavedMenuState(){
    const saved = localStorage.getItem("mt_sidebar_collapsed");
    if(saved === "1") document.body.classList.add("sidebar-collapsed");
    else document.body.classList.remove("sidebar-collapsed");
  }
  applySavedMenuState();

  function closeMobileSidebar(){
    document.body.classList.remove("sidebar-open");
  }

  onClick("btnToggle", ()=>{
    // Mobile: abre/cierra drawer
    if(isMobile()){
      document.body.classList.toggle("sidebar-open");
      return;
    }
    // Desktop: colapsa/expande sidebar
    document.body.classList.toggle("sidebar-collapsed");
    localStorage.setItem("mt_sidebar_collapsed", document.body.classList.contains("sidebar-collapsed") ? "1" : "0");
  });

  // Overlay click (solo m√≥vil)
  onClick("menuOverlay", closeMobileSidebar);

  // Si tocas un bot√≥n del men√∫, en m√≥vil cerramos el drawer
  const nav = $("nav");
  if(nav){
    nav.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-view]");
      if(btn && isMobile()) closeMobileSidebar();
    });
  }

  // Escape para cerrar en m√≥vil
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") closeMobileSidebar();
  });

  // Al cambiar tama√±o, limpia estados cruzados
  window.addEventListener("resize", ()=>{
    if(!isMobile()){
      document.body.classList.remove("sidebar-open");
    }
  });

  // üìÅ Elegir carpeta de Backups
  onClick("btnPickBackupFolder", async ()=>{
    try{
      await pickBackupFolder();
    }catch(e){
      console.error(e);
      alert("No se pudo abrir el selector de carpeta.\nUsa Chrome o Edge y abre el sistema en https o localhost.");
    }
  });
$("btnRepDaily").addEventListener("click", ()=>renderReport("daily"));
$("btnRepWeekly").addEventListener("click", ()=>renderReport("weekly"));
$("btnRepMonthly").addEventListener("click", ()=>renderReport("monthly"));

const btnRange = $("btnRepRange");
if(btnRange){
  btnRange.addEventListener("click", renderReportRange);
}

  // Nav
  $("nav").addEventListener("click",(e)=>{
    // Acci√≥n: ir al formulario de productos
    const act = e.target.closest("button[data-action]");
    if(act && act.dataset.action === "prodform"){
      if(!appReady) return;
      setView("products");
      // cerrar men√∫
      try{ $("nav").classList.add("hide"); }catch(e){}
      // bajar al formulario
      setTimeout(()=>{
        const form = $("prodFormCard");
        if(form) form.scrollIntoView({behavior:"smooth", block:"start"});
        try{ $("pCode") && $("pCode").focus(); }catch(e){}
      }, 60);
      return;
    }

    const btn = e.target.closest("button[data-view]");
    if(!btn) return;
    if(!appReady) return;
    setView(btn.dataset.view);
    // cerrar men√∫
    try{ $("nav").classList.add("hide"); }catch(e){}
  });

  // Hamburger toggle
  $("btnToggle").addEventListener("click", ()=>{
    $("nav").classList.toggle("hide");
  });

  // Descuento
onClick("btnApplyDisc", ()=>{
  const type = $("discType").value;
  const value = Number($("discValue").value||0);
  state.discount = { type, value };
  syncDiscUI();
  renderCart();
});

onClick("btnClearDisc", ()=>{
  state.discount = { type:"NONE", value:0 };
  syncDiscUI();
  renderCart();
});


  // Inventory
  $("invSearch").addEventListener("input", ()=>{ if(state.view==="inventory") renderInventory(); });
  $("btnInvRefresh").addEventListener("click", renderInventory);
  $("btnInvExportXLS").addEventListener("click", exportInventoryExcel);

  // Shipments
  $("shipSearch").addEventListener("input", renderShipments);
  $("shipFilter").addEventListener("change", renderShipments);
  $("btnShipRefresh").addEventListener("click", renderShipments);
  $("shipBody").addEventListener("click", async (e)=>{
    const view = e.target.closest("button[data-viewship]");
    const pay  = e.target.closest("button[data-payship]");
    const pend = e.target.closest("button[data-pendship]");
    const del  = e.target.closest("button[data-delship]");

    if(view){
      const id = view.dataset.viewship;
      const s = await idbGet("shipments", id);
      if(s){
        state.lastReceipt = s;
        updateReceiptPreview();
        setView("pos");
    postReloadOkCheck();
        alert("Env√≠o cargado en vista POS. Puedes generar WhatsApp/PDF/PNG. (No cuenta como venta hasta PAGADO)");
      }
    }
    if(pay){
      await markShipmentPaid(pay.dataset.payship);
    }
    if(pend){
      await markShipmentPending(pend.dataset.pendship);
      await renderShipments();
    }
    if(del){
      await deleteShipment(del.dataset.delship);
    }
  });

  // Cierre
  $("btnBuildClose").addEventListener("click", async ()=>{ await buildClose(); alert("Cierre generado ‚úÖ"); });
  $("btnSaveClose").addEventListener("click", saveClose);
  $("closeDate").addEventListener("change", async ()=>{ if(state.view==="close"){ await buildClose(); await renderSavedCloses(); } });
  $("closeFrom").addEventListener("change", ()=>{ if(state.view==="close") buildClose(); });
  $("closeTo").addEventListener("change", ()=>{ if(state.view==="close") buildClose(); });

  ["realCash","realCard","realTrans"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ if(state.view==="close") buildClose(); });
  });

  $("btnCloseListRefresh").addEventListener("click", renderSavedCloses);
  $("closeSavedBody").addEventListener("click", async (e)=>{
    const v = e.target.closest("button[data-viewclose]");
    const d = e.target.closest("button[data-delclose]");
    if(v) await viewSavedClose(v.dataset.viewclose);
    if(d) await deleteSavedClose(d.dataset.delclose);
  });

  $("btnCloseCopy").addEventListener("click", copyClose);
  $("btnClosePDF").addEventListener("click", generateClosePDF);
  $("btnClosePNG").addEventListener("click", downloadClosePNG);
  $("btnCloseWA").addEventListener("click", openCloseWhatsApp);

  // Scan click: si hay c√≥digo, agrega; si no, solo enfoca
  $("btnScan").addEventListener("click", async ()=>{
    const code = $("scanInput").value.trim();
    const qty = Number($("qtyInput").value||1);

    if(!code){
      $("scanInput").focus();
      $("scanInput").select();
      return;
    }
    const p = await getProductByCode(code);
    if(!p) { alert("No existe producto con c√≥digo: " + code); return; }
    cartAdd(p, qty);
    $("scanInput").value="";
    $("qtyInput").value=1;
    $("scanInput").focus();
  });

  // Scan Enter
  $("scanInput").addEventListener("keydown", async (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const code = $("scanInput").value.trim();
      const qty = Number($("qtyInput").value||1);
      if(!code) return;
      const p = await getProductByCode(code);
      if(!p) { alert("No existe producto con c√≥digo: " + code); return; }
      cartAdd(p, qty);
      $("scanInput").value="";
      $("qtyInput").value=1;
      $("scanInput").focus();
    }
  });

  // Search products for picker
  $("productSearch").addEventListener("input", refreshProductPicker);
  $("btnAddPicked").addEventListener("click", async ()=>{
    const code = $("productPicker").value;
    if(!code) return;
    const p = await getProductByCode(code);
    if(!p) return alert("Producto no existe.");
    cartAdd(p, Number($("qtyInput").value||1));
    $("qtyInput").value=1;
    $("scanInput").focus();
  });

  // Cart actions
  $("cartBody").addEventListener("click",(e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const id = b.dataset.id;
    const act = b.dataset.act;
    if(act==="minus") cartInc(id,-1);
    if(act==="plus")  cartInc(id, 1);
    if(act==="del")   { state.cart = state.cart.filter(x=>String(x.id)!==String(id)); renderCart(); }
  });

  // Descuento por producto: al cambiar el campo, recalcula al instante
  $("cartBody").addEventListener("change",(e)=>{
    const el = e.target;
    if(!el || el.dataset.act!=="discVal") return;
    const id = el.dataset.id;
    const it = (state.cart||[]).find(x=>String(x.id)===String(id));
    if(!it) return;
    it.discValue = Math.max(0, Number(el.value||0));
    renderCart();
  });


  $("btnClearCart").addEventListener("click", cartClear);

  // Client find/save
  $("btnFindClient").addEventListener("click", async ()=>{
    const phone = $("cPhone").value.trim();
    if(!phone) return alert("Ingrese tel√©fono.");
    const c = await findClientByPhone(phone);
    if(!c){
      alert("No existe. Completa los datos y presiona Guardar.");
      state.selectedClient = null;
      updateReceiptPreview();
      return;
    }
    state.selectedClient = c;
    $("cNames").value = c.names || "";
    $("cLast").value  = c.last || "";
    $("cAddr").value  = c.addr || "";
    $("cIndic").value = c.indic || "";
    if($("cNit")) $("cNit").value = c.nit || "";
    alert("Cliente cargado.");
    updateReceiptPreview();
  });

  $("btnSaveClient").addEventListener("click", saveClientFromForm);

  $("btnUseWalkIn").addEventListener("click", ()=>{
    if($("saleType").value==="ENVIO"){
      alert("En ENV√çO no se permite venta sin cliente.");
      return;
    }
    state.selectedClient = null;
    $("cPhone").value="";
    $("cNames").value="";
    $("cLast").value="";
    if($("cNit")) $("cNit").value="";
    $("cAddr").value="";
    $("cIndic").value="";
    alert("Listo: venta MOSTRADOR sin cliente.");
    updateReceiptPreview();
  });

$("saleType").addEventListener("change", ()=>{
  if($("saleType").value==="ENVIO"){
    $("cPhone").focus();
  }
  syncClientDraftLive(); // refresca usando lo escrito
});


  $("payMethod").addEventListener("change", ()=>{ handlePayMethodUI(); updateReceiptPreview(); });
  $("mixCash")?.addEventListener("input", ()=>{ handlePayMethodUI(); updateReceiptPreview(); });
  $("mixCard")?.addEventListener("input", ()=>{ updateReceiptPreview(); });


  // Checkout
  $("btnCheckout").addEventListener("click", ()=>{ try{ playSaleTone(); }catch(e){} return checkout(); });

  // Receipt buttons
  $("btnCopyReceipt").addEventListener("click", copyReceipt);
  $("btnPDF").addEventListener("click", generatePDF);
  $("btnDownloadReceipt").addEventListener("click", downloadReceiptPNG);
  $("btnWhatsApp").addEventListener("click", openWhatsApp);

  // Clients table actions
  $("clientsBody").addEventListener("click", async (e)=>{
    const use = e.target.closest("button[data-useclient]");
    const del = e.target.closest("button[data-delclient]");
    if(use){
      const phone = use.dataset.useclient;
      const c = await findClientByPhone(phone);
      if(c){
        state.selectedClient = c;
        $("cPhone").value=c.phone; $("cNames").value=c.names; $("cLast").value=c.last; if($("cNit")) $("cNit").value=c.nit||""; $("cAddr").value=c.addr; $("cIndic").value=c.indic||"";
        setView("pos");
    postReloadOkCheck();
        updateReceiptPreview();
      }
    }
    if(del){
      if(!requireCode("borrar cliente")) return;
      const phone = del.dataset.delclient;
      if(confirm("¬øBorrar cliente "+phone+"?")){
        await idbDel("clients", phone);
        await refreshKPIs();
        renderClients();
      }
    }
  });

  $("clientSearch").addEventListener("input", renderClients);
  $("btnClientRefresh").addEventListener("click", renderClients);

  // Products actions
  $("btnSaveProduct").addEventListener("click", saveProductFromForm);
  const _logoutBtn = $("btnLogoutAdmin");
  if(_logoutBtn) _logoutBtn.addEventListener("click", ()=>{ try{ logoutAdmin(); }catch(e){} });
  $("prodSearch").addEventListener("input", renderProducts);
  $("btnProdRefresh").addEventListener("click", ()=>{ renderProducts(); refreshProductPicker(); });

  $("productsBody").addEventListener("click", async (e)=>{
    const fill = e.target.closest("button[data-fillprod]");
    const del  = e.target.closest("button[data-delprod]");
    if(fill){
      if(!requireCode("editar producto")) return;
      const code = fill.dataset.fillprod;
      const p = await getProductByCode(code);
      if(!p) return;
      $("pCode").value = p.code;
      $("pName").value = p.name;
      $("pPrice").value= p.price;
      $("pCost").value= (p.cost ?? 0);
      $("pStock").value= p.stock;
      $("pCode").focus();
      const form = $("prodFormCard");
      if(form) form.scrollIntoView({behavior:"smooth", block:"start"});
    }
    if(del){
      if(!requireCode("borrar producto")) return;
      const code = del.dataset.delprod;
      if(confirm("¬øBorrar producto "+code+"?")){
        await idbDel("products", code);
        await refreshKPIs();
        renderProducts();
        refreshProductPicker();
        renderInventory();
      }
    }
  });

  // Scroll a formulario crear/modificar
  onClick("btnGoProdForm", ()=>{
    const el = $("prodFormCard");
    if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    try{ $("pCode")?.focus(); }catch(e){}
  });

  // Reports actions
 onClick("btnRepDaily", ()=>renderReport("daily"));
onClick("btnRepWeekly", ()=>renderReport("weekly"));
onClick("btnRepMonthly", ()=>renderReport("monthly"));


  $("salesBody").addEventListener("click", async (e)=>{
    const view = e.target.closest("button[data-viewsale]");
    const del  = e.target.closest("button[data-delsale]");
    if(view){
      const id = view.dataset.viewsale;
      const s = await idbGet("sales", id);
      if(s){
        state.lastReceipt = s;
        updateReceiptPreview();
        setView("pos");
    postReloadOkCheck();
        alert("Recibo cargado en vista POS. Puedes copiar/WhatsApp/PNG/PDF.");
      }
    }
    if(del){
      if(!requireCode("borrar venta")) return;
      const id = del.dataset.delsale;
      if(confirm("¬øBorrar venta?")){
        // Restock al borrar venta (solo turno actual en UI, pero aplica al ticket borrado)
        const sale = await idbGet("sales", id);
        if(sale && Array.isArray(sale.items)){
          await restoreStockForItems(sale.items, "VENTA", id, "Anulaci√≥n de venta");
        }
        await idbDel("sales", id);
        await refreshKPIs();
        renderReport("daily");
        buildClose();
      }
    }
  });

  // Backup / restore (con clave) 
  $("btnBackup").addEventListener("click", async ()=>{
    if(!requireBackupCode("exportar backup")) return;
    await exportJSON();
  });

  $("btnRestore").addEventListener("click", ()=>{
    if(!requireBackupCode("importar backup")) return;
    $("restoreFile").click();
  });

  $("restoreFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{ await importJSON(file); }
    catch(err){ alert("Error importando: " + err.message); }
    e.target.value="";
  });

  // Live updates on receipt while typing (EN TIEMPO REAL)
["cPhone","cNames","cLast","cAddr"].forEach(id=>{
  const el = $(id);
  if(!el) return;
  el.addEventListener("input", syncClientDraftLive);
  el.addEventListener("change", syncClientDraftLive);
});

  // Focus scan input by pressing F2
 window.addEventListener("keydown",(e)=>{
  if(e.key === "F2"){
    e.preventDefault();
    const s = $("scanInput");
    if(!s) return;
    s.focus();
    s.select();
  }
});


  // Settings save
  const btnSave = $("btnSaveSettings");
if(btnSave) btnSave.addEventListener("click", saveSettings);


  // Kardex
  onClick("btnKRefresh", renderKardex);
  onClick("btnKClear", clearKardex);
  ["kSearch","kType"].forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener("input", ()=>renderKardex());
    el.addEventListener("change", ()=>renderKardex());
  });


  // Crear producto desde panel del generador
  const _btnGenCreate = document.getElementById("btnGenCreateProd");
  if(_btnGenCreate){
    _btnGenCreate.addEventListener("click", async ()=>{
      try{
        const code = (document.getElementById("genPCode")?.value || "").trim();
        const name = (document.getElementById("genPName")?.value || "").trim();
        const price = Number(document.getElementById("genPPrice")?.value || 0);
        const cost  = Number(document.getElementById("genPCost")?.value || 0);
        const stock = Number(document.getElementById("genPStock")?.value || 0);
        if(!code) return alert("Ingrese C√≥digo (SKU/barras).");
        if(!name) return alert("Ingrese Nombre.");
        if(!isFinite(price) || price<0) return alert("Precio inv√°lido.");
        if(!isFinite(cost)  || cost<0)  return alert("Costo inv√°lido.");
        if(!isFinite(stock) || stock<0) return alert("Stock inv√°lido.");

        const exists = await idbGet("products", code);
        if(exists){
          if(!requireCode("editar producto")) return;
        }
        await idbPut("products", {
          code, name,
          price: Number(price.toFixed(2)),
          cost:  Number(cost.toFixed(2)),
          stock: Math.floor(stock),
          nameKey: normKey(name),
          updatedAt: Date.now()
        });
        await logMovement({ ts: Date.now(), code, name, delta: Math.floor(stock) - Math.floor(Number(exists?.stock||0)), note: "Creado/actualizado desde Generador" });

        // limpiar campos
        ["genPCode","genPName","genPPrice","genPCost","genPStock"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });

        // refrescar tablas
        try{ await renderProducts(); }catch(e){}
        try{ await renderInventory(); }catch(e){}
        // reenviar inventario al generador
        try{ sendInventoryToLabels(); setTimeout(sendInventoryToLabels, 250); }catch(e){}
        alert("Producto guardado en inventario.");
      }catch(err){
        console.error(err);
        alert("No se pudo guardar el producto: " + err.message);
      }
    });
  }

}

// ---------- Init ----------
(async function init(){
  // Importante: cablear eventos ANTES de cualquier operaci√≥n async.
  // As√≠, si IndexedDB falla, la UI sigue respondiendo y muestra errores al intentar acciones.
  try{
    // wireEvents(); // (desactivado: se llamaba 2 veces)

  }catch(e){
    console.warn('wireEvents fall√≥', e);
  }
  try{
    db = await openDB();
    appReady = true;
    await loadSettings();
    syncDiscUI();
    renderCart();
    await refreshKPIs();
    await refreshProductPicker();
    await renderProducts();
    await renderInventory();
    await renderClients();
    await renderSavedCloses();
    updateReceiptPreview();

    // Fecha por defecto en cierre
    const cd = $("closeDate");
    if(cd && !cd.value) cd.value = todayKey();

    setView("pos");
    postReloadOkCheck();
  }catch(err){
    console.error(err);
    alert("Error iniciando el sistema: " + (err?.message || err));
  }
})();
(async function init(){
  try{
    db = await openDB();      // Abre IndexedDB
    appReady = true;         // üî• Aqu√≠ habilitas la app

    await loadSettings();
    await refreshKPIs();
    await refreshProductPicker();

    wireEvents();            // Ahora s√≠ conecta todos los botones
    setView("pos");
    postReloadOkCheck();          // Entra directo al POS
  }catch(err){
    console.error(err);
    alert("Error inicializando el sistema: " + err.message);
  }
})();



/* ===== Integraci√≥n: Generador de Etiquetas dentro de MTR ONLINE AP ===== */
const __GEN_LABELS_SRCDOC__ = `<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>GENERADOR ‚Äî Etiquetas  | MarckBusiness</title>

  <script>try{Object.defineProperty(window,"localStorage",{value:{getItem:()=>null,setItem:()=>{},removeItem:()=>{},clear:()=>{}},configurable:true});Object.defineProperty(window,"sessionStorage",{value:{getItem:()=>null,setItem:()=>{},removeItem:()=>{},clear:()=>{}},configurable:true});}catch(e){}<\/script>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"><\/script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"><\/script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b2f;
      --card:#0b1628;
      --text:#eaf1ff;
      --muted:#9fb0c8;
      --accent:#2b7cff;
      --accent2:#1dd3b0;
      --ok:#22c55e;
      --danger:#ef4444;
      --border:rgba(255,255,255,.10);
      --shadow:0 16px 50px rgba(0,0,0,.55);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 650px at 10% 0%, rgba(43,124,255,.18), transparent 55%),
        radial-gradient(900px 650px at 90% 0%, rgba(29,211,176,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 40%),
        var(--bg);
      min-height:100vh;
    }

    /* ---------- Layout ---------- */
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center;min-width:260px}
    .brand h1{margin:0;font-size:18px;font-weight:1000;letter-spacing:.2px}
    .brand p{margin:2px 0 0;color:var(--muted);font-weight:850;font-size:13px}

    .logoImg{
      width:48px;height:48px;border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 16px 34px rgba(43,124,255,.14);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .logoImg img{width:100%;height:100%;object-fit:contain;padding:6px;display:block;}

    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(43,124,255,.35);
      background:rgba(43,124,255,.10);
      font-weight:1000;color:#cfe4ff;
      user-select:none;white-space:nowrap;
    }

    .grid{display:grid;grid-template-columns: 1.05fr .95fr;gap:14px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{
      background: rgba(15, 27, 47, .76);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";position:absolute;inset:-2px;
      background:linear-gradient(135deg, rgba(43,124,255,.18), transparent 38%, rgba(29,211,176,.12));
      filter:blur(18px);opacity:.55;pointer-events:none;
    }
    .card > *{position:relative; z-index:1}
    .card h2{margin:0 0 10px;font-size:15px;font-weight:1000}
    .muted{color:var(--muted);font-weight:850;font-size:13px;line-height:1.35}

    .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .field{display:flex;flex-direction:column;gap:6px;min-width:0}
    .field.full{grid-column:1/-1}
    label{font-size:12px;color:var(--muted);font-weight:950;letter-spacing:.2px}

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(11, 22, 40, .85);
      color:var(--text);
      outline:none;
      font-weight:950;
    }
    input:focus, select:focus{
      border-color: rgba(43,124,255,.55);
      box-shadow: 0 0 0 4px rgba(43,124,255,.14);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row .grow{flex:1;min-width:220px}

    .btn{
      border:none;cursor:pointer;
      padding:11px 14px;border-radius:14px;
      font-weight:1000;color:#fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 14px 30px rgba(43,124,255,.20);
      transition: transform .15s ease, filter .15s ease;
      text-decoration:none; /* para <a class="btn"> */
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{transform:translateY(-1px);filter:saturate(1.05)}
    .btn:active{transform:translateY(0)}
    .btn.secondary{background:#0b1628;border:1px solid var(--border);box-shadow:none;color:var(--text)}
    .btn.danger{background:linear-gradient(90deg,#ef4444,#b91c1c)}
    .btn.small{padding:9px 12px;border-radius:12px}

    /* ========= BOT√ìN ROSADO (NUEVO) ========= */
    .btn-pink{
      background: linear-gradient(90deg, #ff4fb7, #fb7185);
      box-shadow: 0 14px 30px rgba(255,79,183,.35);
      color:#fff;
    }
    .btn-pink:hover{
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    table{width:100%;border-collapse:collapse;margin-top:12px;overflow:hidden;border-radius:14px;border:1px solid var(--border)}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);text-align:left;font-weight:900;font-size:13px;vertical-align:top}
    th{background:rgba(43,124,255,.12);color:#cfe4ff}
    tr:last-child td{border-bottom:none}
    td small{color:var(--muted);font-weight:900}

    /* -------- Vista previa mejorada para lectura -------- */
    .previewWrap{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;margin-top:10px}
    .labelPreview{
      background:#fff;color:#111;border-radius:14px;
      padding:10px;border:1px solid rgba(0,0,0,.12);
      width:340px;max-width:100%;
      transform-origin:top left;
    }
    .labelPreview .line1{display:flex;justify-content:space-between;gap:10px;font-weight:1000}
    .labelPreview .name{font-size:15px;max-width:68%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .labelPreview .price{font-size:16px}

    /* √Årea blanca (quiet zone) + barras grandes */
    .barcodeBox{
      margin-top:8px;
      background:#fff;
      padding:6px;               /* quiet zone */
      border:2px solid #000;     /* contraste */
      border-radius:10px;
    }
    .labelPreview svg{width:100%;height:68px;display:block}

    .footer{margin-top:14px;color:rgba(255,255,255,.65);font-weight:900;font-size:12px;text-align:center}
    .footer b{color:#cfe4ff}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:14px;color:#fff;font-weight:950;
      box-shadow:0 20px 44px rgba(0,0,0,.45);
      opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:50;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px);}

    /* ---------- Login Overlay ---------- */
    .loginOverlay{
      position:fixed; inset:0;
      background:
        radial-gradient(900px 650px at 10% 0%, rgba(43,124,255,.20), transparent 55%),
        radial-gradient(900px 650px at 90% 0%, rgba(29,211,176,.16), transparent 55%),
        rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;
      padding:18px;z-index:1000;
    }
    .loginBox{
      width:min(560px, 100%);
      background: rgba(15,27,47,.88);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 24px 70px rgba(0,0,0,.60);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .loginBox:before{
      content:""; position:absolute; inset:-2px;
      background:linear-gradient(135deg, rgba(43,124,255,.22), transparent 40%, rgba(29,211,176,.16));
      filter:blur(18px); opacity:.6; pointer-events:none;
    }
    .loginBox > *{ position:relative; z-index:1; }
    .loginHead{
      display:flex; gap:12px; align-items:center;
      padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,.10);
      margin-bottom:12px;
    }
    .loginTitle{display:flex; flex-direction:column; gap:2px}
    .loginTitle b{font-size:16px; font-weight:1000}
    .loginTitle small{color:var(--muted); font-weight:900}
    .loginForm{display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px;}
    .loginRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .loginRow input{flex:1; min-width:220px}
    .topRightActions{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  
/* ===== LOADING SPINNER (COBRAR) ===== */
#checkoutLoading.ok-modal{ z-index:9999; }
.loading-card{
  width:min(420px,100%);
  background:linear-gradient(180deg, rgba(28,28,30,.98), rgba(18,18,20,.98));
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 24px 70px rgba(0,0,0,.6);
  overflow:hidden;
  color:#fff;
}
.loading-body{ padding:18px; display:flex; align-items:center; gap:14px; }
.loading-spinner{
  width:56px; height:56px;
  border-radius:999px;
  border:6px solid rgba(255,255,255,.20);
  border-top-color: var(--pink);
  animation: spin 1s linear infinite;
  flex:0 0 auto;
}
@keyframes spin{ to{ transform: rotate(360deg); } }
.loading-text b{ display:block; font-weight:1000; letter-spacing:.2px; }
.loading-text small{ display:block; margin-top:4px; opacity:.85; font-weight:800; }


/* ===== Ajustes UI: un solo creador (con costo) + cola arriba ===== */
#legacyProductCreator > h2,
#legacyProductCreator > .form { display:none !important; }

.grid{ display:flex !important; flex-direction:column !important; gap:14px !important; }
#queueCard{ order:0 !important; }
#legacyProductCreator{ order:1 !important; }

/* ocultar accesos/creadores viejos dentro del generador */
#btnNext, #btnClearForm { display:none !important; }

/* bot√≥n compacto */
#btnOpenCreateCost{ padding:8px 10px !important; border-radius:12px !important; }

/* inputs compactos */
#dlgCreateCost input{ border-radius:12px !important; }

</style>
</head>

<body>
  <!-- LOGIN -->
  <div class="loginOverlay" id="loginOverlay" style="display:none">
    <div class="loginBox">
      <div class="loginHead">
        <div class="logoImg" style="width:54px;height:54px;border-radius:16px">
          <img id="loginLogo" src="./LOGO1.png" alt="LOGO1" onerror="this.style.display='none'">
        </div>
        <div class="loginTitle">
          <b>Iniciar sesi√≥n</b>
          <small>Ingresa el c√≥digo para usar el generador</small>
        </div>
      </div>

      <div class="loginForm">
        <div class="field full">
          <label>C√≥digo</label>
          <input id="loginCode" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
          <div class="muted">C√≥digo requerido: <b>********</b></div>
        </div>

        <div class="loginRow">
          <button class="btn" id="btnLogin" type="button">Entrar</button>
          <button class="btn secondary" id="btnLoginClear" type="button">Limpiar</button>
        </div>
      </div>

      <div class="muted" style="margin-top:10px">
       MarckBusiness ¬©2026 todos los derechos reservados.
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="appWrap" style="display:block">
    <div class="top">
      <div class="brand">
        <div class="logoImg" title="LOGO1 (solo en el sitio)">
          <img id="siteLogo" src="./LOGO1.png" alt="LOGO1">
        </div>
        <div>
          <h1>GENERADOR ‚Äî Etiquetas (PDF)</h1>
          <p>MT ROPA ONLINE </p>
        </div>
      </div>

      <div class="topRightActions">
        <div class="pill">PAGO AL DIA üëç</div>

       
        
        <button class="btn secondary" id="btnLogout" type="button">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="legacyProductCreator" style="display:none">
        <h2>Producto</h2>
        <div class="form">
          <div class="field">
            <label>CODIGO 5 DIGITOS</label>
            <div class="row">
              <input id="pCode" class="grow" inputmode="numeric" maxlength="5" placeholder="Ej: 00001"/>
              <button class="btn small secondary" id="btnNext" type="button">Siguiente</button>
            </div>
          </div>
          <div class="field">
            <label>Precio (Q)</label>
            <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ej: 129.00"/>
          </div>

          <!-- STOCK (nuevo) -->
          <div class="field">
            <label>Stock</label>
            <input id="pStock" type="number" min="0" step="1" value="0" placeholder="Ej: 10"/>
          </div>

          <div class="field full">
            <label>Nombre</label>
            <input id="pName" placeholder="Ej: Camisa Oxford"/>
          </div>
          <div class="field full">
            <div class="row">
              <button class="btn" id="btnSave" type="button">Guardar</button>
              <button class="btn secondary" id="btnClearForm" type="button">Limpiar</button>
            </div>
          </div>
        </div>

        <div class="previewWrap">
          <div>
            <div class="muted"><b>Vista previa</b> </div>
            <div class="labelPreview" id="previewBox">
              <div class="line1">
                <div class="name" id="pvName">‚Äî</div>
                <div class="price" id="pvPrice">Q0.00</div>
              </div>

              <div class="barcodeBox">
                <svg id="pvBarcode"></svg>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="queueCard">
        <div class="row" style="justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
          <h2 style="margin:0">Cola (PDF)</h2>
</div>
        <div class="row">
          <input id="qSearch" class="grow" placeholder="Buscar por CODIGO O NOMBRE"/>
          <button class="btn secondary" id="btnRefresh" type="button">Refrescar</button>
          <button class="btn danger" id="btnWipe" type="button">Borrar todo</button>
        </div>

        <div class="form" style="margin-top:10px">
          <div class="field">
            <label>Producto</label>
            <select id="pick"></select>
          </div>

          <div class="field">
            <label>Cantidad</label>
            <input id="qty" type="number" min="1" value="1"/>
          </div>

          <!-- tama√±o: 50x25 por defecto -->
          <div class="field">
            <label>Ancho etiqueta (mm)</label>
            <input id="lblW" type="number" min="20" step="0.1" value="50"/>
          </div>

          <div class="field">
            <label>Alto etiqueta (mm)</label>
            <input id="lblH" type="number" min="20" step="0.1" value="25"/>
          </div>

          <!-- horizontal fijo (igual lo dejo por si alg√∫n d√≠a cambias) -->
          <div class="field full">
            <label>Orientaci√≥n</label>
            <select id="lblOri">
              <option value="landscape" selected>Horizontal</option>
              <option value="portrait">Vertical</option>
              <option value="AUTO">Autom√°tica (seg√∫n ancho/alto)</option>
            </select>
            <div class="muted" style="margin-top:6px">
              Para 50√ó25 usa <b>Horizontal</b>.
            </div>
          </div>

          <div class="field full">
            <div class="row">
              <button class="btn" id="btnAddToQueue" type="button">Agregar</button>
              <button class="btn secondary" id="btnClearQueue" type="button">Limpiar cola</button>
              <button class="btn" id="btnPDF" type="button">Abrir PDF</button>
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr><th>SKU</th><th>Nombre</th><th>Precio</th><th>Cant.</th><th style="width:140px">Acci√≥n</th></tr>
          </thead>
          <tbody id="queueBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Importar / Exportar</h2>
      <div class="row">
        <button class="btn secondary" id="btnExcel" type="button">Importar Excel</button>
        <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" style="display:none"/>
        <button class="btn secondary" id="btnExport" type="button">Exportar JSON</button>
      </div>
      <div class="muted" style="margin-top:8px">
        Excel esperado: columnas <b>SKU</b>, <b>NOMBRE</b>, <b>PRECIO</b> (opcional: <b>STOCK</b>).
      </div>
    </div>

    <div class="footer">
      Hecho por <b>MarckBusiness</b> ‚Äî ¬© 2025 Todos los derechos reservados.
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ============================================================
   GENERADOR Etiquetas (IndexedDB)
   AJUSTE: Etiquetas 50x25mm horizontales (solo: BARCODE + NOMBRE + PRECIO)
   BARCODE m√°s fuerte para pistola
============================================================ */

const LOGIN_CODE = "363534";
const LOGIN_KEY  = "mb_labels_logged_in_v1";

const DB_NAME="generador_etiquetas_marckbusiness_v3";
const DB_VER=1;
let db;

const $=id=>document.getElementById(id);
const state={queue:[]};

function toast(msg){
  const t=$("toast");
  t.textContent=msg;
  t.classList.add("show");
  clearTimeout(toast._t);
  toast._t=setTimeout(()=>t.classList.remove("show"),2000);
}

function money(n){return "Q"+(Number(n||0)).toFixed(2); }
function norm(s){return String(s||"").trim().toLowerCase().replace(/\\s+/g," ");}

function pad5(n){return String(n).padStart(5,"0");}
function validateCode5(code){return /^\\d{5}$/.test(code);}

// ---------- Login ----------
function isLoggedIn(){ return localStorage.getItem(LOGIN_KEY)==="1"; }
function showLogin(){
  $("loginOverlay").style.display="flex";
  $("appWrap").style.display="none";
  setTimeout(()=>{ $("loginCode").focus(); }, 50);
}
function showApp(){
  $("loginOverlay").style.display="none";
  $("appWrap").style.display="block";
}
function doLogin(){
  const v = String($("loginCode").value||"").trim();
  if(v !== LOGIN_CODE){
    alert("C√≥digo incorrecto.");
    $("loginCode").focus();
    $("loginCode").select();
    return;
  }
  localStorage.setItem(LOGIN_KEY,"1");
  toast("Sesi√≥n iniciada");
  showApp();
}
function doLogout(){
  if(confirm("¬øCerrar sesi√≥n?")){
    localStorage.removeItem(LOGIN_KEY);
    toast("Sesi√≥n cerrada");
    showLogin();
  }
}

// ---------- IndexedDB ----------
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB_NAME,DB_VER);
    req.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains("products")){
        const s=d.createObjectStore("products",{keyPath:"code"});
        s.createIndex("name","nameKey",{unique:false});
      }
      if(!d.objectStoreNames.contains("meta")) d.createObjectStore("meta",{keyPath:"key"});
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
function tx(store,mode="readonly"){return db.transaction(store,mode).objectStore(store);}
function idbGet(store,key){
  return new Promise((res,rej)=>{
    const r=tx(store).get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(store,val){
  return new Promise((res,rej)=>{
    const r=tx(store,"readwrite").put(val);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbAll(store){
  return new Promise((res,rej)=>{
    const r=tx(store).getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbClear(){
  return Promise.all([
    new Promise((res,rej)=>{
      const r=db.transaction("products","readwrite").objectStore("products").clear();
      r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    }),
    new Promise((res,rej)=>{
      const r=db.transaction("meta","readwrite").objectStore("meta").clear();
      r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error);
    })
  ]);
}

async function nextCode(){
  const meta=await idbGet("meta","next");
  const n=meta?.value?Number(meta.value):1;
  await idbPut("meta",{key:"next",value:n+1});
  return pad5(n);
}

// ---------- BARCODE fuerte (para esc√°ner) ----------
function drawBarcodeToSVG(svgEl, code){
  svgEl.innerHTML="";
  if(!validateCode5(code)) return;

  try{
    JsBarcode(svgEl, code, {
      format:"CODE128",
      displayValue:false,
      margin:0,
      height:58,
      width:2.6,
      background:"#ffffff",
      lineColor:"#000000"
    });
  }catch(e){}
}

// ---------- Preview ----------
function renderPreview(){
  const code=$("pCode").value.trim()||"00000";
  const name=$("pName").value.trim()||"‚Äî";
  const price=Number($("pPrice").value||0);

  $("pvName").textContent=name;
  $("pvPrice").textContent=money(price);

  drawBarcodeToSVG($("pvBarcode"), code);
}

// ---------- Products ----------
async function saveProduct(){
  const code=$("pCode").value.trim();
  const name=$("pName").value.trim();
  const price=Number($("pPrice").value);

  // STOCK (nuevo): opcional, default 0, no altera nada m√°s
  const stock = Math.max(0, Math.floor(Number($("pStock")?.value || 0)));

  if(!validateCode5(code)) return alert("SKU inv√°lido.");
  if(!name) return alert("Nombre requerido.");
  if(isNaN(price)||price<0) return alert("Precio inv√°lido.");

  // STOCK (nuevo) guardado en el producto
  const p={code,name,price:Number(price.toFixed(2)),stock, nameKey:norm(name),updatedAt:Date.now()};
  await idbPut("products",p);

  await refreshPicker();
  $("pCode").value=await nextCode();
  $("pName").value="";
  $("pPrice").value="";
  // STOCK (nuevo) reseteo del campo
  if($("pStock")) $("pStock").value="0";

  renderPreview();
  toast("Guardado");
}

async function refreshPicker(){
  const q=norm($("qSearch").value);
  const all=await idbAll("products");
  const list=q?all.filter(p=>norm(p.code).includes(q)||(p.nameKey||"").includes(q)):all;
  const sel=$("pick");
  sel.innerHTML="";
  if(list.length===0){
    const opt=document.createElement("option");
    opt.value="";
    opt.textContent="Sin productos";
    sel.appendChild(opt);
    return;
  }
  for(const p of list.sort((a,b)=>(a.nameKey||"").localeCompare(b.nameKey||""))){
    const opt=document.createElement("option");
    opt.value=p.code;
    opt.textContent=\`\${p.code} ‚Äî \${p.name} ‚Äî \${money(p.price)}\`;
    sel.appendChild(opt);
  }
}

// ---------- Queue (localStorage) ----------
function loadQueue(){
  try{
    const q=JSON.parse(localStorage.getItem("mb_label_queue_v3")||"[]");
    if(Array.isArray(q)) state.queue=q;
  }catch{ state.queue=[]; }
}
function saveQueue(){ localStorage.setItem("mb_label_queue_v3",JSON.stringify(state.queue)); }
function renderQueue(){
  const tb=$("queueBody");
  tb.innerHTML="";
  if(state.queue.length===0){
    tb.innerHTML='<tr><td colspan="5"><small style="color:rgba(255,255,255,.6);font-weight:900">Cola vac√≠a.</small></td></tr>';
    return;
  }
  state.queue.forEach((it,idx)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=\`
      <td>\${it.code}</td>
      <td>\${it.name}</td>
      <td>\${money(it.price)}</td>
      <td>\${it.qty}</td>
      <td>
        <button class="btn small secondary" data-act="edit" data-i="\${idx}" type="button">Cant.</button>
        <button class="btn small danger" data-act="del" data-i="\${idx}" type="button">X</button>
      </td>
    \`;
    tb.appendChild(tr);
  });
}
async function addToQueue(){
  const code=$("pick").value;
  const qty=Math.max(1,Number($("qty").value||1));
  if(!code) return alert("Seleccione un producto.");
  const p=await idbGet("products",code);
  if(!p) return alert("No encontrado.");
  state.queue.push({code:p.code,name:p.name,price:p.price,qty,updatedAt:Date.now()});
  saveQueue(); renderQueue(); toast("Agregado");
}
function clearQueue(){ state.queue=[]; saveQueue(); renderQueue(); toast("Cola limpia"); }

// ---------- Barcode (PNG para PDF) ----------
function barcodeDataURL(code){
  const canvas=document.createElement("canvas");
  canvas.width=900;
  canvas.height=320;

  JsBarcode(canvas, code, {
    format:"CODE128",
    displayValue:false,
    margin:0,
    height:230,
    width:6,
    background:"#ffffff",
    lineColor:"#000000"
  });

  return canvas.toDataURL("image/png",1.0);
}

// ---------- PDF (50x25mm, horizontal, SOLO BARCODE+NOMBRE+PRECIO) ----------
async function openPDF(){
  if(state.queue.length===0) return alert("Cola vac√≠a.");

  let w = Number($("lblW")?.value || 50);
  let h = Number($("lblH")?.value || 25);
  if(!isFinite(w) || w < 20) w = 50;
  if(!isFinite(h) || h < 20) h = 25;

  let ori = $("lblOri")?.value || "landscape";
  if(ori === "AUTO"){
    ori = (w >= h) ? "landscape" : "portrait";
  }

  const pageW = w, pageH = h;

  const labels=[];
  for(const it of state.queue){
    for(let i=0;i<it.qty;i++) labels.push(it);
  }

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation: ori, unit:"mm", format:[pageW,pageH], compress:true});

  const m = 1.6;
  const quiet = 1.6;
  const nameY = 6.2;
  const barcodeTop = 7.6;

  const barcodeH = pageH - barcodeTop - 1.2;
  const barcodeW = pageW - (m*2) - (quiet*2);

  function safeText(s){ return String(s||"").replace(/\\s+/g," ").trim(); }
  function fitOneLine(doc, text, maxWidth, startSize=9.5, minSize=6.8){
    let s=startSize;
    doc.setFontSize(s);
    while(s>minSize && doc.getTextWidth(text)>maxWidth){ s-=0.2; doc.setFontSize(s); }
    if(doc.getTextWidth(text)<=maxWidth) return {size:s, text};
    doc.setFontSize(minSize);
    const ell="‚Ä¶";
    let lo=0, hi=text.length;
    while(lo<hi){
      const mid=Math.ceil((lo+hi)/2);
      const t=text.slice(0,mid)+ell;
      if(doc.getTextWidth(t)<=maxWidth) lo=mid;
      else hi=mid-1;
    }
    return {size:minSize, text:text.slice(0,lo)+ell};
  }

  for(let i=0;i<labels.length;i++){
    if(i>0) doc.addPage([pageW,pageH], ori);

    const it=labels[i];
    const name=safeText(it.name);
    const priceStr=money(it.price);

    doc.setFillColor(255,255,255);
    doc.rect(0,0,pageW,pageH,"F");

    doc.setTextColor(0,0,0);
    doc.setFont("helvetica","bold");

    const rightX = pageW - m;
    doc.setFontSize(9.2);
    const priceWtxt = doc.getTextWidth(priceStr);
    const gap = 2.2;
    const maxNameW = (rightX - priceWtxt - gap) - m;

    const fitted = fitOneLine(doc, name, Math.max(10, maxNameW), 9.2, 6.8);
    doc.setFontSize(fitted.size);
    doc.text(fitted.text || "‚Äî", m, nameY);

    doc.setFontSize(9.2);
    doc.text(priceStr, rightX, nameY, {align:"right"});

    const bx = m;
    const by = barcodeTop;
    const bw = pageW - (m*2);
    const bh = barcodeH;

    doc.setDrawColor(0,0,0);
    doc.setLineWidth(0.25);
    doc.setFillColor(255,255,255);
    doc.roundedRect(bx, by, bw, bh, 1.6, 1.6, "FD");

    const img=barcodeDataURL(it.code);
    doc.addImage(img, "PNG", bx + quiet, by + quiet, bw - (quiet*2), bh - (quiet*2));
  }

  const blobUrl=doc.output("bloburl");
  // Avisar al sistema principal para (opcional) actualizar inventario con la cantidad de etiquetas generadas
  try{ window.parent && window.parent.postMessage({type:"LABELS_PDF_DONE", queue: state.queue}, "*"); }catch(e){}
  window.open(blobUrl,"_blank");
  toast("PDF listo");
}

// ---------- Backup ----------
async function exportJSON(){
  const products=await idbAll("products");
  const meta=await idbAll("meta");

  // STOCK (nuevo): en la exportaci√≥n garantizamos stock num√©rico (0 si no existe),
  // sin afectar nada del funcionamiento actual.
  const productsOut = (products||[]).map(p => ({
    ...p,
    stock: Math.max(0, Math.floor(Number(p?.stock ?? 0)))
  }));

  const data={exportedAt:new Date().toISOString(),products:productsOut,meta,queue:state.queue};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="marckbusiness_generador_backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}
async function importExcelFile(file){
  const data=new Uint8Array(await file.arrayBuffer());
  const wb=XLSX.read(data,{type:"array"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{defval:""});
  let ok=0, bad=0;

  for(const r of rows){
    const sku=String(r.SKU ?? r.sku ?? r.CODIGO ?? r.codigo ?? r.C√≥digo ?? r.codigo_barras ?? r.CODBARRAS ?? "").trim();
    const name=String(r.NOMBRE ?? r.nombre ?? r.PRODUCTO ?? r.producto ?? "").trim();
    const priceRaw=r.PRECIO ?? r.precio ?? r.PRICE ?? r.price ?? "";
    const price=Number(String(priceRaw).replace(/[^0-9.]/g,""));

    // STOCK (nuevo): columna opcional
    const stockRaw = r.STOCK ?? r.stock ?? r.EXISTENCIA ?? r.existencia ?? "";
    const stock = Math.max(0, Math.floor(Number(String(stockRaw).replace(/[^0-9]/g,"")) || 0));

    if(!validateCode5(sku)||!name||isNaN(price)){bad++;continue;}

    await idbPut("products",{code:sku,name,price:Number(price.toFixed(2)),stock, nameKey:norm(name),updatedAt:Date.now()});
    ok++;
  }
  await refreshPicker();
  renderPreview();
  toast("Excel importado");
  if(bad>0) alert("Importados: "+ok+" | Saltados: "+bad+" (revisa columnas SKU/NOMBRE/PRECIO).");
}

// ---------- Events ----------
function wire(){
  // LOGIN
  $("btnLogin").addEventListener("click", doLogin);
  $("btnLoginClear").addEventListener("click", ()=>{ $("loginCode").value=""; $("loginCode").focus(); });
  $("loginCode").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ e.preventDefault(); doLogin(); } });
  $("btnLogout").addEventListener("click", doLogout);

  // Preview inputs
  ["pCode","pName","pPrice"].forEach(id=>$(id).addEventListener("input",renderPreview));

  // Products
  $("btnSave").addEventListener("click",saveProduct);
  $("btnClearForm").addEventListener("click",async()=>{
    $("pCode").value=await nextCode();
    $("pName").value="";
    $("pPrice").value="";
    // STOCK (nuevo)
    if($("pStock")) $("pStock").value="0";
    renderPreview();
  });
  $("btnNext").addEventListener("click",async()=>{
    $("pCode").value=await nextCode();
    $("pCode").focus();
    $("pCode").select();
    renderPreview();
  });

  // Picker/search
  $("qSearch").addEventListener("input",refreshPicker);
  $("btnRefresh").addEventListener("click",refreshPicker);

  // Queue
  $("btnAddToQueue").addEventListener("click",addToQueue);
  $("btnClearQueue").addEventListener("click",clearQueue);
  $("btnPDF").addEventListener("click",openPDF);

  $("queueBody").addEventListener("click",(e)=>{
    const b=e.target.closest("button[data-act]");
    if(!b) return;
    const i=Number(b.dataset.i);
    if(b.dataset.act==="del"){
      state.queue.splice(i,1);
      saveQueue();
      renderQueue();
    }
    if(b.dataset.act==="edit"){
      const v=prompt("Nueva cantidad:",state.queue[i].qty);
      if(v===null) return;
      state.queue[i].qty=Math.max(1,Number(v||1));
      saveQueue();
      renderQueue();
    }
  });

  // Import/export
  $("btnExcel").addEventListener("click",()=>$("excelFile").click());
  $("excelFile").addEventListener("change",async(e)=>{
    const file=e.target.files?.[0];
    if(!file) return;
    try{ await importExcelFile(file); }
    catch(err){ alert("Error importando Excel."); }
    e.target.value="";
  });
  $("btnExport").addEventListener("click",exportJSON);

  // Wipe
  $("btnWipe").addEventListener("click",async()=>{
    if(confirm("¬øBorrar todo?")){
      await idbClear();
      state.queue=[];
      saveQueue();
      await refreshPicker();
      renderQueue();
      $("pCode").value=await nextCode();
      $("pName").value="";
      $("pPrice").value="";
      // STOCK (nuevo)
      if($("pStock")) $("pStock").value="0";
      renderPreview();
    }
  });

  // Ctrl+Enter para guardar
  window.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"&&e.ctrlKey){
      e.preventDefault();
      saveProduct();
    }
  });
}

// ---------- Init ----------
(async function init(){
  if(isLoggedIn()) showApp();
  else showLogin();

  db=await openDB();

  loadQueue();
  renderQueue();

  const meta=await idbGet("meta","next");
  $("pCode").value=meta?.value?pad5(meta.value):pad5(1);

  // STOCK (nuevo): asegura valor inicial visible sin afectar nada
  if($("pStock") && ($("pStock").value==="" || $("pStock").value==null)) $("pStock").value="0";

  await refreshPicker();
  renderPreview();
  wire();
})();
<\/script>

<script>
/* ====== Integraci√≥n MTR ONLINE AP (bridge) ======
   Objetivo: usar el inventario del sistema principal SIN depender de IndexedDB dentro del iframe (origen opaco).
   - Recibe lista desde el padre
   - Normaliza campos
   - Mantiene "misma app" del generador: refreshPicker/addToQueue/etc siguen llamando idbAll/idbGet,
     pero aqu√≠ los "puenteamos" para que lean de un cache en memoria cuando el store sea "products".
*/
(function(){
  // Avisar al padre que el generador ya carg√≥
  try{ window.parent && window.parent.postMessage({type:"LABELS_READY"}, "*"); }catch(e){}

  // Cache en memoria de productos recibidos del sistema principal
  window.__MTR_PRODUCTS_CACHE__ = window.__MTR_PRODUCTS_CACHE__ || [];

  // Monkeypatch seguro (solo products)
  const __orig_idbAll = window.idbAll;
  const __orig_idbGet = window.idbGet;

  window.idbAll = async function(store){
    try{
      if(store==="products" && Array.isArray(window.__MTR_PRODUCTS_CACHE__) && window.__MTR_PRODUCTS_CACHE__.length){
        // Regresa con nameKey para que el buscador funcione
        return window.__MTR_PRODUCTS_CACHE__.map(p=>({
          code: p.code,
          name: p.name,
          price: p.price,
          stock: p.stock,
          nameKey: (typeof norm==="function"?norm(p.name):(p.name||"").toLowerCase())
        }));
      }
      if(typeof __orig_idbAll === "function") return await __orig_idbAll(store);
      return [];
    }catch(e){
      if(store==="products") return (window.__MTR_PRODUCTS_CACHE__||[]).map(p=>({
        code:p.code,name:p.name,price:p.price,stock:p.stock,
        nameKey:(typeof norm==="function"?norm(p.name):(p.name||"").toLowerCase())
      }));
      return [];
    }
  };

  window.idbGet = async function(store, key){
    try{
      if(store==="products" && Array.isArray(window.__MTR_PRODUCTS_CACHE__) && window.__MTR_PRODUCTS_CACHE__.length){
        const k = String(key??"");
        const found = window.__MTR_PRODUCTS_CACHE__.find(p=>String(p.code)===k);
        if(found) return {
          code: found.code,
          name: found.name,
          price: found.price,
          stock: found.stock,
          nameKey: (typeof norm==="function"?norm(found.name):(found.name||"").toLowerCase())
        };
        return null;
      }
      if(typeof __orig_idbGet === "function") return await __orig_idbGet(store, key);
      return null;
    }catch(e){
      if(store==="products"){
        const k = String(key??"");
        const found = (window.__MTR_PRODUCTS_CACHE__||[]).find(p=>String(p.code)===k);
        return found ? {code:found.code,name:found.name,price:found.price,stock:found.stock,nameKey:(typeof norm==="function"?norm(found.name):(found.name||"").toLowerCase())} : null;
      }
      return null;
    }
  };

  // Recibir productos del sistema principal
  window.addEventListener("message", async (ev)=>{
    try{
      const d = ev.data || {};
      if(d.type !== "MTR_PRODUCTS") return;

      const list = Array.isArray(d.products) ? d.products : [];
      const normalized = [];
      for(const p of list){
        const code = String(p.code ?? p.sku ?? p.id ?? "").trim();
        const name = String(p.name ?? p.product ?? p.descripcion ?? "").trim();
        const price = Number(p.price ?? p.precio ?? p.salePrice ?? 0);
        const stock = Math.max(0, Math.floor(Number(p.stock ?? p.exist ?? p.existencia ?? 0)));
        if(!code || !name) continue;
        normalized.push({
          code,
          name,
          price: Number((isFinite(price)?price:0).toFixed(2)),
          stock
        });
      }

      window.__MTR_PRODUCTS_CACHE__ = normalized;

      // Refrescar UI del generador
      if(typeof refreshPicker === "function") await refreshPicker();
      if(typeof renderPreview === "function") renderPreview();
      if(typeof renderQueue === "function") renderQueue();

      const el = document.getElementById("statusSync");
      if(el) el.textContent = "‚úÖ Inventario sincronizado (" + normalized.length + ")";
    }catch(err){
      console.error("Bridge error:", err);
    }
  });
})();
<\/script>

</body>
</html>`;
let __labelsLoadedMB = false;

/* === LOGO1 -> DataURL para que el iframe (srcdoc) no intente cargar file:///LOGO1.png === */
async function __mbLoadLogoDataURL__(){
  return await new Promise((resolve)=>{
    try{
      const img = new Image();
      img.onload = ()=>{
        try{
          const c = document.createElement("canvas");
          c.width = img.naturalWidth || img.width || 1;
          c.height = img.naturalHeight || img.height || 1;
          const ctx = c.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(c.toDataURL("image/png"));
        }catch(e){ resolve(null); }
      };
      img.onerror = ()=> resolve(null);
      // relativo al HTML principal
      img.src = "LOGO1.png";
    }catch(e){ resolve(null); }
  });
}

async function __mbBuildLabelsSrcdoc__(){
  let sd = __GEN_LABELS_SRCDOC__;
  const logo = await __mbLoadLogoDataURL__();
  if(logo){
    // Reemplaza solo src de LOGO1.png dentro del srcdoc
    sd = sd
      .replaceAll('src="./LOGO1.png"', `src="${logo}"`)
      .replaceAll("src='./LOGO1.png'", `src="${logo}"`)
      .replaceAll('src="LOGO1.png"', `src="${logo}"`)
      .replaceAll("src='LOGO1.png'", `src="${logo}"`);
  }
  return sd;
}

async function openLabelsModal(){
  const ov = document.getElementById("labelsOverlayMB");
  const fr = document.getElementById("labelsFrameMB");
  if(!ov || !fr) return;

  ov.classList.add("show");
  ov.setAttribute("aria-hidden","false");

  if(!__labelsLoadedMB){
    fr.srcdoc = await __mbBuildLabelsSrcdoc__();
    __labelsLoadedMB = true;
  }
  
  // Hook: asegurar que el bot√≥n azul "‚ûï Crear producto" del iframe abra el modal del sistema
  const hookCreateBtn = ()=>{
    try{
      const doc = fr.contentDocument;
      const btn = doc && doc.getElementById("mbBtnCreateProd");
      if(btn){
        btn.onclick = (e)=>{
          try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
          openGenProdModalMB(null);
          return false;
        };
      }
    }catch(e){ /* ignore cross-doc errors */ }
  };
  // En algunos navegadores, srcdoc tarda en montar el DOM
  fr.addEventListener("load", hookCreateBtn, { once:false });
  setTimeout(hookCreateBtn, 100);
  setTimeout(hookCreateBtn, 400);
  setTimeout(hookCreateBtn, 900);

// Enviar inventario (con retries) por si el iframe tarda
  sendInventoryToLabels();
  setTimeout(sendInventoryToLabels, 250);
  setTimeout(sendInventoryToLabels, 800);
}

function closeLabelsModal(){
  const ov = document.getElementById("labelsOverlayMB");
  if(!ov) return;
  ov.classList.remove("show");
  ov.setAttribute("aria-hidden","true");

}

function openInvLabelsModal(){
  const ov = document.getElementById("invLabelsOverlayMB");
  if(!ov) return;
  ov.classList.add("show");
  ov.setAttribute("aria-hidden","false");
}
function closeInvLabelsModal(){
  const ov = document.getElementById("invLabelsOverlayMB");
  if(!ov) return;
  ov.classList.remove("show");
  ov.setAttribute("aria-hidden","true");
}
async function applyInvFromLabels(){
  try{
    const list = Array.isArray(__pendingLabelsQueueMB) ? __pendingLabelsQueueMB : [];
    if(!list.length){
      closeInvLabelsModal();
      return;
    }
    // Consolidar por code
    const byCode = new Map();
    for(const it of list){
      const code = String(it.code ?? "").trim();
      const qty = Math.max(0, Math.floor(Number(it.qty ?? 0)));
      if(!code || !qty) continue;
      byCode.set(code, (byCode.get(code) || 0) + qty);
    }
    for(const [code, qty] of byCode.entries()){
      const p = await idbGet("products", code);
      if(!p) continue;
      const cur = Math.max(0, Math.floor(Number(p.stock ?? 0)));
      p.stock = cur + qty;
      await idbPut("products", p);
    }
    __pendingLabelsQueueMB = null;
    closeInvLabelsModal();
    // Refrescar vistas de inventario/productos si est√°n visibles
    try{ if(typeof renderProducts==="function") renderProducts(); }catch(e){}
    try{ if(typeof renderInventory==="function") renderInventory(); }catch(e){}
    alert("‚úÖ Inventario actualizado con las etiquetas generadas.");
  }catch(err){
    console.error(err);
    alert("‚ùå No se pudo actualizar el inventario. Revisa consola.");
  }
}

async function sendInventoryToLabels(){
  const fr = document.getElementById("labelsFrameMB");
  if(!fr || !fr.contentWindow) return;
  try{
    const products = await idbAll("products");
    const payload = (products || []).map(p=>({
      code: p.code ?? p.sku ?? p.id ?? "",
      name: p.name ?? p.product ?? p.descripcion ?? "",
      price: Number(p.price ?? p.precio ?? p.salePrice ?? 0),
      stock: Number(p.stock ?? p.exist ?? p.existencia ?? 0)
    }));
    fr.contentWindow.postMessage({type:"MTR_PRODUCTS", products: payload}, "*");
  }catch(err){
    console.error("No se pudo leer/enviar inventario:", err);
  }
}

// Handshake desde el iframe
window.addEventListener("message", (ev)=>{
  const d = ev.data || {};
  if(d.type === "LABELS_READY") sendInventoryToLabels();
});

// Recibir aviso de que se gener√≥ un PDF de etiquetas (desde el iframe)
let __pendingLabelsQueueMB = null;

window.addEventListener("message", (ev)=>{
  const d = ev.data || {};
  if(d.type !== "LABELS_PDF_DONE") return;
  // Guardar cola para aplicar al inventario si el usuario acepta
  __pendingLabelsQueueMB = Array.isArray(d.queue) ? d.queue : [];
  // Construir resumen
  const map = new Map();
  let total = 0;
  for(const it of __pendingLabelsQueueMB){
    const code = String(it.code ?? "").trim();
    const name = String(it.name ?? "").trim();
    const qty = Math.max(0, Math.floor(Number(it.qty ?? 0)));
    if(!code || !qty) continue;
    total += qty;
    const prev = map.get(code) || {code, name, qty:0};
    prev.qty += qty;
    if(!prev.name && name) prev.name = name;
    map.set(code, prev);
  }
  const lines = [];
  lines.push("Total de etiquetas: " + total);
  lines.push("");
  for(const row of map.values()){
    lines.push("‚Ä¢ " + (row.name || row.code) + "  (" + row.code + "):  +" + row.qty);
  }
  const el = document.getElementById("invLabelsSummaryMB");
  if(el) el.textContent = lines.join("\n");
  openInvLabelsModal();
});

// Cerrar con ESC
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape"){
    const ov=document.getElementById("labelsOverlayMB");
    if(ov && ov.classList.contains("show")) closeLabelsModal();
  }
});


/* ===== Crear producto (modal) desde Generador ===== */
function openGenProdModalMB(prefill){
  const ov = document.getElementById("genProdOverlayMB");
  if(!ov) return;
  // Prefill optional
  if(prefill && typeof prefill === "object"){
    if(document.getElementById("mbNewPCode")) document.getElementById("mbNewPCode").value = (prefill.code||"");
    if(document.getElementById("mbNewPName")) document.getElementById("mbNewPName").value = (prefill.name||"");
    if(document.getElementById("mbNewPPrice")) document.getElementById("mbNewPPrice").value = (prefill.price!=null?String(prefill.price):"");
    if(document.getElementById("mbNewPCost")) document.getElementById("mbNewPCost").value = (prefill.cost!=null?String(prefill.cost):"");
    if(document.getElementById("mbNewPStock")) document.getElementById("mbNewPStock").value = (prefill.stock!=null?String(prefill.stock):"0");
  }else{
    ["mbNewPCode","mbNewPName","mbNewPPrice","mbNewPCost","mbNewPStock"].forEach(id=>{
      const el=document.getElementById(id); if(el) el.value="";
    });
    const st=document.getElementById("mbNewPStock"); if(st) st.value="0";
  }
  ov.style.display="flex";
  ov.setAttribute("aria-hidden","false");
  // focus first input
  setTimeout(()=>{ const el=document.getElementById("mbNewPCode"); if(el) el.focus(); }, 30);
}
function closeGenProdModalMB(){
  const ov = document.getElementById("genProdOverlayMB");
  if(!ov) return;
  ov.style.display="none";
  ov.setAttribute("aria-hidden","true");
}
async function saveGenProductMB(){
  const code = (document.getElementById("mbNewPCode")?.value || "").trim();
  const name = (document.getElementById("mbNewPName")?.value || "").trim();
  const price = Number((document.getElementById("mbNewPPrice")?.value || "").replace(",",".")) || 0;
  const cost  = Number((document.getElementById("mbNewPCost")?.value || "").replace(",",".")) || 0;
  const stock = Number((document.getElementById("mbNewPStock")?.value || "0").replace(",",".")) || 0;

  if(!code) return alert("Ingresa un c√≥digo / SKU.");
  if(!name) return alert("Ingresa el nombre del producto.");
  if(price<=0) return alert("Ingresa un precio v√°lido.");
  // cost puede ser 0 si quieres, no lo bloqueo.
  const prod = { code, name, price, cost, stock };
  try{
    await idbPut("products", prod);
    closeGenProdModalMB();
    // refrescar inventario del generador si est√° abierto
    if(typeof sendInventoryToLabels === "function"){ 
      try{ await sendInventoryToLabels(); }catch(_e){}
    }
    toast("Producto guardado.");
  }catch(err){
    console.error(err);
    alert("No se pudo guardar el producto.");
  }
}

// Mensajes desde el iframe del generador
window.addEventListener("message", (ev)=>{
  const d = ev.data || {};
  if(d && (d.type === "MB_OPEN_CREATE_PRODUCT_MODAL" || d.type === "MTR_OPEN_CREATE_COST")){
    openGenProdModalMB(d.prefill || null);
  }
});

</script>

<audio id="saleTone" src="tono1.mp3" preload="auto"></audio>



<!-- ===== LOADING (COBRAR) ===== -->
<div id="checkoutLoading" class="ok-modal" aria-hidden="true">
  <div class="loading-card" role="dialog" aria-modal="true" aria-label="Procesando">
    <div class="loading-body">
      <div class="loading-spinner" aria-hidden="true"></div>
      <div class="loading-text">
        <b>Procesando cobro‚Ä¶</b>
        <small id="checkoutLoadingMsg">Espera un momento.</small>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL MENSAJE (OK) ===== -->
<div id="okModalOverlay" class="ok-modal">
  <div class="ok-card" role="dialog" aria-modal="true" aria-label="Mensaje">
    <div class="ok-head">
      <img src="LOGO1.png" alt="logo" class="ok-logo">
      <div>
        <div id="okModalTitle" class="ok-title">Mensaje</div>
        <div class="ok-msg" id="okModalMsg" style="margin-top:2px"></div>
      </div>
    </div>
    <div class="ok-body">
      <div class="ok-actions">
        <button id="okModalBtn" class="btn primary" type="button" onclick="closeOkModal()">Aceptar</button>
      </div>
    </div>
  </div>
</div>


<!-- ===== MODAL C√ìDIGO (EDICI√ìN) ===== -->
<div id="editCodeOverlay" class="mb-modal">
  <div class="mb-modal-card" role="dialog" aria-modal="true" aria-label="C√≥digo de acceso">
    <div class="mb-modal-head">
      <img src="LOGO1.png" alt="logo" class="mb-modal-logo">
      <div>
        <div id="editCodeTitle" class="mb-modal-title">Acceso requerido</div>
        <div id="editCodeMsg" class="mb-modal-sub">Ingrese el c√≥digo</div>
      </div>
      <button class="mb-modal-x" type="button" onclick="closeEditCodeModal()">‚úï</button>
    </div>

    <div class="mb-modal-body">
      <label style="font-size:12px;opacity:.75">C√≥digo</label>
      <input id="editCodeInput" class="mb-modal-input" type="password" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter'){confirmEditCode();}">
      <div id="editCodeErr" class="mb-modal-err"></div>

      <div class="mb-modal-actions">
        <button class="btn" type="button" onclick="confirmEditCode()">Confirmar</button>
        <button class="btn ghost" type="button" onclick="closeEditCodeModal()">Cancelar</button>
</div>

      <div class="muted" style="margin-top:8px">Se solicita una sola vez por sesi√≥n (esta pesta√±a).</div>
    </div>
  </div>
</div>


<!-- ===== Modal Generador de Etiquetas (integrado) ===== -->
<div class="ok-modal" id="labelsOverlayMB" aria-hidden="true">
  <div class="ok-card" style="width:min(980px,100%);height:min(92vh,820px);">
    <div class="ok-head">
      <img class="ok-logo" src="LOGO1.png" alt="Logo">
      <div>
        <div class="ok-title">üè∑Ô∏è Generador de Etiquetas</div>
        <div class="ok-msg" style="opacity:.85">Usa tu inventario actual del sistema (sin abrir otra pesta√±a).</div>
      </div>
      <button class="mb-modal-x" type="button" onclick="closeLabelsModal()" aria-label="Cerrar">‚úï</button>
    </div>
    
    <div class="ok-body" style="padding:0;height:calc(100% - 70px);display:flex;gap:0;">
      <iframe id="labelsFrameMB"
              title="Generador de Etiquetas"
              style="flex:1;height:100%;border:0;border-radius:0 0 0 18px;background:#0b0b0f"></iframe>
      <div style="display:none;width:min(320px,40vw);border-left:1px solid rgba(255,255,255,.08);background:rgba(10,10,18,.92);padding:14px;border-radius:0 0 18px 0;overflow:auto">
        <div style="font-weight:800;margin-bottom:10px">‚ûï Crear producto</div>
        <div class="form stack">
          <div class="field">
            <label>C√≥digo (SKU)</label>
            <input id="genPCode" placeholder="Ej: 7501234567890"/>
          </div>
          <div class="field">
            <label>Nombre</label>
            <input id="genPName" placeholder="Ej: Blusa rosa"/>
          </div>
          <div class="field">
            <label>Precio (Q)</label>
            <input id="genPPrice" type="number" min="0" step="0.01" placeholder="Ej: 125"/>
          </div>
          <div class="field">
            <label>Costo (Q)</label>
            <input id="genPCost" type="number" min="0" step="0.01" placeholder="Ej: 80"/>
          </div>
          <div class="field">
            <label>Stock</label>
            <input id="genPStock" type="number" min="0" step="1" placeholder="Ej: 10"/>
          </div>
          <button class="btn primary" id="btnGenCreateProd" type="button">Guardar en inventario</button>
          <div class="muted" style="margin-top:8px">Crea productos aqu√≠ y se cargan al inventario (con costo).</div>
        </div>
      </div>
    </div>
  </div>

<!-- ===== Modal: Actualizar inventario por etiquetas ===== -->
<div class="ok-modal" id="invLabelsOverlayMB" aria-hidden="true">
  <div class="ok-card" role="dialog" aria-modal="true" aria-label="Actualizar inventario" style="width:min(640px,100%);">
    <div class="ok-head">
      <img class="ok-logo" src="LOGO1.png" alt="Logo">
      <div>
        <div class="ok-title">üì¶ Actualizar inventario</div>
        <div class="ok-msg" style="opacity:.85">Generaste etiquetas. ¬øQuieres cargar esas unidades al inventario?</div>
      </div>
      <button class="mb-modal-x" type="button" onclick="closeInvLabelsModal()" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="ok-body">
      <div id="invLabelsSummaryMB" class="muted" style="white-space:pre-wrap"></div>
      <div class="muted" style="margin-top:10px">Esto <b>sumar√°</b> la cantidad de etiquetas al <b>stock</b> de cada producto.</div>
      <div class="mb-modal-actions" style="margin-top:14px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
        <button class="btn ghost" type="button" onclick="closeInvLabelsModal()">No</button>
        <button class="btn" type="button" onclick="applyInvFromLabels()">S√≠, cargar al inventario</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
