<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>MYT ONLINE ATLANTIC PLAZA</title>

  <!-- libs for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#fff4fb;
      --panel:#ffffff;
      --panel2:rgba(255,255,255,.78);
      --text:#241b2a;
      --muted:#7a6b78;

      --pink:#ff4fb7;
      --purple:#a855f7;
      --rose:#fb7185;

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --border:rgba(36, 20, 40, .10);
      --shadow: 0 16px 40px rgba(20, 10, 25, .10);
      --shadow2: 0 10px 26px rgba(20, 10, 25, .07);

      --radius: 22px;
      --radius2: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;

      --focus: 0 0 0 4px rgba(255,79,183,.15);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      overflow-x:hidden;

      background:
        radial-gradient(900px 650px at 18% 8%, rgba(255,79,183,.20), transparent 55%),
        radial-gradient(800px 520px at 85% 5%, rgba(168,85,247,.20), transparent 60%),
        radial-gradient(700px 520px at 70% 90%, rgba(251,113,133,.16), transparent 55%),
        var(--bg);
    }

    /* subtle floating sparkles */
    .sparkle{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.35;
      mix-blend-mode:multiply;
      background-image:
        radial-gradient(circle at 12% 18%, rgba(255,79,183,.22) 0 2px, transparent 3px),
        radial-gradient(circle at 84% 22%, rgba(168,85,247,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 78%, rgba(251,113,133,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 28% 72%, rgba(255,79,183,.14) 0 2px, transparent 3px);
      animation: drift 12s ease-in-out infinite alternate;
      filter: blur(.2px);
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) scale(1); }
      to{ transform: translate3d(-10px, 8px, 0) scale(1.02); }
    }

    .app{
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }

    /* Sidebar */
    .sidebar{
      position: sticky;
      top: 14px;
      align-self: start;
      height: calc(100vh - 28px);
      background: linear-gradient(180deg, rgba(255,255,255,.92) 0%, rgba(255,247,252,.92) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;

      animation: pop .35s ease-out both;
    }
    @keyframes pop{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .brand h1{
      font-size: 15px;
      margin:0;
      line-height:1.15;
      letter-spacing:.2px;
      font-weight: 1000;
    }
    .brand small{display:block;color:var(--muted); font-weight:800; margin-top:2px}

    .hamburger{
      width:42px;height:42px;border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(17,10,20,.07);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .hamburger:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(17,10,20,.10); }
    .hamburger:active{ transform: translateY(0); }
    .burger{ width:18px;height:12px; position:relative; }
    .burger span{
      position:absolute; left:0; right:0;
      height:2px; border-radius:999px;
      background: linear-gradient(90deg, var(--pink), var(--purple));
    }
    .burger span:nth-child(1){top:0}
    .burger span:nth-child(2){top:5px}
    .burger span:nth-child(3){bottom:0}

    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: var(--shadow2);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(20,10,25,.09);
    }
    .nav button .tag{
      font-weight:1000;
      font-size:12px;
      padding: 4px 10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,79,183,.14), rgba(168,85,247,.14));
      color: #7b2fb4;
      border:1px solid rgba(168,85,247,.18);
      white-space:nowrap;
    }
    .nav button.active{
      border-color: rgba(255,79,183,.55);
      box-shadow: 0 18px 34px rgba(255,79,183,.18);
      background: linear-gradient(180deg, #fff 0%, #fff1fa 100%);
    }

    .sidecard{
      margin-top:14px;
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,79,183,.38);
      background: rgba(255,255,255,.84);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      color:#7b2fb4;
      background: rgba(168,85,247,.12);
      border:1px solid rgba(168,85,247,.25);
      padding: 6px 10px;
      border-radius:999px;
    }
    .sidecard .row{
      display:flex; justify-content:space-between; gap:10px; margin:8px 0;
      color:var(--muted); font-weight:800;
    }
    .sidecard .row b{color:var(--text)}

    /* Main */
    .main{
      min-height: calc(100vh - 36px);
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: visible; /* key: don't cut the right card */
      animation: pop .35s ease-out both;
      max-width:100%;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 6px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 14px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h2{margin:0;font-size:18px}
    .title p{margin:0;color:var(--muted);font-weight:800;font-size:13px}

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      border:none;
      cursor:pointer;
      font-weight:1000;
      padding: 11px 14px;
      border-radius: 16px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow: 0 10px 22px rgba(17,10,20,.06);
      color:var(--text);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 16px 30px rgba(17,10,20,.09); }
    .btn:active{ transform: translateY(0); }
    .btn.small{ padding:9px 12px; border-radius:14px; font-weight:1000; }

    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--purple));
      color:white;
      border:none;
      box-shadow: 0 16px 34px rgba(255,79,183,.26);
    }
    .btn.ok{
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(34,197,94,.22);
    }
    .btn.danger{
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(239,68,68,.22);
    }

    /* Key: minmax(0,...) prevents horizontal overflow from inputs/selects */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap: 14px;
      margin-top: 14px;
    }

    .card, .field, .rowflex, .table{ min-width:0; }

    .card{
      background: rgba(255,255,255,.90);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
      position:relative;
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      opacity:0;
      border-radius: calc(var(--radius) + 2px);
      background: radial-gradient(700px 180px at 20% 0%, rgba(255,79,183,.12), transparent 50%),
                  radial-gradient(700px 180px at 80% 0%, rgba(168,85,247,.12), transparent 50%);
      transition: opacity .22s ease;
    }
    .card:hover::after{ opacity:1; }

    .card h3{margin:0 0 10px 0; font-size:15px; font-weight:1000}
    .muted{color:var(--muted); font-weight:800; font-size:13px}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .field input, .field select, .field textarea{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-weight:900;
      color:var(--text);
      min-width:0;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(255,79,183,.55);
      box-shadow: var(--focus);
    }

    .field.full{grid-column:1 / -1}

    .rowflex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .rowflex .grow{ flex:1; }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-weight:900;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      background: rgba(255,79,183,.09);
      color:#6b1f5b;
    }
    .table td small{color:var(--muted); font-weight:900}
    .table tr:last-child td{border-bottom:none}

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      padding:12px;
      border-radius: var(--radius2);
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(17,10,20,.05);
    }
    .kpi .label{ color:var(--muted); font-weight:1000; font-size:12px }
    .kpi .value{ font-size:18px; font-weight:1100; margin-top:4px }
    .kpi .value span{ font-size:12px; color:var(--muted); font-weight:1000 }

    .hide{ display:none !important; }

    /* Receipt */
    .receiptWrap{ display:flex; gap:12px; flex-wrap:wrap; }
    .receipt{
      width: 360px;
      background: #ffffff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 34px rgba(0,0,0,.11);
      transform-origin: top center;
      animation: floatIn .35s ease-out both;
    }
    @keyframes floatIn{
      from{ transform: translateY(10px) scale(.98); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .receipt .logo{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      margin-bottom:10px;
    }
    .receipt .logo b{ font-size:14px; letter-spacing:.3px; }
    .receipt .logo small{ display:block; color:#666; font-weight:900 }
    .receipt .line{ display:flex; justify-content:space-between; gap:10px; font-weight:1000; font-size:12px; margin:6px 0 }
    .receipt .hr{ height:1px; background:rgba(0,0,0,.08); margin:10px 0 }
    .receipt .big{ font-size:16px; font-weight:1200; display:flex; justify-content:space-between; margin-top:10px; }
    .receipt .foot{ margin-top:10px; font-size:11px; color:#666; font-weight:900 }

    /* Responsive */
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .receipt{ width:100%; }
    }
  </style>
</head>
<body>
  <div class="sparkle"></div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div>
          <h1>MYT ONLINE <small>ATLANTIC PLAZA</small></h1>
        </div>
        <button class="hamburger" id="btnToggle" title="Men√∫">
          <div class="burger"><span></span><span></span><span></span></div>
        </button>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="pos"><span>üßæ Cobro (POS)</span><span class="tag">VENTA</span></button>
        <button data-view="clients"><span>üë©‚Äçüíº Clientes</span><span class="tag">DB</span></button>
        <button data-view="reports"><span>üìä Reportes</span><span class="tag">D/W/M</span></button>
        <button data-view="products"><span>üß∑ Productos</span><span class="tag">SKU</span></button>
        <button data-view="inventory"><span>üì¶ Inventarios</span><span class="tag">STOCK</span></button>
        <button data-view="close"><span>üßæ Cierre</span><span class="tag">TURNO</span></button>
        <button data-view="settings"><span>‚öôÔ∏è Ajustes</span><span class="tag">LOCAL</span></button>
      </div>

      <div class="sidecard">
        <div class="pill">üíó TUS VENTAS HOY</div>
        <div class="row"><span>Clientes</span><b id="kClients">0</b></div>
        <div class="row"><span>Productos</span><b id="kProducts">0</b></div>
        <div class="row"><span>Ventas (hoy)</span><b id="kSalesToday">0</b></div>
        <div class="row"><span>Total (hoy)</span><b id="kTotalToday">Q0.00</b></div>
        <div class="muted" style="margin-top:10px">
          Tip: usa <b>Escanear</b> y pasa el lector. (F2 enfoca el campo)
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="viewTitle">DASH PRINCIPAL</h2>
          <p id="viewSub">Soporte tecnico tel: 58140-621</p>
        </div>
        <div class="actions">
          <button class="btn small" id="btnBackup">Exportar JSON</button>
          <button class="btn small" id="btnRestore">Importar JSON</button>
          <button class="btn danger small" id="btnWipe">Borrar Todo</button>
        </div>
      </div>

      <!-- POS VIEW -->
      <section id="view-pos">
        <div class="grid">
          <div class="card">
            <h3>üßæ Venta</h3>

            <div class="form" style="margin-bottom:10px">
              <div class="field full">
                <label>Escanear c√≥digo de barras (SKU / C√≥digo)</label>
                <div class="rowflex">
                  <input id="scanInput" class="grow" inputmode="text" placeholder="ESCANEE EL CODIGO DE BARRAS" />
                  <button class="btn primary" id="btnScan">Escanear</button>
                </div>
                <div class="muted">.</div>
              </div>

              <div class="field">
                <label>Cantidad</label>
                <input id="qtyInput" type="number" min="1" value="1"/>
              </div>
              <div class="field">
                <label>Buscar producto (por nombre)</label>
                <input id="productSearch" placeholder="Ej: blusa, jeans..." />
              </div>

              <div class="field full">
                <label>Productos encontrados</label>
                <div class="rowflex">
                  <select id="productPicker" class="grow"></select>
                  <button class="btn" id="btnAddPicked">Agregar</button>
                </div>
              </div>
            </div>

            <table class="table" id="cartTable">
              <thead>
                <tr>
                  <th style="width:70px">Cant</th>
                  <th>Producto</th>
                  <th style="width:110px">Precio</th>
                  <th style="width:110px">Total</th>
                  <th style="width:110px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>

            <div class="totals">
              <div class="kpi">
                <div class="label">Subtotal</div>
                <div class="value" id="subTotal">Q0.00</div>
              </div>
              <div class="kpi">
                <div class="label">Descuento</div>
                <div class="value" id="discTotal">Q0.00</div>
              </div>
              <div class="kpi">
                <div class="label">Total</div>
                <div class="value" id="grandTotal">Q0.00 <span>(Q)</span></div>
              </div>
            </div>

            <div class="form" style="margin-top:14px">
              <div class="field">
                <label>Tipo de descuento</label>
                <select id="discType">
                  <option value="NONE">Sin descuento</option>
                  <option value="Q">Q (monto)</option>
                  <option value="PCT">% (porcentaje)</option>
                </select>
              </div>
              <div class="field">
                <label>Valor</label>
                <input id="discValue" type="number" min="0" step="0.01" value="0"/>
              </div>
              <div class="field">
                <label>Aplicar</label>
                <div class="rowflex">
                  <button class="btn" id="btnApplyDisc">Aplicar</button>
                  <button class="btn danger" id="btnClearDisc">Quitar</button>
                </div>
              </div>
            </div>

            <div class="rowflex" style="margin-top:12px">
              <button class="btn" id="btnClearCart">Limpiar</button>
              <button class="btn ok" id="btnCheckout">Cobrar</button>
            </div>

            <div class="muted" style="margin-top:10px">
              *Si eliges <b>ENV√çO</b>, es obligatorio registrar/buscar cliente por tel√©fono.
            </div>
          </div>

          <div class="card">
            <h3>üí≥ Pago + Cliente</h3>

            <div class="form">
              <div class="field">
                <label>Forma de pago</label>
                <select id="payMethod">
                  <option value="EFECTIVO">EFECTIVO</option>
                  <option value="TARJETA">TARJETA</option>
                  <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                </select>
              </div>

              <div class="field">
                <label>Tipo de venta</label>
                <select id="saleType">
                  <option value="MOSTRADOR">MOSTRADOR</option>
                  <option value="ENVIO">ENV√çO</option>
                </select>
              </div>

              <div class="field full">
                <label>Tel√©fono (para buscar/crear cliente)</label>
                <div class="rowflex">
                  <input id="cPhone" class="grow" placeholder="Ej: 5555-5555" />
                  <button class="btn" id="btnFindClient">Buscar</button>
                </div>
                <div class="muted">En <b>ENV√çO</b> es obligatorio tener cliente.</div>
              </div>

              <div class="field">
                <label>Nombres</label>
                <input id="cNames" placeholder="Ej: Karina"/>
              </div>
              <div class="field">
                <label>Apellidos</label>
                <input id="cLast" placeholder="Ej: L√≥pez"/>
              </div>

              <div class="field full">
                <label>Direcci√≥n</label>
                <textarea id="cAddr" rows="3" placeholder="Ej: Col. X, casa #, zona..., referencias..."></textarea>
              </div>

              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveClient">Guardar cliente</button>
                  <button class="btn" id="btnUseWalkIn">Venta sin cliente</button>
                </div>
                <div class="muted">‚ÄúVenta sin cliente‚Äù solo aplica para MOSTRADOR.</div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üßæ Comprobante</h3>
              <div class="rowflex">
                <button class="btn" id="btnCopyReceipt">Copiar texto</button>
                <button class="btn" id="btnPDF">PDF</button>
                <button class="btn" id="btnDownloadReceipt">PNG</button>
                <button class="btn primary" id="btnWhatsApp">WhatsApp</button>
              </div>
              <div class="muted" style="margin-top:10px">
                PDF abre impresi√≥n (Guardar como PDF). WhatsApp abre texto listo.
              </div>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="receiptBox">
                <div class="logo">
                  <div>
                    <b id="rShop">Tienda de Ropa</b>
                    <small id="rMeta">Recibo ‚Ä¢ Offline</small>
                  </div>
                  <div style="text-align:right">
                    <b id="rNo">#000001</b>
                    <small id="rDate">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Cliente</span><span id="rClient">MOSTRADOR</span></div>
                <div class="line"><span>Tel√©fono</span><span id="rPhone">‚Äî</span></div>
                <div class="line"><span>Direcci√≥n</span><span id="rAddr">‚Äî</span></div>
                <div class="hr"></div>

                <div id="rItems"></div>

                <div class="hr"></div>
                <div class="line"><span>Pago</span><span id="rPay">EFECTIVO</span></div>
                <div class="line"><span>Subtotal</span><span id="rSub">Q0.00</span></div>
                <div class="line"><span>Descuento</span><span id="rDisc">Q0.00</span></div>
                <div class="big"><span>Total</span><span id="rTotal">Q0.00</span></div>
                <div class="foot">¬°Gracias por tu compra! üíó</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- CLIENTS VIEW -->
      <section id="view-clients" class="hide">
        <div class="card">
          <h3>üë©‚Äçüíº Clientes (base de datos local)</h3>
          <div class="rowflex">
            <input id="clientSearch" class="grow" placeholder="Buscar por tel√©fono o nombre..."/>
            <button class="btn" id="btnClientRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Tel√©fono es el identificador. Se guarda en tu navegador (IndexedDB).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Tel√©fono</th>
                  <th>Nombre</th>
                  <th>Direcci√≥n</th>
                  <th style="width:140px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="clientsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS VIEW -->
      <section id="view-reports" class="hide">
        <div class="card">
          <h3>üìä Reportes (Diario / Semanal / Mensual)</h3>

          <div class="rowflex">
            <button class="btn" id="btnRepDaily">Hoy</button>
            <button class="btn" id="btnRepWeekly">Semana</button>
            <button class="btn" id="btnRepMonthly">Mes</button>
          </div>

          <div class="totals" style="margin-top:12px">
            <div class="kpi">
              <div class="label">Ventas</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="kpi">
              <div class="label">Total</div>
              <div class="value" id="repTotal">Q0.00</div>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th style="width:160px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUCTS VIEW -->
      <section id="view-products" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üß∑ Productos (SKU / C√≥digo)</h3>
            <div class="form">
              <div class="field">
                <label>C√≥digo (SKU / Barras)</label>
                <input id="pCode" placeholder="Ej: 7501234567890"/>
              </div>
              <div class="field">
                <label>Nombre</label>
                <input id="pName" placeholder="Ej: Blusa rosa"/>
              </div>
              <div class="field">
                <label>Precio (Q)</label>
                <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ej: 125"/>
              </div>
              <div class="field">
                <label>Stock</label>
                <input id="pStock" type="number" min="0" step="1" placeholder="Ej: 10"/>
              </div>
              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveProduct">Guardar producto</button>
                  <button class="btn" id="btnSeedDemo">Cargar demo</button>
                </div>
                <div class="muted">Puedes agregar manual o usar una lista demo para probar el lector.</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üì¶ Lista de productos</h3>
            <div class="rowflex">
              <input id="prodSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
              <button class="btn" id="btnProdRefresh">Refrescar</button>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>C√≥digo</th>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th style="width:140px">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="productsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS VIEW -->
      
      <!-- INVENTORY VIEW (read-only stock) -->
      <section id="view-inventory" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üì¶ Inventarios</h3>
            <p class="muted" style="margin-top:-6px">Tabla de stock actual (se descuenta autom√°ticamente al cobrar).</p>

            <div class="rowflex" style="margin:12px 0">
              <input id="invSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..." />
              <button class="btn" id="btnInvRefresh">Refrescar</button>
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th style="width:160px">C√≥digo</th>
                  <th>Producto</th>
                  <th style="width:120px">Precio</th>
                  <th style="width:110px">Stock</th>
                </tr>
              </thead>
              <tbody id="invBody"></tbody>
            </table>
          </div>

          <div class="card">
            <h3>üìù Nota</h3>
            <div class="muted">
              Si deseas editar productos (precio/stock), usa el m√≥dulo <b>Productos</b>.
              Este m√≥dulo es solo para visualizar inventario.
            </div>
          </div>
        </div>
      </section>

      <!-- CLOSE SHIFT VIEW -->
      <section id="view-close" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üßæ Cierre de turno / d√≠a</h3>
            <p class="muted" style="margin-top:-6px">Genera un ticket digital con resumen de ventas, pagos, descuentos, env√≠os y productos vendidos.</p>

            <div class="form" style="margin-top:12px">
              <div class="field">
                <label>Fecha del cierre</label>
                <input id="closeDate" type="date"/>
              </div>
              <div class="field">
                <label>Nombre del turno (opcional)</label>
                <input id="closeShift" placeholder="Ej: Turno ma√±ana / Caja 1 / Juan" />
              </div>
              <div class="field full">
                <label>Acciones</label>
                <div class="rowflex">
                  <button class="btn primary" id="btnBuildClose">Generar cierre</button>
                  <button class="btn" id="btnCloseCopy">Copiar texto</button>
                  <button class="btn" id="btnClosePDF">PDF</button>
                  <button class="btn" id="btnClosePNG">PNG</button>
                  <button class="btn" id="btnCloseWA">WhatsApp</button>
                </div>
              </div>
            </div>

            <div class="receipt" id="closeBox" style="max-width:520px">
              <div class="head">
                <div class="h1" id="cShop">Cierre</div>
                <div class="meta" id="cMeta">‚Äî</div>
              </div>
              <div class="hr"></div>
              <div class="row"><span>Fecha</span><b id="cDate">‚Äî</b></div>
              <div class="row"><span>Turno</span><b id="cShift">‚Äî</b></div>
              <div class="hr"></div>

              <div class="row"><span>Ventas</span><b id="cSales">0</b></div>
              <div class="row"><span>Total vendido</span><b id="cTotal">Q0.00</b></div>
              <div class="row"><span>Descuentos</span><b id="cDisc">Q0.00</b></div>

              <div class="hr"></div>
              <div class="pill" style="margin-bottom:8px">üí≥ Formas de pago</div>
              <div id="cPays"></div>

              <div class="hr"></div>
              <div class="pill" style="margin-bottom:8px">üöö Env√≠os y mostrador</div>
              <div class="row"><span>Env√≠os</span><b id="cShip">0</b></div>
              <div class="row"><span>Mostrador</span><b id="cDesk">0</b></div>

              <div class="hr"></div>
              <div class="pill" style="margin-bottom:8px">üß∑ Productos vendidos</div>
              <div id="cItems"></div>

              <div class="foot">Generado por sistema offline ‚Ä¢ Marck Business</div>
            </div>
          </div>

          <div class="card">
            <h3>üìú Historial del d√≠a</h3>
            <p class="muted" style="margin-top:-6px">Lista de ventas de la fecha elegida (para revisar ticket por ticket).</p>
            <div class="rowflex" style="margin:12px 0">
              <button class="btn" id="btnCloseLoadHistory">Cargar historial</button>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>Hora / #</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="closeHistBody"></tbody>
            </table>
          </div>
        </div>
      </section>


      <section id="view-settings" class="hide">
        <div class="card">
          <h3>‚öôÔ∏è Ajustes</h3>

          <div class="form">
            <div class="field full">
              <label>Nombre de la tienda (sale en el recibo)</label>
              <input id="sShopName" placeholder="Ej: Boutique Karina"/>
            </div>

            <div class="field">
              <label>Auto PDF al cobrar</label>
              <select id="sAutoPDF">
                <option value="1">S√≠</option>
                <option value="0">No</option>
              </select>
            </div>
            <div class="field">
              <label>Auto PNG al cobrar</label>
              <select id="sAutoPNG">
                <option value="1">S√≠</option>
                <option value="0">No</option>
              </select>
            </div>

            <div class="field full">
              <button class="btn primary" id="btnSaveSettings">Guardar</button>
            </div>
          </div>

          <div class="muted" style="margin-top:10px">
            Nota: todo se guarda en tu navegador. Si cambias de PC/navegador, exporta e importa el JSON.
          </div>
        </div>
      </section>

      <input type="file" id="restoreFile" accept="application/json" class="hide"/>
      <canvas id="cnv" class="hide"></canvas>
    </main>
  </div>

<script>
/* ============================================================
   POS Boutique Offline (IndexedDB)
   - Fix: PDF generator does NOT embed <\/script> in template strings
============================================================ */

const DB_NAME = "pos_boutique_offline_v1";
const DB_VER = 1;
let db;

const state = {
  view: "pos",
  cart: [],
  discount: { type:"NONE", value:0 }, // type: NONE | Q | PCT
  selectedClient: null,
  lastReceipt: null,
  lastClose: null,
  settings: { shopName: "Tienda de Ropa", autoPDF:true, autoPNG:true }
};

const $ = (id)=>document.getElementById(id);
const money = (n)=> "Q" + (Number(n||0)).toFixed(2);

// ---------- Debug (helps detect why buttons stop) ----------
window.addEventListener("error", (e)=>{
  console.error(e.error || e.message);
});
window.addEventListener("unhandledrejection", (e)=>{
  console.error(e.reason);
});

// ---------- IndexedDB ----------
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;

      if(!db.objectStoreNames.contains("clients")){
        const s = db.createObjectStore("clients", { keyPath:"phone" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("products")){
        const s = db.createObjectStore("products", { keyPath:"code" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("sales")){
        const s = db.createObjectStore("sales", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
      }
      if(!db.objectStoreNames.contains("meta")){
        db.createObjectStore("meta", { keyPath:"key" });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}

function tx(store, mode="readonly"){
  return db.transaction(store, mode).objectStore(store);
}
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store).get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(store, val){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").put(val);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbDel(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").delete(key);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbAll(store){
  return new Promise((res,rej)=>{
    const r = tx(store).getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbClearAll(){
  return Promise.all([
    new Promise((res,rej)=>{ const r=db.transaction("clients","readwrite").objectStore("clients").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("products","readwrite").objectStore("products").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("sales","readwrite").objectStore("sales").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("meta","readwrite").objectStore("meta").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
  ]);
}

// ---------- Helpers ----------
function todayKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function weekKey(ts=Date.now()){
  const d = new Date(ts);
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = tmp.getUTCDay() || 7;
  tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
  return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}
function monthKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normKey(s){
  return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
}
function pad(n,len=6){ return String(n).padStart(len,"0"); }

// ---------- UI Nav ----------
const views = {
  pos: {title:"Cobro (POS)", sub:""},
  clients: {title:"Clientes", sub:"Busca por tel√©fono, edita y usa para env√≠os."},
  reports: {title:"Reportes", sub:"Diario / Semanal / Mensual con historial de ventas."},
  products: {title:"Productos", sub:"Agrega productos con c√≥digo, nombre, precio y stock."},
  inventory: {title:"Inventarios", sub:"Stock actual de productos (solo vista)."},
  close: {title:"Cierre", sub:"Resumen del turno / d√≠a con ticket digital."},
  settings: {title:"Ajustes", sub:"Nombre de tienda y respaldos (exportar/importar)."}
};

function setView(v){
  state.view = v;
  $("viewTitle").textContent = views[v].title;
  $("viewSub").textContent = views[v].sub;

  for(const k of Object.keys(views)){
    $("view-"+k).classList.toggle("hide", k!==v);
  }
  [...document.querySelectorAll(".nav button")].forEach(b=>{
    b.classList.toggle("active", b.dataset.view===v);
  });

  if(v==="clients") renderClients();
  if(v==="products") { renderProducts(); refreshProductPicker(); }
  if(v==="inventory") renderInventory();
  if(v==="close") { initCloseView(); }
  if(v==="reports") renderReport("daily");
}


// ---------- Inventory (view-only) ----------
async function renderInventory(){
  const q = normKey($("invSearch")?.value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q) || normKey(p.name).includes(q)) : all;

  const tb = $("invBody");
  if(!tb) return;
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${escapeHtml(p.code)}</b></td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td><b>${Number(p.stock||0)}</b></td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Close shift/day ----------
function initCloseView(){
  const d = $("closeDate");
  if(d && !d.value) d.value = todayKey();
  // Build once on enter
  buildClose();
}

async function buildClose(){
  const dk = $("closeDate").value || todayKey();
  const shift = ($("closeShift").value||"").trim();
  const all = await idbAll("sales");
  const list = all.filter(s=>s.dateKey===dk).sort((a,b)=>a.ts-b.ts);

  const byPay = {EFECTIVO:0, TARJETA:0, TRANSFERENCIA:0};
  let discTotal = 0;
  let total = 0;
  let ship = 0, desk = 0;

  const prodMap = new Map(); // code -> {name, qty, total}
  for(const s of list){
    total += Number(s.total||0);
    discTotal += Number(s.discountAmount||0);
    if((s.saleType||"").toUpperCase()==="ENVIO") ship++; else desk++;

    const pay = (s.payMethod||"").toUpperCase();
    if(byPay[pay]!==undefined) byPay[pay]+=Number(s.total||0);

    for(const it of (s.items||[])){
      const key = it.code || it.name;
      const prev = prodMap.get(key) || { code: it.code||"", name: it.name||"", qty:0, total:0 };
      prev.qty += Number(it.qty||0);
      prev.total += Number(it.qty||0) * Number(it.price||0);
      prodMap.set(key, prev);
    }
  }

  const items = [...prodMap.values()].sort((a,b)=>b.total-a.total);

  const summary = {
    shop: state.settings.shopName || "Tienda",
    dateKey: dk,
    shift: shift || "‚Äî",
    salesCount: list.length,
    total: Number(total.toFixed(2)),
    discountTotal: Number(discTotal.toFixed(2)),
    byPay: Object.fromEntries(Object.entries(byPay).map(([k,v])=>[k, Number(v.toFixed(2))])),
    ship, desk,
    items
  };

  state.lastClose = summary;
  updateClosePreview(summary);
  renderCloseHistory(list);
}

function updateClosePreview(c){
  if(!c) return;
  $("cShop").textContent = c.shop;
  $("cMeta").textContent = "Cierre ‚Ä¢ " + c.dateKey;
  $("cDate").textContent = c.dateKey;
  $("cShift").textContent = c.shift || "‚Äî";
  $("cSales").textContent = String(c.salesCount||0);
  $("cTotal").textContent = money(c.total||0);
  $("cDisc").textContent = money(c.discountTotal||0);
  $("cShip").textContent = String(c.ship||0);
  $("cDesk").textContent = String(c.desk||0);

  const pays = $("cPays");
  pays.innerHTML = "";
  for(const [k,v] of Object.entries(c.byPay||{})){
    const line = document.createElement("div");
    line.className="row";
    line.innerHTML = `<span>${escapeHtml(k)}</span><b>${money(v)}</b>`;
    pays.appendChild(line);
  }

  const items = $("cItems");
  items.innerHTML = "";
  const top = (c.items||[]).slice(0, 30);
  for(const it of top){
    const div = document.createElement("div");
    div.className="row";
    div.innerHTML = `<span>${it.qty} x ${escapeHtml(it.name)}</span><b>${money(it.total)}</b>`;
    items.appendChild(div);
  }
}

function closeToText(c){
  if(!c) return "No hay cierre generado.";
  const lines = [];
  lines.push(`üßæ *CIERRE ‚Äî ${c.shop}*`);
  lines.push(`Fecha: ${c.dateKey}`);
  lines.push(`Turno: ${c.shift||"‚Äî"}`);
  lines.push(`--------------------------------`);
  lines.push(`Ventas: ${c.salesCount}`);
  lines.push(`Total vendido: *${money(c.total)}*`);
  lines.push(`Descuentos: ${money(c.discountTotal)}`);
  lines.push(`--------------------------------`);
  lines.push(`üí≥ Pagos:`);
  for(const [k,v] of Object.entries(c.byPay||{})){
    lines.push(`- ${k}: ${money(v)}`);
  }
  lines.push(`--------------------------------`);
  lines.push(`üöö Env√≠os: ${c.ship} | Mostrador: ${c.desk}`);
  lines.push(`--------------------------------`);
  lines.push(`üß∑ Productos vendidos (top):`);
  (c.items||[]).slice(0,20).forEach(it=>{
    lines.push(`- ${it.qty} x ${it.name} = ${money(it.total)}`);
  });
  return lines.join("\n");
}

function closeToPrintableHTML(c){
  const pays = Object.entries(c.byPay||{}).map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td style="text-align:right">${money(v)}</td></tr>`).join("");
  const items = (c.items||[]).slice(0,40).map(it=>`<tr><td style="text-align:center">${it.qty}</td><td>${escapeHtml(it.name)}</td><td style="text-align:right">${money(it.total)}</td></tr>`).join("");

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Cierre ${escapeHtml(c.shop)} ${escapeHtml(c.dateKey)}</title>
    <style>
      body{ font-family: Arial, Helvetica, sans-serif; padding:20px; }
      .box{ max-width:520px; margin:auto; border:1px solid #ddd; border-radius:14px; padding:16px; }
      h1{ margin:0 0 6px; font-size:18px; }
      .muted{ color:#666; font-size:12px; }
      table{ width:100%; border-collapse:collapse; margin-top:10px; }
      td,th{ border-top:1px solid #eee; padding:6px 4px; font-size:12px; }
      .hr{ height:1px; background:#eee; margin:10px 0; }
      .big{ font-size:14px; font-weight:700; display:flex; justify-content:space-between; }
    </style>
  </head>
  <body>
    <div class="box">
      <h1>CIERRE ‚Äî ${escapeHtml(c.shop)}</h1>
      <div class="muted">Fecha: ${escapeHtml(c.dateKey)} ‚Ä¢ Turno: ${escapeHtml(c.shift||"‚Äî")}</div>
      <div class="hr"></div>
      <div class="big"><span>Ventas</span><span>${c.salesCount}</span></div>
      <div class="big"><span>Total vendido</span><span>${money(c.total)}</span></div>
      <div class="big"><span>Descuentos</span><span>${money(c.discountTotal)}</span></div>

      <div class="hr"></div>
      <div class="muted"><b>Formas de pago</b></div>
      <table>${pays}</table>

      <div class="hr"></div>
      <div class="muted"><b>Env√≠os / Mostrador</b></div>
      <table>
        <tr><td>Env√≠os</td><td style="text-align:right">${c.ship}</td></tr>
        <tr><td>Mostrador</td><td style="text-align:right">${c.desk}</td></tr>
      </table>

      <div class="hr"></div>
      <div class="muted"><b>Productos vendidos</b></div>
      <table>
        <tr><th style="width:70px">Cant</th><th>Producto</th><th style="width:120px;text-align:right">Total</th></tr>
        ${items}
      </table>


    </div>
  </body>
  </html>
  `;
}

async function copyClose(){
  const text = closeToText(state.lastClose);
  try{
    await navigator.clipboard.writeText(text);
    alert("Cierre copiado.");
  }catch{
    alert("No se pudo copiar autom√°ticamente.");
  }
}
function openCloseWhatsApp(){
  const text = closeToText(state.lastClose);
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
}
function generateClosePDF(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const html = closeToPrintableHTML(state.lastClose);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para PDF.");
  w.document.open(); w.document.write(html); w.document.close();
}
async function downloadClosePNG(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const node = $("closeBox");
  if(!node) return;
  try{
    const canvas = await html2canvas(node, {backgroundColor:"#ffffff", scale:2});
    canvas.toBlob((blob)=>{
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `cierre_${state.lastClose.dateKey}.png`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }, "image/png");
  }catch(err){
    alert("No se pudo generar PNG. Intenta con PDF.");
  }
}

function renderCloseHistory(list){
  const tb = $("closeHistBody");
  if(!tb) return;
  tb.innerHTML = "";
  for(const s of list.slice().reverse()){
    const tr = document.createElement("tr");
    const when = new Date(s.ts).toLocaleTimeString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td><b>${money(s.total||0)}</b></td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Cart ----------
function renderCart(){
  const body = $("cartBody");
  body.innerHTML = "";

  let subtotal = 0;
  for(const item of state.cart){
    const line = item.qty * item.price;
    subtotal += line;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.qty}</td>
      <td>${escapeHtml(item.name)}<br><small>${escapeHtml(item.code)}</small></td>
      <td>${money(item.price)}</td>
      <td>${money(line)}</td>
      <td>
        <button class="btn small" data-act="minus" data-code="${escapeHtml(item.code)}">-</button>
        <button class="btn small" data-act="plus" data-code="${escapeHtml(item.code)}">+</button>
        <button class="btn danger small" data-act="del" data-code="${escapeHtml(item.code)}">X</button>
      </td>
    `;
    body.appendChild(tr);
  }

  $("subTotal").textContent = money(subtotal);
  const disc = cartDiscountAmount(subtotal);
  $("discTotal").textContent = money(disc);
  $("grandTotal").textContent = money(Math.max(subtotal - disc, 0));
  updateReceiptPreview();
}

function cartAdd(product, qty=1){
  qty = Number(qty||1);
  if(qty<1) qty=1;
  const found = state.cart.find(x=>x.code===product.code);
  if(found) found.qty += qty;
  else state.cart.push({code:product.code, name:product.name, price:Number(product.price), qty});
  renderCart();
}

function cartInc(code, delta){
  const it = state.cart.find(x=>x.code===code);
  if(!it) return;
  it.qty += delta;
  if(it.qty<=0) state.cart = state.cart.filter(x=>x.code!==code);
  renderCart();
}

function cartClear(){
  state.cart = [];
  renderCart();
}

function cartSubtotal(){
  return state.cart.reduce((a,x)=>a + x.qty*x.price, 0);
}
function cartDiscountAmount(subtotal = cartSubtotal()){
  const t = state.discount?.type || "NONE";
  const v = Number(state.discount?.value || 0);
  if(!v || v<=0 || t==="NONE") return 0;
  if(t==="Q") return Math.min(v, subtotal);
  if(t==="PCT") return Math.min(subtotal, subtotal * (v/100));
  return 0;
}
function cartTotal(){
  const sub = cartSubtotal();
  const disc = cartDiscountAmount(sub);
  return Math.max(sub - disc, 0);
}


function syncDiscUI(){
  if(!$("discType")) return;
  $("discType").value = state.discount?.type || "NONE";
  $("discValue").value = String(state.discount?.value ?? 0);
}
function setDiscount(type, value){
  state.discount = { type, value: Number(value||0) };
  renderCart();
}


// ---------- Clients ----------
async function findClientByPhone(phone){
  phone = String(phone||"").trim();
  if(!phone) return null;
  return await idbGet("clients", phone);
}

async function saveClientFromForm(){
  const phone = $("cPhone").value.trim();
  const names = $("cNames").value.trim();
  const last  = $("cLast").value.trim();
  const addr  = $("cAddr").value.trim();

  if(!phone) return alert("Ingrese tel√©fono.");
  if(!names || !last || !addr) return alert("Complete Nombres, Apellidos y Direcci√≥n.");

  const client = {
    phone,
    names, last, addr,
    nameKey: normKey(names+" "+last),
    updatedAt: Date.now()
  };
  await idbPut("clients", client);
  state.selectedClient = client;
  alert("Cliente guardado.");
  await refreshKPIs();
  if(state.view==="clients") renderClients();
  updateReceiptPreview();
}

async function renderClients(){
  const q = normKey($("clientSearch").value);
  const all = await idbAll("clients");
  const list = q ? all.filter(c => normKey(c.phone).includes(q) || (c.nameKey||"").includes(q) || normKey(c.addr).includes(q)) : all;

  const tb = $("clientsBody");
  tb.innerHTML = "";
  for(const c of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(c.phone)}</td>
      <td>${escapeHtml(c.names)} ${escapeHtml(c.last)}</td>
      <td><small>${escapeHtml(c.addr)}</small></td>
      <td>
        <button class="btn small" data-useclient="${escapeHtml(c.phone)}">Usar</button>
        <button class="btn danger small" data-delclient="${escapeHtml(c.phone)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Products ----------
async function saveProductFromForm(){
  const code = $("pCode").value.trim();
  const name = $("pName").value.trim();
  const price = Number($("pPrice").value);
  const stock = Number($("pStock").value);

  if(!code) return alert("Ingrese C√≥digo (SKU/barras).");
  if(!name) return alert("Ingrese Nombre.");
  if(isNaN(price) || price<0) return alert("Precio inv√°lido.");
  if(isNaN(stock) || stock<0) return alert("Stock inv√°lido.");

  const product = {
    code, name,
    price, stock,
    nameKey: normKey(name),
    updatedAt: Date.now()
  };
  await idbPut("products", product);
  alert("Producto guardado.");
  $("pCode").value=""; $("pName").value=""; $("pPrice").value=""; $("pStock").value="";
  await refreshKPIs();
  renderProducts();
  refreshProductPicker();
}

async function getProductByCode(code){
  return await idbGet("products", code);
}

async function renderProducts(){
  const q = normKey($("prodSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("productsBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${Number(p.stock||0)}</td>
      <td>
        <button class="btn small" data-fillprod="${escapeHtml(p.code)}">Editar</button>
        <button class="btn danger small" data-delprod="${escapeHtml(p.code)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function refreshProductPicker(){
  const q = normKey($("productSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p=> (p.nameKey||"").includes(q) || normKey(p.code).includes(q)) : all;

  const sel = $("productPicker");
  sel.innerHTML = "";
  if(list.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay productos (agrega en Productos)";
    sel.appendChild(opt);
    return;
  }
  for(const p of list.slice(0,300)){
    const opt = document.createElement("option");
    opt.value = p.code;
    opt.textContent = `${p.name} ‚Äî ${p.code} ‚Äî ${money(p.price)} ‚Äî Stock:${p.stock}`;
    sel.appendChild(opt);
  }
}

async function seedDemo(){
  const demo = [
    {code:"1001", name:"Blusa Satinada Rosa", price:129, stock:20},
    {code:"1002", name:"Vestido Floral", price:249, stock:12},
    {code:"1003", name:"Jeans Skinny Azul", price:199, stock:18},
    {code:"1004", name:"Falda Plisada", price:159, stock:10},
    {code:"1005", name:"Chaqueta Denim", price:279, stock:8},
  ];
  for(const d of demo){
    await idbPut("products", {...d, nameKey:normKey(d.name), updatedAt:Date.now()});
  }
  alert("Demo cargado.");
  await refreshKPIs();
  renderProducts();
  refreshProductPicker();
}

// ---------- Sales / Checkout ----------
async function nextReceiptNo(){
  const meta = await idbGet("meta","receiptNo");
  const n = meta?.value ? Number(meta.value) : 1;
  await idbPut("meta",{key:"receiptNo", value:n+1});
  return n;
}

function requireClientIfShipping(){
  const type = $("saleType").value;
  if(type==="ENVIO"){
    const c = state.selectedClient;
    if(!c || !c.phone || !c.names || !c.last || !c.addr){
      return {ok:false, msg:"En ENV√çO es obligatorio seleccionar/crear un cliente con tel√©fono, nombre y direcci√≥n."};
    }
  }
  return {ok:true};
}

async function checkout(){
  if(state.cart.length===0) return alert("No hay productos en la venta.");
  const clientRule = requireClientIfShipping();
  if(!clientRule.ok) return alert(clientRule.msg);

  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;
  const subtotal = cartSubtotal();
  const discountAmount = cartDiscountAmount(subtotal);
  const total = Math.max(subtotal - discountAmount, 0);
  const ts = Date.now();
  const id = "S-" + ts + "-" + Math.random().toString(16).slice(2,8);
  const receiptNo = await nextReceiptNo();

  // Validate stock + deduct
  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    if(!p) return alert("Producto no existe: " + it.code);
    if(Number(p.stock||0) < it.qty) return alert(`Stock insuficiente para "${p.name}". Stock:${p.stock} Cant:${it.qty}`);
  }
  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    p.stock = Number(p.stock||0) - it.qty;
    p.updatedAt = Date.now();
    await idbPut("products", p);
  }

  const client = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);

  const sale = {
    id, ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType, payMethod,
    client: client ? { phone:client.phone, names:client.names, last:client.last, addr:client.addr } : null,
    items: state.cart.map(x=>({...x})),
    subtotal: Number(subtotal.toFixed(2)),
    discountType: state.discount.type,
    discountValue: Number(state.discount.value||0),
    discountAmount: Number(discountAmount.toFixed(2)),
    total: Number(total.toFixed(2)),
    receiptNo: pad(receiptNo, 6),
    shop: state.settings.shopName || "Tienda de Ropa"
  };

  await idbPut("sales", sale);
  state.lastReceipt = sale;

  state.discount = {type:"NONE", value:0};
  syncDiscUI();
  cartClear();
  await refreshKPIs();
  refreshProductPicker();
  updateReceiptPreview();
  // Auto-descarga (configurable en Ajustes)
  if(state.settings.autoPDF) setTimeout(()=>{ try{ generatePDF(); }catch(e){} }, 200);
  if(state.settings.autoPNG) setTimeout(()=>{ try{ downloadReceiptPNG(); }catch(e){} }, 600);
  alert("Venta registrada. Recibo listo para WhatsApp/PDF/PNG.");
}

// ---------- Reports ----------
async function renderReport(mode){
  const all = await idbAll("sales");
  const now = Date.now();
  let list = [];

  if(mode==="daily"){
    const k = todayKey(now);
    list = all.filter(s=>s.dateKey===k);
  }else if(mode==="weekly"){
    const k = weekKey(now);
    list = all.filter(s=>s.weekKey===k);
  }else{
    const k = monthKey(now);
    list = all.filter(s=>s.monthKey===k);
  }

  const total = list.reduce((a,s)=>a+Number(s.total||0),0);
  $("repCount").textContent = list.length;
  $("repTotal").textContent = money(total);

  const tb = $("salesBody");
  tb.innerHTML = "";
  for(const s of list.sort((a,b)=>b.ts-a.ts)){
    const d = new Date(s.ts);
    const when = d.toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total)}</td>
      <td>
        <button class="btn small" data-viewsale="${escapeHtml(s.id)}">Ver</button>
        <button class="btn danger small" data-delsale="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Receipt (text + preview + PDF + PNG) ----------
function makeLiveReceipt(){
  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;
  const c = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);
  return {
    ts: Date.now(),
    receiptNo: state.lastReceipt?.receiptNo || "------",
    shop: state.settings.shopName,
    saleType, payMethod,
    client: c ? {phone:c.phone, names:c.names, last:c.last, addr:c.addr} : null,
    items: state.cart.map(x=>({...x})),
    subtotal: cartSubtotal(),
    discountType: state.discount.type,
    discountValue: Number(state.discount.value||0),
    discountAmount: cartDiscountAmount(cartSubtotal()),
    total: cartTotal()
  };
}

function saleToReceiptText(s){
  if(!s) return "No hay recibo todav√≠a.";
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr || "‚Äî";
  const lines = [];
  lines.push(`üßæ *${s.shop}*`);
  lines.push(`Recibo #${s.receiptNo}`);
  lines.push(`Fecha: ${d}`);
  lines.push(`Tipo: ${s.saleType} | Pago: ${s.payMethod}`);
  lines.push(`Cliente: ${client}`);
  lines.push(`Tel: ${phone}`);
  lines.push(`Dir: ${addr}`);
  lines.push(`--------------------------------`);
  for(const it of (s.items||[])){
    lines.push(`${it.qty} x ${it.name} = ${money(it.qty*it.price)}`);
  }
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(s.subtotal ?? s.total)}`);
  lines.push(`DESCUENTO: ${money(s.discountAmount ?? 0)}`);
  lines.push(`TOTAL: *${money(s.total)}*`);
  lines.push(`Gracias por tu compra üíó`);
  return lines.join("\n");
}

function updateReceiptPreview(){
  const s = state.lastReceipt || makeLiveReceipt();
  $("rShop").textContent = s.shop || state.settings.shopName || "Tienda de Ropa";
  $("rMeta").textContent = `Recibo ‚Ä¢ ${s.saleType || "MOSTRADOR"} ‚Ä¢ ${s.payMethod || "EFECTIVO"}`;
  $("rNo").textContent = "#" + (s.receiptNo || "------");
  $("rDate").textContent = new Date(s.ts || Date.now()).toLocaleString();

  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  $("rClient").textContent = client;
  $("rPhone").textContent = s.client?.phone || "‚Äî";
  $("rAddr").textContent  = s.client?.addr || "‚Äî";
  $("rPay").textContent   = s.payMethod || $("payMethod").value;

  const itemsDiv = $("rItems");
  itemsDiv.innerHTML = "";
  for(const it of (s.items||[])){
    const line = document.createElement("div");
    line.className="line";
    line.innerHTML = `<span>${it.qty} x ${escapeHtml(it.name)}</span><span>${money(it.qty*it.price)}</span>`;
    itemsDiv.appendChild(line);
  }
  $("rSub").textContent = money(s.subtotal ?? cartSubtotal());
  $("rDisc").textContent = money(s.discountAmount ?? cartDiscountAmount(s.subtotal ?? cartSubtotal()));
  $("rTotal").textContent = money(s.total ?? cartTotal());
}

async function copyReceipt(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  try{
    await navigator.clipboard.writeText(text);
    alert("Recibo copiado. P√©galo en WhatsApp.");
  }catch{
    alert("No se pudo copiar autom√°ticamente. Intenta copiar manualmente desde WhatsApp.");
  }
}

function openWhatsApp(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}

/* PNG without external libs (works in Chromium; fallback alert if blocked) */
async function downloadReceiptPNG(){
  const node = $("receiptBox");
  if(!node) return;

  try{
    if(window.html2canvas){
      const canvas = await html2canvas(node, {backgroundColor:"#ffffff", scale:2});
      canvas.toBlob((blob)=>{
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `recibo_${(state.lastReceipt?.receiptNo||"----")}.png`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      }, "image/png");
      return;
    }
  }catch(err){
    // fallback below
  }

  // Fallback (SVG foreignObject) for browsers without html2canvas
  return downloadReceiptPNG_Fallback();
}

function downloadReceiptPNG_Fallback(){
  const node = $("receiptBox");
  const w = node.offsetWidth;
  const h = node.offsetHeight;

  const clone = node.cloneNode(true);
  clone.style.boxShadow="none";

  const wrapper = document.createElement("div");
  wrapper.style.width = w+"px";
  wrapper.style.height = h+"px";
  wrapper.style.background = "#fff";
  wrapper.appendChild(clone);

  const html = new XMLSerializer().serializeToString(wrapper);
  const data = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
      <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">
          ${html}
        </div>
      </foreignObject>
    </svg>
  `;
  const svgBlob = new Blob([data], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = ()=>{
    const cnv = $("cnv");
    cnv.width = w*2;
    cnv.height = h*2;
    const ctx = cnv.getContext("2d");
    ctx.scale(2,2);
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h);
    ctx.drawImage(img, 0,0);
    URL.revokeObjectURL(url);

    cnv.toBlob((blob)=>{
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `recibo_${(state.lastReceipt?.receiptNo||"----")}.png`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }, "image/png");
  };
  img.onerror = ()=>{
    URL.revokeObjectURL(url);
    alert("Tu navegador bloque√≥ el PNG. Usa PDF o Copiar texto.");
  };
  img.src = url;
}

/* PDF: build HTML without embedding <\/script> inside template strings */
function receiptToPrintableHTML(s){
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const clientName = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr  || "‚Äî";

  const rows = (s.items||[]).map(it=>{
    const line = (it.qty||0) * (it.price||0);
    return `
      <tr>
        <td style="text-align:center">${it.qty}</td>
        <td>${escapeHtml(it.name)}</td>
        <td style="text-align:right">${money(it.price)}</td>
        <td style="text-align:right">${money(line)}</td>
      </tr>
    `;
  }).join("");

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Recibo ${escapeHtml(s.receiptNo || "")}</title>
    <style>
      body{ font-family: Arial, sans-serif; margin: 20px; color:#111; }
      .box{ max-width: 820px; margin: 0 auto; border:1px solid #ddd; border-radius:14px; padding:16px; }
      h1{ margin:0; font-size:18px; }
      .meta{ margin-top:4px; color:#444; font-size:12px; font-weight:700; }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
      .card{ border:1px solid #eee; border-radius:12px; padding:12px; }
      .label{ color:#666; font-size:12px; font-weight:700; }
      .val{ font-size:13px; font-weight:800; margin-top:3px; }
      table{ width:100%; border-collapse:collapse; margin-top:14px; }
      th,td{ border-bottom:1px solid #eee; padding:8px; font-size:13px; }
      th{ background:#fafafa; text-align:left; }
      .totalRow{ display:flex; justify-content:space-between; margin-top:12px; font-weight:900; font-size:14px; }
      .foot{ margin-top:12px; color:#444; font-size:12px; font-weight:700; }
      @media print{
        body{ margin:0; }
        .box{ border:none; border-radius:0; }
      }
    </style>
  </head>
  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <h1>${escapeHtml(s.shop || "Tienda de Ropa")} ‚Äî Recibo #${escapeHtml(s.receiptNo || "")}</h1>
      <div class="meta">${escapeHtml(d)} ‚Ä¢ Tipo: ${escapeHtml(s.saleType || "MOSTRADOR")} ‚Ä¢ Pago: ${escapeHtml(s.payMethod || "EFECTIVO")}</div>

      <div class="grid">
        <div class="card">
          <div class="label">Cliente</div>
          <div class="val">${escapeHtml(clientName)}</div>
          <div class="label" style="margin-top:10px">Tel√©fono</div>
          <div class="val">${escapeHtml(phone)}</div>
        </div>
        <div class="card">
          <div class="label">Direcci√≥n</div>
          <div class="val">${escapeHtml(addr)}</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:70px;text-align:center">Cant</th>
            <th>Producto</th>
            <th style="width:120px;text-align:right">Precio</th>
            <th style="width:120px;text-align:right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="4">Sin items</td></tr>`}
        </tbody>
      </table>

      <div class="totalRow">
        <div>SUBTOTAL</div>
        <div>${money(s.subtotal ?? 0)}</div>
      </div>
      <div class="totalRow">
        <div>DESCUENTO</div>
        <div>${money(s.discountAmount ?? 0)}</div>
      </div>
      <div class="totalRow" style="font-size:16px">
        <div>TOTAL</div>
        <div>${money(s.total || 0)}</div>
      </div>

      <div class="foot">Gracias por tu compra üíó</div>
    </div>
  </body>
  </html>
  `;
}

function generatePDF(){
  const s = state.lastReceipt || makeLiveReceipt();

  if(s.saleType === "ENVIO"){
    const ok = s.client && s.client.phone && s.client.names && s.client.last && s.client.addr;
    if(!ok) return alert("Para ENV√çO debes tener cliente completo antes de generar el PDF.");
  }

  const html = receiptToPrintableHTML(s);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para generar PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// ---------- Backup / Restore / Settings / KPIs ----------
async function exportJSON(){
  const clients = await idbAll("clients");
  const products= await idbAll("products");
  const sales   = await idbAll("sales");
  const meta    = await idbAll("meta");

  const data = {
    exportedAt: new Date().toISOString(),
    settings: state.settings,
    clients, products, sales, meta
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pos_boutique_backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

async function importJSON(file){
  const text = await file.text();
  const data = JSON.parse(text);
  if(!data || typeof data!=="object") throw new Error("JSON inv√°lido.");

  await idbClearAll();
  if(data.clients) for(const c of data.clients) await idbPut("clients", c);
  if(data.products)for(const p of data.products) await idbPut("products", p);
  if(data.sales)   for(const s of data.sales) await idbPut("sales", s);
  if(data.meta)    for(const m of data.meta) await idbPut("meta", m);

  if(data.settings) state.settings = data.settings;

  await loadSettings();
  await refreshKPIs();
  refreshProductPicker();
  renderProducts();
  renderClients();
  renderReport("daily");
  updateReceiptPreview();
  alert("Backup importado.");
}

async function refreshKPIs(){
  const clients = await idbAll("clients");
  const products= await idbAll("products");
  const sales   = await idbAll("sales");
  const tKey = todayKey(Date.now());
  const today = sales.filter(s=>s.dateKey===tKey);
  const total = today.reduce((a,s)=>a+Number(s.total||0),0);

  $("kClients").textContent = clients.length;
  $("kProducts").textContent = products.length;
  $("kSalesToday").textContent = today.length;
  $("kTotalToday").textContent = money(total);
}

async function loadSettings(){
  const meta = await idbGet("meta","settings");
  if(meta?.value) state.settings = meta.value;
  // defaults for new settings
  if(state.settings.autoPDF===undefined) state.settings.autoPDF = true;
  if(state.settings.autoPNG===undefined) state.settings.autoPNG = true;
  $("sShopName").value = state.settings.shopName || "Tienda de Ropa";
  $("sAutoPDF").value = state.settings.autoPDF ? "1" : "0";
  $("sAutoPNG").value = state.settings.autoPNG ? "1" : "0";
  $("rShop").textContent = state.settings.shopName || "Tienda de Ropa";
}

async function saveSettings(){
  const shopName = $("sShopName").value.trim() || "Tienda de Ropa";
  state.settings.shopName = shopName;
  state.settings.autoPDF = $("sAutoPDF").value==="1";
  state.settings.autoPNG = $("sAutoPNG").value==="1";
  await idbPut("meta",{key:"settings", value: state.settings});
  alert("Ajustes guardados.");
  updateReceiptPreview();
}

// ---------- Events ----------
function wireEvents(){
  // Nav
  $("nav").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-view]");
    if(!btn) return;
    setView(btn.dataset.view);
  });

  // Hamburger toggle (simple collapse on mobile)
  $("btnToggle").addEventListener("click", ()=>{
    $("nav").classList.toggle("hide");
  });

  // Descuentos
  syncDiscUI();
  $("btnApplyDisc").addEventListener("click", ()=>{
    const type = $("discType").value;
    const value = Number($("discValue").value||0);
    if(type==="NONE"){ setDiscount("NONE", 0); syncDiscUI(); return; }
    if(value<0) return alert("Descuento inv√°lido.");
    if(type==="PCT" && value>100) return alert("Porcentaje m√°ximo 100%.");
    setDiscount(type, value);
    syncDiscUI();
  });
  $("btnClearDisc").addEventListener("click", ()=>{
    setDiscount("NONE", 0);
    syncDiscUI();
  });
  ["discType","discValue"].forEach(id=>{
    $(id).addEventListener("change", ()=> updateReceiptPreview());
    $(id).addEventListener("input", ()=> updateReceiptPreview());
  });

  // Inventarios
  $("btnInvRefresh")?.addEventListener("click", renderInventory);
  $("invSearch")?.addEventListener("input", ()=>{ if(state.view==="inventory") renderInventory(); });

  // Cierre
  $("btnBuildClose")?.addEventListener("click", buildClose);
  $("closeDate")?.addEventListener("change", ()=>{ if(state.view==="close") buildClose(); });
  $("btnCloseCopy")?.addEventListener("click", copyClose);
  $("btnClosePDF")?.addEventListener("click", generateClosePDF);
  $("btnClosePNG")?.addEventListener("click", downloadClosePNG);
  $("btnCloseWA")?.addEventListener("click", openCloseWhatsApp);
  $("btnCloseLoadHistory")?.addEventListener("click", buildClose);

  // Scan focus
  $("btnScan").addEventListener("click", ()=>{
    $("scanInput").focus();
    $("scanInput").select();
  });

  // Scan on Enter
  $("scanInput").addEventListener("keydown", async (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const code = $("scanInput").value.trim();
      const qty = Number($("qtyInput").value||1);
      if(!code) return;
      const p = await getProductByCode(code);
      if(!p) { alert("No existe producto con c√≥digo: " + code); return; }
      cartAdd(p, qty);
      $("scanInput").value="";
      $("qtyInput").value=1;
      $("scanInput").focus();
    }
  });

  // Search products for picker
  $("productSearch").addEventListener("input", refreshProductPicker);
  $("btnAddPicked").addEventListener("click", async ()=>{
    const code = $("productPicker").value;
    if(!code) return;
    const p = await getProductByCode(code);
    if(!p) return alert("Producto no existe.");
    cartAdd(p, Number($("qtyInput").value||1));
    $("qtyInput").value=1;
    $("scanInput").focus();
  });

  // Cart actions
  $("cartBody").addEventListener("click",(e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const code = b.dataset.code;
    const act = b.dataset.act;
    if(act==="minus") cartInc(code,-1);
    if(act==="plus")  cartInc(code, 1);
    if(act==="del")   { state.cart = state.cart.filter(x=>x.code!==code); renderCart(); }
  });

  $("btnClearCart").addEventListener("click", cartClear);

  // Client find/save
  $("btnFindClient").addEventListener("click", async ()=>{
    const phone = $("cPhone").value.trim();
    if(!phone) return alert("Ingrese tel√©fono.");
    const c = await findClientByPhone(phone);
    if(!c){
      alert("No existe. Completa los datos y presiona Guardar.");
      state.selectedClient = null;
      updateReceiptPreview();
      return;
    }
    state.selectedClient = c;
    $("cNames").value = c.names || "";
    $("cLast").value  = c.last || "";
    $("cAddr").value  = c.addr || "";
    alert("Cliente cargado.");
    updateReceiptPreview();
  });

  $("btnSaveClient").addEventListener("click", saveClientFromForm);

  $("btnUseWalkIn").addEventListener("click", ()=>{
    if($("saleType").value==="ENVIO"){
      alert("En ENV√çO no se permite venta sin cliente.");
      return;
    }
    state.selectedClient = null;
    $("cPhone").value=""; $("cNames").value=""; $("cLast").value=""; $("cAddr").value="";
    alert("Listo: venta MOSTRADOR sin cliente.");
    updateReceiptPreview();
  });

  $("saleType").addEventListener("change", ()=>{
    if($("saleType").value==="ENVIO"){
      $("cPhone").focus();
    }
    updateReceiptPreview();
  });

  $("payMethod").addEventListener("change", updateReceiptPreview);

  // Checkout
  $("btnCheckout").addEventListener("click", checkout);

  // Receipt buttons
  $("btnCopyReceipt").addEventListener("click", copyReceipt);
  $("btnPDF").addEventListener("click", generatePDF);
  $("btnDownloadReceipt").addEventListener("click", downloadReceiptPNG);
  $("btnWhatsApp").addEventListener("click", openWhatsApp);

  // Clients table actions
  $("clientsBody").addEventListener("click", async (e)=>{
    const use = e.target.closest("button[data-useclient]");
    const del = e.target.closest("button[data-delclient]");
    if(use){
      const phone = use.dataset.useclient;
      const c = await findClientByPhone(phone);
      if(c){
        state.selectedClient = c;
        $("cPhone").value=c.phone; $("cNames").value=c.names; $("cLast").value=c.last; $("cAddr").value=c.addr;
        setView("pos");
        updateReceiptPreview();
      }
    }
    if(del){
      const phone = del.dataset.delclient;
      if(confirm("¬øBorrar cliente "+phone+"?")){
        await idbDel("clients", phone);
        await refreshKPIs();
        renderClients();
      }
    }
  });

  $("clientSearch").addEventListener("input", renderClients);
  $("btnClientRefresh").addEventListener("click", renderClients);

  // Products actions
  $("btnSaveProduct").addEventListener("click", saveProductFromForm);
  $("btnSeedDemo").addEventListener("click", seedDemo);
  $("prodSearch").addEventListener("input", renderProducts);
  $("btnProdRefresh").addEventListener("click", ()=>{ renderProducts(); refreshProductPicker(); });

  $("productsBody").addEventListener("click", async (e)=>{
    const fill = e.target.closest("button[data-fillprod]");
    const del  = e.target.closest("button[data-delprod]");
    if(fill){
      const code = fill.dataset.fillprod;
      const p = await getProductByCode(code);
      if(!p) return;
      $("pCode").value = p.code;
      $("pName").value = p.name;
      $("pPrice").value= p.price;
      $("pStock").value= p.stock;
      $("pCode").focus();
    }
    if(del){
      const code = del.dataset.delprod;
      if(confirm("¬øBorrar producto "+code+"?")){
        await idbDel("products", code);
        await refreshKPIs();
        renderProducts();
        refreshProductPicker();
      }
    }
  });

  // Reports actions
  $("btnRepDaily").addEventListener("click", ()=>renderReport("daily"));
  $("btnRepWeekly").addEventListener("click", ()=>renderReport("weekly"));
  $("btnRepMonthly").addEventListener("click", ()=>renderReport("monthly"));

  $("salesBody").addEventListener("click", async (e)=>{
    const view = e.target.closest("button[data-viewsale]");
    const del  = e.target.closest("button[data-delsale]");
    if(view){
      const id = view.dataset.viewsale;
      const s = await idbGet("sales", id);
      if(s){
        state.lastReceipt = s;
        updateReceiptPreview();
        setView("pos");
        alert("Recibo cargado en vista POS. Puedes copiar/WhatsApp/PNG/PDF.");
      }
    }
    if(del){
      const id = del.dataset.delsale;
      if(confirm("¬øBorrar venta?")){
        await idbDel("sales", id);
        await refreshKPIs();
        renderReport("daily");
      }
    }
  });

  // Backup / restore / wipe
  $("btnBackup").addEventListener("click", exportJSON);
  $("btnRestore").addEventListener("click", ()=> $("restoreFile").click());
  $("restoreFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{ await importJSON(file); }
    catch(err){ alert("Error importando: " + err.message); }
    e.target.value="";
  });

  $("btnWipe").addEventListener("click", async ()=>{
    if(confirm("¬øSeguro? Esto borra clientes, productos, ventas y contadores.")){
      await idbClearAll();
      state.cart=[]; state.selectedClient=null; state.lastReceipt=null;
      await loadSettings();
      await refreshKPIs();
      renderCart();
      refreshProductPicker();
      renderProducts();
      renderClients();
      renderReport("daily");
      updateReceiptPreview();
      alert("Borrado completo.");
    }
  });

  // Live updates on receipt when typing client fields
  ["cPhone","cNames","cLast","cAddr"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      if($("saleType").value==="ENVIO"){
        const phone = $("cPhone").value.trim();
        const names = $("cNames").value.trim();
        const last  = $("cLast").value.trim();
        const addr  = $("cAddr").value.trim();
        state.selectedClient = (phone||names||last||addr) ? {phone,names,last,addr} : null;
      }
      updateReceiptPreview();
    });
  });

  // Focus scan input by pressing F2
  window.addEventListener("keydown",(e)=>{
    if(e.key==="F2"){
      e.preventDefault();
      $("scanInput").focus();
      $("scanInput").select();
    }
  });
}

// ---------- Init ----------
(async function init(){
  // 1) Always wire UI first so buttons/nav work even if storage fails
  try{
    wireEvents();
    setView("pos");
  }catch(e){
    console.error(e);
  }

  // 2) Init storage + load data
  try{
    db = await openDB();
    await loadSettings();
    await refreshKPIs();
    await refreshProductPicker();
    renderCart();
    syncDiscUI();

    const cd = document.getElementById('closeDate');
    if(cd) cd.value = todayKey();

    const meta = await idbGet("meta","receiptNo");
    const n = meta?.value ? (meta.value-1) : 1;
    $("rNo").textContent = "#"+pad(Math.max(1,n),6);
    updateReceiptPreview();
  }catch(err){
    console.error(err);
    // Most common causes: blocked IndexedDB, or opening file:// instead of https://
    alert("‚ö†Ô∏è No se pudo iniciar el almacenamiento (IndexedDB).

Soluci√≥n r√°pida:
‚Ä¢ Abre el sistema desde GitHub Pages (https://), no desde un archivo local.
‚Ä¢ Evita modo inc√≥gnito/privado o bloqueadores que deshabiliten almacenamiento.

Detalles: " + (err?.message || err));
  }
})();
</script>
</body>
</html>
