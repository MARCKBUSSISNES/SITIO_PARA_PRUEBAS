<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>MYT ONLINE ATLANTIC PLAZA</title>

  <style>
    :root{
      --bg:#fff4fb;
      --panel:#ffffff;
      --panel2:rgba(255,255,255,.78);
      --text:#241b2a;
      --muted:#7a6b78;

      --pink:#ff4fb7;
      --purple:#a855f7;
      --rose:#fb7185;

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --border:rgba(36, 20, 40, .10);
      --shadow: 0 16px 40px rgba(20, 10, 25, .10);
      --shadow2: 0 10px 26px rgba(20, 10, 25, .07);

      --radius: 22px;
      --radius2: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;

      --focus: 0 0 0 4px rgba(255,79,183,.15);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      overflow-x:hidden;

      background:
        radial-gradient(900px 650px at 18% 8%, rgba(255,79,183,.20), transparent 55%),
        radial-gradient(800px 520px at 85% 5%, rgba(168,85,247,.20), transparent 60%),
        radial-gradient(700px 520px at 70% 90%, rgba(251,113,133,.16), transparent 55%),
        var(--bg);
    }

    .sparkle{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.35;
      mix-blend-mode:multiply;
      background-image:
        radial-gradient(circle at 12% 18%, rgba(255,79,183,.22) 0 2px, transparent 3px),
        radial-gradient(circle at 84% 22%, rgba(168,85,247,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 78%, rgba(251,113,133,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 28% 72%, rgba(255,79,183,.14) 0 2px, transparent 3px);
      animation: drift 12s ease-in-out infinite alternate;
      filter: blur(.2px);
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) scale(1); }
      to{ transform: translate3d(-10px, 8px, 0) scale(1.02); }
    }

    .app{
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }

    .sidebar{
      position: sticky;
      top: 14px;
      align-self: start;
      height: calc(100vh - 28px);
      background: linear-gradient(180deg, rgba(255,255,255,.92) 0%, rgba(255,247,252,.92) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;

      animation: pop .35s ease-out both;
    }
    @keyframes pop{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .brand h1{
      font-size: 15px;
      margin:0;
      line-height:1.15;
      letter-spacing:.2px;
      font-weight: 1000;
    }
    .brand small{display:block;color:var(--muted); font-weight:800; margin-top:2px}

    .hamburger{
      width:42px;height:42px;border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(17,10,20,.07);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .hamburger:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(17,10,20,.10); }
    .hamburger:active{ transform: translateY(0); }
    .burger{ width:18px;height:12px; position:relative; }
    .burger span{
      position:absolute; left:0; right:0;
      height:2px; border-radius:999px;
      background: linear-gradient(90deg, var(--pink), var(--purple));
    }
    .burger span:nth-child(1){top:0}
    .burger span:nth-child(2){top:5px}
    .burger span:nth-child(3){bottom:0}

    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: var(--shadow2);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(20,10,25,.09);
    }
    .nav button .tag{
      font-weight:1000;
      font-size:12px;
      padding: 4px 10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,79,183,.14), rgba(168,85,247,.14));
      color: #7b2fb4;
      border:1px solid rgba(168,85,247,.18);
      white-space:nowrap;
    }
    .nav button.active{
      border-color: rgba(255,79,183,.55);
      box-shadow: 0 18px 34px rgba(255,79,183,.18);
      background: linear-gradient(180deg, #fff 0%, #fff1fa 100%);
    }

    .sidecard{
      margin-top:14px;
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,79,183,.38);
      background: rgba(255,255,255,.84);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      color:#7b2fb4;
      background: rgba(168,85,247,.12);
      border:1px solid rgba(168,85,247,.25);
      padding: 6px 10px;
      border-radius:999px;
    }
    .sidecard .row{
      display:flex; justify-content:space-between; gap:10px; margin:8px 0;
      color:var(--muted); font-weight:800;
    }
    .sidecard .row b{color:var(--text)}

    .main{
      min-height: calc(100vh - 36px);
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: visible;
      animation: pop .35s ease-out both;
      max-width:100%;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 6px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 14px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h2{margin:0;font-size:18px}
    .title p{margin:0;color:var(--muted);font-weight:800;font-size:13px}

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      border:none;
      cursor:pointer;
      font-weight:1000;
      padding: 11px 14px;
      border-radius: 16px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow: 0 10px 22px rgba(17,10,20,.06);
      color:var(--text);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 16px 30px rgba(17,10,20,.09); }
    .btn:active{ transform: translateY(0); }
    .btn.small{ padding:9px 12px; border-radius:14px; font-weight:1000; }

    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--purple));
      color:white;
      border:none;
      box-shadow: 0 16px 34px rgba(255,79,183,.26);
    }
    .btn.ok{
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(34,197,94,.22);
    }
    .btn.danger{
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(239,68,68,.22);
    }

    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap: 14px;
      margin-top: 14px;
    }
    .card, .field, .rowflex, .table{ min-width:0; }

    .card{
      background: rgba(255,255,255,.90);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
      position:relative;
    }
    .card h3{margin:0 0 10px 0; font-size:15px; font-weight:1000}
    .muted{color:var(--muted); font-weight:800; font-size:13px}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .field input, .field select, .field textarea{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-weight:900;
      color:var(--text);
      min-width:0;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(255,79,183,.55);
      box-shadow: var(--focus);
    }
    .field.full{grid-column:1 / -1}

    .rowflex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .rowflex .grow{ flex:1; }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-weight:900;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      background: rgba(255,79,183,.09);
      color:#6b1f5b;
    }
    .table td small{color:var(--muted); font-weight:900}
    .table tr:last-child td{border-bottom:none}

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      padding:12px;
      border-radius: var(--radius2);
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(17,10,20,.05);
    }
    .kpi .label{ color:var(--muted); font-weight:1000; font-size:12px }
    .kpi .value{ font-size:18px; font-weight:1100; margin-top:4px }
    .kpi .value span{ font-size:12px; color:var(--muted); font-weight:1000 }

    .hide{ display:none !important; }

    .receiptWrap{ display:flex; gap:12px; flex-wrap:wrap; }
    .receipt{
      width: 360px;
      background: #ffffff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 34px rgba(0,0,0,.11);
      transform-origin: top center;
      position:relative;
    }
    .cornerLogo{
      position:absolute;
      top:10px;
      right:10px;
      width:52px;
      height:52px;
      object-fit:contain;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      padding:4px;
    }
    .receipt .logo{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      margin-bottom:10px;
      padding-right:60px;
    }
    .receipt .logo b{ font-size:14px; letter-spacing:.3px; }
    .receipt .logo small{ display:block; color:#666; font-weight:900 }
    .receipt .line{ display:flex; justify-content:space-between; gap:10px; font-weight:1000; font-size:12px; margin:6px 0 }
    .receipt .hr{ height:1px; background:rgba(0,0,0,.08); margin:10px 0 }
    .receipt .big{ font-size:16px; font-weight:1200; display:flex; justify-content:space-between; margin-top:10px; }
    .receipt .foot{ margin-top:10px; font-size:11px; color:#666; font-weight:900 }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      font-size:11px;
      padding: 4px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.7);
      margin-top:6px;
    }
    .badge.pending{ border-color: rgba(245,158,11,.40); background: rgba(245,158,11,.12); color:#7a4b00; }
    .badge.paid{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color:#0e5b2a; }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .receipt{ width:100%; }
    }

    body.capture-mode .sparkle{ display:none !important; }
    body.capture-mode #receiptBox,
    body.capture-mode #closeBox{
      opacity: 1 !important;
      filter: none !important;
      transform: none !important;
    }

    /* Extra: search-in-cart field */
    .cartFilter{
      margin-top:12px;
      padding:12px;
      border-radius: var(--radius2);
      border:1px dashed rgba(168,85,247,.35);
      background: rgba(255,255,255,.86);
    }
  </style>
</head>
<body>
  <div class="sparkle"></div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div>
          <h1>MYT ONLINE <small>ATLANTIC PLAZA</small></h1>
        </div>
        <button class="hamburger" id="btnToggle" title="Men√∫">
          <div class="burger"><span></span><span></span><span></span></div>
        </button>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="pos"><span>üßæ Cobro (POS)</span><span class="tag">VENTA</span></button>
        <button data-view="shipments"><span>üöö Env√≠os pendientes</span><span class="tag">ENV√çO</span></button>
        <button data-view="clients"><span>üë©‚Äçüíº Clientes</span><span class="tag">DB</span></button>
        <button data-view="reports"><span>üìä Reportes</span><span class="tag">D/W/M</span></button>
        <button data-view="products"><span>üß∑ Productos</span><span class="tag">SKU</span></button>
        <button data-view="inventory"><span>üì¶ Inventarios</span><span class="tag">STOCK</span></button>
        <button data-view="close"><span>üßæ Cierres</span><span class="tag">D√çA</span></button>
        <button data-view="settings"><span>‚öôÔ∏è Ajustes</span><span class="tag">LOCAL</span></button>
      </div>

      <div class="sidecard">
        <div class="pill">üíó TUS VENTAS HOY</div>
        <div class="row"><span>Clientes</span><b id="kClients">0</b></div>
        <div class="row"><span>Productos</span><b id="kProducts">0</b></div>
        <div class="row"><span>Ventas (hoy)</span><b id="kSalesToday">0</b></div>
        <div class="row"><span>Total (hoy)</span><b id="kTotalToday">Q0.00</b></div>
        <div class="row"><span>Env√≠os pendientes</span><b id="kShipPending">0</b></div>
        <div class="muted" style="margin-top:10px">
          Tip: usa <b>Escanear</b> y pasa el lector. (F2 enfoca el campo)
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="viewTitle">DASH PRINCIPAL</h2>
          <p id="viewSub">Soporte tecnico tel: 58140-621</p>
        </div>
        <div class="actions">
          <button class="btn small" id="btnBackup">Exportar JSON</button>
          <button class="btn small" id="btnRestore">Importar JSON</button>
        </div>
      </div>

      <!-- POS VIEW -->
      <section id="view-pos">
        <div class="grid">
          <div class="card">
            <h3>üßæ Venta</h3>

            <div class="form" style="margin-bottom:10px">
              <div class="field full">
                <label>Escanear c√≥digo de barras (SKU / C√≥digo)</label>
                <div class="rowflex">
                  <input id="scanInput" class="grow" inputmode="text" placeholder="ESCANEE EL CODIGO DE BARRAS" autocomplete="off" />
                  <button class="btn primary" id="btnScan">Escanear</button>
                </div>
                <div class="muted">Presiona <b>Enter</b> para agregar con el lector.</div>
              </div>

              <div class="field">
                <label>Cantidad</label>
                <input id="qtyInput" type="number" min="1" value="1"/>
              </div>
              <div class="field">
                <label>Buscar producto (por nombre)</label>
                <input id="productSearch" placeholder="Ej: blusa, jeans..." />
              </div>

              <div class="field full">
                <label>Productos encontrados</label>
                <div class="rowflex">
                  <select id="productPicker" class="grow"></select>
                  <button class="btn" id="btnAddPicked">Agregar</button>
                </div>
              </div>
            </div>

            <!-- NUEVO: filtro por escritura dentro del carrito -->
            <div class="cartFilter">
              <div class="field full" style="margin:0">
                <label>üîé Filtrar productos en el carrito (para escribir o escanear)</label>
                <div class="rowflex">
                  <input id="cartSearch" class="grow" placeholder="Escribe o escanea: nombre / c√≥digo..." autocomplete="off" />
                  <button class="btn" id="btnCartFocus">Enfocar</button>
                </div>
                <div class="muted">Si el c√≥digo existe en productos, al presionar <b>Enter</b> lo agrega al carrito con la cantidad.</div>
              </div>
            </div>

            <table class="table" id="cartTable" style="margin-top:12px">
              <thead>
                <tr>
                  <th style="width:70px">Cant</th>
                  <th>Producto</th>
                  <th style="width:110px">Precio</th>
                  <th style="width:110px">Total</th>
                  <th style="width:110px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>

            <div class="totals">
              <div class="kpi">
                <div class="label">Subtotal</div>
                <div class="value" id="subTotal">Q0.00</div>
              </div>
              <div class="kpi">
                <div class="label">Total</div>
                <div class="value" id="grandTotal">Q0.00 <span>(Q)</span></div>
              </div>
            </div>

            <div class="muted" style="margin-top:8px">
              Descuento aplicado: <b id="discTotal">Q0.00</b>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∏ Descuento</h3>
              <div class="rowflex">
                <select id="discType" class="grow">
                  <option value="NONE">SIN DESCUENTO</option>
                  <option value="Q">DESCUENTO (Q)</option>
                  <option value="PCT">DESCUENTO (%)</option>
                </select>
                <input id="discValue" type="number" min="0" step="0.01" value="0" style="max-width:160px" />
                <button class="btn" id="btnApplyDisc">Aplicar</button>
                <button class="btn danger" id="btnClearDisc">Quitar</button>
              </div>
              <div class="muted" style="margin-top:8px">
                El descuento se refleja en el ticket/PDF/PNG y el texto de WhatsApp.
              </div>
            </div>

            <div class="rowflex" style="margin-top:12px">
              <button class="btn" id="btnClearCart">Limpiar</button>
              <button class="btn ok" id="btnCheckout">Cobrar</button>
            </div>

            <div class="muted" style="margin-top:10px">
              *Si eliges <b>ENV√çO</b>, se crea un <b>env√≠o pendiente</b>. Solo al marcarlo como <b>PAGADO</b> contar√° como venta.
            </div>
          </div>

          <div class="card">
            <h3>üí≥ Pago + Cliente</h3>

            <div class="form">
              <div class="field">
                <label>Forma de pago</label>
                <select id="payMethod">
                  <option value="EFECTIVO">EFECTIVO</option>
                  <option value="TARJETA">TARJETA</option>
                  <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                </select>
              </div>

              <div class="field">
                <label>Tipo de venta</label>
                <select id="saleType">
                  <option value="MOSTRADOR">MOSTRADOR</option>
                  <option value="ENVIO">ENV√çO</option>
                </select>
              </div>

              <div class="field full">
                <label>Tel√©fono (para buscar/crear cliente)</label>
                <div class="rowflex">
                  <input id="cPhone" class="grow" placeholder="Ej: 5555-5555" />
                  <button class="btn" id="btnFindClient">Buscar</button>
                </div>
                <div class="muted">En <b>ENV√çO</b> es obligatorio tener cliente.</div>
              </div>

              <div class="field">
                <label>Nombres</label>
                <input id="cNames" placeholder="Ej: Karina"/>
              </div>
              <div class="field">
                <label>Apellidos</label>
                <input id="cLast" placeholder="Ej: L√≥pez"/>
              </div>

              <div class="field full">
                <label>Direcci√≥n</label>
                <textarea id="cAddr" rows="3" placeholder="Ej: Col. X, casa #, zona..., referencias..."></textarea>
              </div>

              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveClient">Guardar cliente</button>
                  <button class="btn" id="btnUseWalkIn">Venta sin cliente</button>
                </div>
                <div class="muted">‚ÄúVenta sin cliente‚Äù solo aplica para MOSTRADOR.</div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üßæ Comprobante</h3>
              <div class="rowflex">
                <button class="btn" id="btnCopyReceipt">Copiar texto</button>
                <button class="btn" id="btnPDF">PDF</button>
                <button class="btn" id="btnDownloadReceipt">PNG</button>
                <button class="btn primary" id="btnWhatsApp">WhatsApp</button>
              </div>
              <div class="muted" style="margin-top:10px">
                PDF abre impresi√≥n (Guardar como PDF). WhatsApp abre texto listo.
              </div>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="receiptBox">
                <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="rShop">Tienda de Ropa</b>
                    <small id="rMeta">Recibo ‚Ä¢ Offline</small>
                    <div id="rStatusBadge" class="badge paid hide">‚úÖ PAGADO</div>
                  </div>
                  <div style="text-align:right">
                    <b id="rNo">#000001</b>
                    <small id="rDate">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Cliente</span><span id="rClient">MOSTRADOR</span></div>
                <div class="line"><span>Tel√©fono</span><span id="rPhone">‚Äî</span></div>
                <div class="line"><span>Direcci√≥n</span><span id="rAddr">‚Äî</span></div>
                <div class="hr"></div>

                <div id="rItems"></div>

                <div class="hr"></div>
                <div class="line"><span>Subtotal</span><span id="rSub">Q0.00</span></div>
                <div class="line"><span>Descuento</span><span id="rDisc">Q0.00</span></div>
                <div class="line"><span>Pago</span><span id="rPay">EFECTIVO</span></div>
                <div class="big"><span>Total</span><span id="rTotal">Q0.00</span></div>
                <div class="foot">¬°Gracias por tu compra! üíó</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SHIPMENTS VIEW -->
      <section id="view-shipments" class="hide">
        <div class="card">
          <h3>üöö Env√≠os pendientes (solo ENV√çO)</h3>
          <div class="rowflex">
            <input id="shipSearch" class="grow" placeholder="Buscar por tel√©fono, nombre o #recibo..."/>
            <select id="shipFilter" style="max-width:220px">
              <option value="ALL">Todos</option>
              <option value="PENDIENTE">Pendientes</option>
              <option value="PAGADO">Pagados</option>
            </select>
            <button class="btn" id="btnShipRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">
            Al cobrar en <b>ENV√çO</b>, el env√≠o queda <b>PENDIENTE</b>. Solo al marcar <b>PAGADO</b> se crea la venta (aparece en reportes/cierres).
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Recibo</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th>Estatus</th>
                  <th style="width:240px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="shipBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLIENTS VIEW -->
      <section id="view-clients" class="hide">
        <div class="card">
          <h3>üë©‚Äçüíº Clientes (base de datos local)</h3>
          <div class="rowflex">
            <input id="clientSearch" class="grow" placeholder="Buscar por tel√©fono o nombre..."/>
            <button class="btn" id="btnClientRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Tel√©fono es el identificador. Se guarda en tu navegador (IndexedDB).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Tel√©fono</th>
                  <th>Nombre</th>
                  <th>Direcci√≥n</th>
                  <th style="width:140px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="clientsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS VIEW -->
      <section id="view-reports" class="hide">
        <div class="card">
          <h3>üìä Reportes (Diario / Semanal / Mensual)</h3>

          <div class="rowflex">
            <button class="btn" id="btnRepDaily">Hoy</button>
            <button class="btn" id="btnRepWeekly">Semana</button>
            <button class="btn" id="btnRepMonthly">Mes</button>
          </div>

          <div class="totals" style="margin-top:12px">
            <div class="kpi">
              <div class="label">Ventas</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="kpi">
              <div class="label">Total</div>
              <div class="value" id="repTotal">Q0.00</div>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th style="width:160px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUCTS VIEW -->
      <section id="view-products" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üß∑ Productos (SKU / C√≥digo)</h3>
            <div class="form">
              <div class="field">
                <label>C√≥digo (SKU / Barras)</label>
                <input id="pCode" placeholder="Ej: 7501234567890"/>
              </div>
              <div class="field">
                <label>Nombre</label>
                <input id="pName" placeholder="Ej: Blusa rosa"/>
              </div>
              <div class="field">
                <label>Precio (Q)</label>
                <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ej: 125"/>
              </div>
              <div class="field">
                <label>Stock</label>
                <input id="pStock" type="number" min="0" step="1" placeholder="Ej: 10"/>
              </div>
              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveProduct">Guardar producto</button>
                </div>
                <div class="muted">Agrega productos manualmente con c√≥digo, nombre, precio y stock.</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üì¶ Lista de productos</h3>
            <div class="rowflex">
              <input id="prodSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
              <button class="btn" id="btnProdRefresh">Refrescar</button>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>C√≥digo</th>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th style="width:140px">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="productsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- INVENTORY VIEW -->
      <section id="view-inventory" class="hide">
        <div class="card">
          <h3>üì¶ Inventarios (Stock actual)</h3>
          <div class="rowflex">
            <input id="invSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
            <button class="btn" id="btnInvRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Muestra el stock actual. Se descuenta autom√°ticamente al cobrar (y tambi√©n cuando se crea un env√≠o pendiente).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Stock</th>
                </tr>
              </thead>
              <tbody id="invBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLOSE VIEW -->
      <section id="view-close" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üßæ Cierres de ventas (m√∫ltiples por d√≠a)</h3>

            <div class="rowflex">
              <div class="field" style="min-width:220px">
                <label>Fecha</label>
                <input id="closeDate" type="date" />
              </div>
              <div class="field" style="min-width:180px">
                <label>Desde (hora)</label>
                <input id="closeFrom" type="time" value="00:00"/>
              </div>
              <div class="field" style="min-width:180px">
                <label>Hasta (hora)</label>
                <input id="closeTo" type="time" value="23:59"/>
              </div>
              <button class="btn primary" id="btnBuildClose">Generar cierre</button>
              <button class="btn ok" id="btnSaveClose">Guardar cierre</button>
            </div>

            <div class="muted" style="margin-top:10px">
              El cierre toma <b>solo ventas PAGADAS</b> dentro del rango. Puedes guardar varios cierres por d√≠a.
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∞ Cuadre por forma de pago</h3>
              <div class="form">
                <div class="field">
                  <label>EFECTIVO contado (real)</label>
                  <input id="realCash" type="number" min="0" step="0.01" value="0"/>
                </div>
                <div class="field">
                  <label>TARJETA (real)</label>
                  <input id="realCard" type="number" min="0" step="0.01" value="0"/>
                </div>
                <div class="field full">
                  <label>TRANSFERENCIA (real)</label>
                  <input id="realTrans" type="number" min="0" step="0.01" value="0"/>
                </div>
              </div>
              <div class="muted" style="margin-top:8px">
                Diferencia = Real - Sistema. (positivo = sobra, negativo = falta)
              </div>
              <div class="totals">
                <div class="kpi">
                  <div class="label">Dif. EFECTIVO</div>
                  <div class="value" id="diffCash">Q0.00</div>
                </div>
                <div class="kpi">
                  <div class="label">Dif. TARJETA</div>
                  <div class="value" id="diffCard">Q0.00</div>
                </div>
              </div>
              <div class="totals">
                <div class="kpi">
                  <div class="label">Dif. TRANSFER.</div>
                  <div class="value" id="diffTrans">Q0.00</div>
                </div>
                <div class="kpi">
                  <div class="label">Dif. TOTAL</div>
                  <div class="value" id="diffTotal">Q0.00</div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Pago</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="closeHistBody"></tbody>
              </table>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üóÇÔ∏è Historial de cierres guardados (por fecha)</h3>
              <div class="rowflex">
                <button class="btn" id="btnCloseListRefresh">Refrescar</button>
              </div>
              <div style="margin-top:10px; overflow:auto">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Rango</th>
                      <th>Ventas</th>
                      <th>Total</th>
                      <th style="width:180px">Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody id="closeSavedBody"></tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:8px">
                Borrar cierre guardado requiere c√≥digo <b>363534</b>.
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üìÑ Ticket de cierre</h3>
            <div class="rowflex">
              <button class="btn" id="btnCloseCopy">Copiar texto</button>
              <button class="btn" id="btnClosePDF">PDF</button>
              <button class="btn" id="btnClosePNG">PNG</button>
              <button class="btn primary" id="btnCloseWA">WhatsApp</button>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="closeBox">
                <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="cShop">Tienda de Ropa</b>
                    <small id="cMeta">Cierre ‚Ä¢ D√≠a</small>
                  </div>
                  <div style="text-align:right">
                    <b id="cDate">‚Äî</b>
                    <small id="cTime">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Ventas</span><span id="cSales">0</span></div>
                <div class="line"><span>Mostrador</span><span id="cMost">0</span></div>
                <div class="line"><span>Env√≠os</span><span id="cEnv">0</span></div>
                <div class="hr"></div>

                <div class="line"><span>EFECTIVO</span><span id="cCash">Q0.00</span></div>
                <div class="line"><span>TARJETA</span><span id="cCard">Q0.00</span></div>
                <div class="line"><span>TRANSFER.</span><span id="cTrans">Q0.00</span></div>
                <div class="hr"></div>

                <div class="line"><span>Subtotal</span><span id="cSub">Q0.00</span></div>
                <div class="line"><span>Descuentos</span><span id="cDisc">Q0.00</span></div>
                <div class="big"><span>Total</span><span id="cTotal">Q0.00</span></div>

                <div class="hr"></div>
                <div class="muted">Productos vendidos</div>
                <div id="cProducts" style="margin-top:8px"></div>

                <div class="foot">Cierre generado ‚úÖ</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="hide">
        <div class="card">
          <h3>‚öôÔ∏è Ajustes</h3>

          <div class="form">
            <div class="field full">
              <label>Nombre de la tienda (sale en el recibo)</label>
              <input id="sShopName" placeholder="Ej: Boutique Karina"/>
            </div>

            <div class="field">
              <label>Auto PDF al cobrar</label>
              <select id="sAutoPDF">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field">
              <label>Auto PNG al cobrar</label>
              <select id="sAutoPNG">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field full">
              <h3 style="margin:8px 0 0 0">üìè Tama√±os (solo para ENV√çO)</h3>
              <div class="muted">Cambiar estos tama√±os requiere c√≥digo <b>363534</b>. MOSTRADOR sigue con tama√±o actual.</div>
            </div>

            <div class="field">
              <label>PNG: Ancho recibo (px)</label>
              <input id="sEnvPngWidth" type="number" min="260" step="1" placeholder="Ej: 360"/>
            </div>

            <div class="field">
              <label>PNG: Escala (1 a 4)</label>
              <input id="sEnvPngScale" type="number" min="1" max="4" step="1" placeholder="Ej: 2"/>
            </div>

            <div class="field">
              <label>PDF: Ancho papel (mm)</label>
              <input id="sEnvPdfWidth" type="number" min="50" max="120" step="1" placeholder="Ej: 80"/>
            </div>

            <div class="field">
              <label>PDF: Margen (mm)</label>
              <input id="sEnvPdfMargin" type="number" min="0" max="20" step="1" placeholder="Ej: 6"/>
            </div>

            <div class="field full">
              <button class="btn primary" id="btnSaveSettings">Guardar</button>
            </div>
          </div>

          <div class="muted" style="margin-top:10px">
            Nota: todo se guarda en tu navegador. Si cambias de PC/navegador, exporta e importa el JSON.
          </div>
        </div>
      </section>

      <input type="file" id="restoreFile" accept="application/json" class="hide"/>
      <canvas id="cnv" class="hide"></canvas>
    </main>
  </div>

  <!-- Opcional (solo si tienes internet). Si no, PNG se desactiva y puedes usar PDF. -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ============================================================
   POS Boutique Offline (IndexedDB) - FIX
   Objetivo: que TODO funcione sin cambiar dise√±o.
   ‚úÖ Clientes (cartera) visible y funcionando
   ‚úÖ Buscador por escritura dentro del carrito (cartSearch)
   ‚úÖ Lector de c√≥digo: scanInput + cartSearch (Enter agrega)
   ‚úÖ Botones conectados (no quedan "muertos")
============================================================ */

const DB_NAME = "pos_boutique_offline_v1";
const DB_VER = 5; // subimos versi√≥n (kardex)
let db;

const state = {
  view: "pos",
  cart: [],
  selectedClient: null,
  lastReceipt: null,
  lastClose: null,
  discount: { type:"NONE", value:0 },
  settings: {
    shopName: "Tienda de Ropa",
    autoPDF:true,
    autoPNG:true,
    envPngWidth: 378, // 10cm aprox @96dpi
    envPngScale: 2,
    envPdfWidthMM: 100, // fijo etiqueta 10x10cm
    envPdfMarginMM: 6
  }
};

const $ = (id)=>document.getElementById(id);

// Mostrar errores en pantalla (ayuda si algo bloquea los botones)
window.addEventListener("error",(e)=>{
  try{ alert("Error: " + (e.message||e.error||"") ); }catch(_){ }
});
window.addEventListener("unhandledrejection",(e)=>{
  try{ alert("Error: " + (e.reason?.message||e.reason||"")); }catch(_){ }
});

const money = (n)=> "Q" + (Number(n||0)).toFixed(2);

// ---------- IndexedDB ----------
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;

      if(!db.objectStoreNames.contains("clients")){
        const s = db.createObjectStore("clients", { keyPath:"phone" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("products")){
        const s = db.createObjectStore("products", { keyPath:"code" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("sales")){
        const s = db.createObjectStore("sales", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
      }
      if(!db.objectStoreNames.contains("shipments")){
        const s = db.createObjectStore("shipments", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("status", "status", { unique:false });
      }
      if(!db.objectStoreNames.contains("closes")){
        const s = db.createObjectStore("closes", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("dateKey", "dateKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("kardex")){
        const s = db.createObjectStore("kardex", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("code", "code", { unique:false });
        s.createIndex("type", "type", { unique:false });
      }
      if(!db.objectStoreNames.contains("meta")){
        db.createObjectStore("meta", { keyPath:"key" });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}
function tx(store, mode="readonly"){ return db.transaction(store, mode).objectStore(store); }
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store).get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(store, val){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").put(val);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbDel(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").delete(key);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbAll(store){
  return new Promise((res,rej)=>{
    const r = tx(store).getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbClearAll(){
  return Promise.all([
    new Promise((res,rej)=>{ const r=db.transaction("clients","readwrite").objectStore("clients").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("products","readwrite").objectStore("products").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("sales","readwrite").objectStore("sales").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("shipments","readwrite").objectStore("shipments").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("closes","readwrite").objectStore("closes").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("kardex","readwrite").objectStore("kardex").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("meta","readwrite").objectStore("meta").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
  ]);
}

// ---------- Helpers ----------
function todayKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function weekKey(ts=Date.now()){
  const d = new Date(ts);
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = tmp.getUTCDay() || 7;
  tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
  return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}
function monthKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normKey(s){ return String(s||"").trim().toLowerCase().replace(/\s+/g," "); }
function pad(n,len=6){ return String(n).padStart(len,"0"); }
function timeToMinutes(hhmm){
  const [h,m] = String(hhmm||"00:00").split(":").map(x=>Number(x||0));
  return (h*60)+(m||0);
}
function isWithinDateRange(ts, dateKey, fromHHMM, toHHMM){
  const dk = todayKey(ts);
  if(dk !== dateKey) return false;
  const d = new Date(ts);
  const mins = d.getHours()*60 + d.getMinutes();
  const a = timeToMinutes(fromHHMM);
  const b = timeToMinutes(toHHMM);
  return mins >= a && mins <= b;
}

// ---------- UI Nav ----------
const views = {
  pos: {title:"Cobro (POS)", sub:""},
  shipments: {title:"Env√≠os pendientes", sub:"Gesti√≥n de env√≠os: PENDIENTE/PAGADO."},
  clients: {title:"Clientes", sub:"Busca por tel√©fono, edita y usa para env√≠os."},
  reports: {title:"Reportes", sub:"Diario / Semanal / Mensual con historial de ventas (solo pagadas)."},
  products: {title:"Productos", sub:"Agrega productos con c√≥digo, nombre, precio y stock."},
  inventory: {title:"Inventarios", sub:"Tabla de productos + stock actual."},
  close: {title:"Cierres", sub:"Cierres m√∫ltiples + cuadre por forma de pago."},
  settings: {title:"Ajustes", sub:"Nombre de tienda, tama√±os ENV√çO y respaldos (exportar/importar)."}
};

function setView(v){
  state.view = v;
  $("viewTitle").textContent = views[v].title;
  $("viewSub").textContent = views[v].sub;

  for(const k of Object.keys(views)){
    $("view-"+k).classList.toggle("hide", k!==v);
  }
  [...document.querySelectorAll(".nav button")].forEach(b=>{
    b.classList.toggle("active", b.dataset.view===v);
  });

  if(v==="clients") renderClients();
  if(v==="products") { renderProducts(); refreshProductPicker(); }
  if(v==="reports") renderReport("daily");
  if(v==="inventory") { renderInventory(); renderKardex(); }
  if(v==="close") { buildClose(); renderSavedCloses();
  renderKardex(); }
  if(v==="shipments") renderShipments();
}

// ---------- Descuentos ----------
function cartSubtotal(){ return state.cart.reduce((a,x)=>a + x.qty*x.price, 0); }
function cartDiscountAmount(subtotal = cartSubtotal()){
  const t = state.discount?.type || "NONE";
  const v = Number(state.discount?.value || 0);
  if(!v || v<=0 || t==="NONE") return 0;
  if(t==="Q") return Math.min(v, subtotal);
  if(t==="PCT") return Math.min(subtotal, subtotal * (v/100));
  return 0;
}
function cartTotal(){
  const sub = cartSubtotal();
  const disc = cartDiscountAmount(sub);
  return Math.max(sub - disc, 0);
}
function syncDiscUI(){
  $("discType").value = state.discount?.type || "NONE";
  $("discValue").value = String(state.discount?.value ?? 0);
}

// ---------- Cart ----------
let cartFilterText = "";
function renderCart(){
  const body = $("cartBody");
  body.innerHTML = "";

  const filter = normKey(cartFilterText);
  let subtotal = 0;

  for(const item of state.cart){
    const line = item.qty * item.price;
    subtotal += line;

    const matches = !filter || normKey(item.name).includes(filter) || normKey(item.code).includes(filter);
    if(!matches) continue;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.qty}</td>
      <td>${escapeHtml(item.name)}<br><small>${escapeHtml(item.code)}</small></td>
      <td>${money(item.price)}</td>
      <td>${money(line)}</td>
      <td>
        <button class="btn small" data-act="minus" data-code="${escapeHtml(item.code)}">-</button>
        <button class="btn small" data-act="plus" data-code="${escapeHtml(item.code)}">+</button>
        <button class="btn danger small" data-act="del" data-code="${escapeHtml(item.code)}">X</button>
      </td>
    `;
    body.appendChild(tr);
  }

  const disc = cartDiscountAmount(subtotal);
  const total = Math.max(subtotal - disc, 0);

  $("subTotal").textContent = money(subtotal);
  $("discTotal").textContent = money(disc);
  $("grandTotal").textContent = money(total);
  updateReceiptPreview();
}

function cartAdd(product, qty=1){
  qty = Number(qty||1);
  if(qty<1) qty=1;
  const found = state.cart.find(x=>x.code===product.code);
  if(found) found.qty += qty;
  else state.cart.push({code:product.code, name:product.name, price:Number(product.price), qty});
  renderCart();
}

function cartInc(code, delta){
  const it = state.cart.find(x=>x.code===code);
  if(!it) return;
  it.qty += delta;
  if(it.qty<=0) state.cart = state.cart.filter(x=>x.code!==code);
  renderCart();
}
function cartClear(){
  state.cart = [];
  cartFilterText = "";
  $("cartSearch").value = "";
  renderCart();
}

// ---------- Clients ----------
async function findClientByPhone(phone){
  phone = String(phone||"").trim();
  if(!phone) return null;
  return await idbGet("clients", phone);
}
async function saveClientFromForm(){
  const phone = $("cPhone").value.trim();
  const names = $("cNames").value.trim();
  const last  = $("cLast").value.trim();
  const addr  = $("cAddr").value.trim();

  if(!phone) return alert("Ingrese tel√©fono.");
  if(!names || !last || !addr) return alert("Complete Nombres, Apellidos y Direcci√≥n.");

  const client = {
    phone, names, last, addr,
    nameKey: normKey(names+" "+last),
    updatedAt: Date.now()
  };
  await idbPut("clients", client);
  state.selectedClient = client;
  alert("Cliente guardado.");
  await refreshKPIs();
  if(state.view==="clients") renderClients();
  updateReceiptPreview();
}
async function renderClients(){
  const q = normKey($("clientSearch").value);
  const all = await idbAll("clients");
  const list = q ? all.filter(c => normKey(c.phone).includes(q) || (c.nameKey||"").includes(q) || normKey(c.addr).includes(q)) : all;

  const tb = $("clientsBody");
  tb.innerHTML = "";
  for(const c of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(c.phone)}</td>
      <td>${escapeHtml(c.names)} ${escapeHtml(c.last)}</td>
      <td><small>${escapeHtml(c.addr)}</small></td>
      <td>
        <button class="btn small" data-useclient="${escapeHtml(c.phone)}">Usar</button>
        <button class="btn danger small" data-delclient="${escapeHtml(c.phone)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Products ----------
async function getProductByCode(code){ return await idbGet("products", code); }

async function saveProductFromForm(){
  const code = $("pCode").value.trim();
  const name = $("pName").value.trim();
  const price = Number($("pPrice").value);
  const stock = Number($("pStock").value);

  if(!code) return alert("Ingrese C√≥digo (SKU/barras).");
  if(!name) return alert("Ingrese Nombre.");
  if(isNaN(price) || price<0) return alert("Precio inv√°lido.");
  if(isNaN(stock) || stock<0) return alert("Stock inv√°lido.");

  const exists = await idbGet("products", code);
  const beforeStock = exists ? Number(exists.stock||0) : 0;
  if(exists){
    if(!requireCode("editar producto")) return;
  }

  const product = { code, name, price, stock, nameKey: normKey(name), updatedAt: Date.now() };
  await idbPut("products", product);

  // Kardex: alta o ajuste de stock
  const delta = Number(stock||0) - Number(beforeStock||0);
  if(delta !== 0){
    await logKardex({
      type: delta>0 ? "IN" : "OUT",
      code, name,
      qty: Math.abs(delta),
      before: beforeStock,
      after: Number(stock||0),
      ref: exists ? "AJUSTE" : "ALTA"
    });
  }

  alert("Producto guardado.");
  $("pCode").value=""; $("pName").value=""; $("pPrice").value=""; $("pStock").value="";
  await refreshKPIs();
  renderProducts();
  refreshProductPicker();
}
async function renderProducts(){
  const q = normKey($("prodSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("productsBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${Number(p.stock||0)}</td>
      <td>
        <button class="btn small" data-fillprod="${escapeHtml(p.code)}">Editar</button>
        <button class="btn danger small" data-delprod="${escapeHtml(p.code)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}
async function refreshProductPicker(){
  const q = normKey($("productSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p=> (p.nameKey||"").includes(q) || normKey(p.code).includes(q)) : all;

  const sel = $("productPicker");
  sel.innerHTML = "";
  if(list.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay productos (agrega en Productos)";
    sel.appendChild(opt);
    return;
  }
  for(const p of list.slice(0,300)){
    const opt = document.createElement("option");
    opt.value = p.code;
    opt.textContent = `${p.name} ‚Äî ${p.code} ‚Äî ${money(p.price)} ‚Äî Stock:${p.stock}`;
    sel.appendChild(opt);
  }
}

// ---------- Inventory ----------
async function renderInventory(){
  const q = normKey($("invSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;
  const tb = $("invBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${Number(p.stock||0)}</td>
    `;
    tb.appendChild(tr);
  }
}


// ---------- Kardex (movimientos de stock) ----------
function kdxId(){
  const ts = Date.now();
  return "K-" + ts + "-" + Math.random().toString(16).slice(2,8);
}
async function logKardex(move){
  const rec = {
    id: kdxId(),
    ts: move.ts || Date.now(),
    type: move.type, // IN / OUT
    code: move.code,
    name: move.name || "",
    qty: Number(move.qty||0),
    before: Number(move.before||0),
    after: Number(move.after||0),
    ref: move.ref || "",
    note: move.note || ""
  };
  await idbPut("kardex", rec);
}

async function renderKardex(){
  const tb = $("kdxBody");
  if(!tb) return;

  const q = normKey($("kdxSearch")?.value || "");
  const t = $("kdxType")?.value || "ALL";
  const from = $("kdxFrom")?.value || "";
  const to   = $("kdxTo")?.value || "";

  const all = await idbAll("kardex");
  let list = all;

  if(t!=="ALL") list = list.filter(x => (x.type||"")===t);
  if(q) list = list.filter(x => normKey(x.code).includes(q) || normKey(x.name).includes(q));

  if(from){
    const a = new Date(from+"T00:00:00").getTime();
    list = list.filter(x => (x.ts||0) >= a);
  }
  if(to){
    const b = new Date(to+"T23:59:59").getTime();
    list = list.filter(x => (x.ts||0) <= b);
  }

  list.sort((a,b)=>b.ts-a.ts);

  tb.innerHTML = "";
  for(const x of list.slice(0,800)){
    const when = new Date(x.ts).toLocaleString();
    const tipo = (x.type==="IN") ? "‚¨ÜÔ∏è ENTRADA" : "‚¨áÔ∏è SALIDA";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small></td>
      <td>${escapeHtml(tipo)}</td>
      <td><b>${escapeHtml(x.code||"")}</b></td>
      <td>${escapeHtml(x.name||"")}</td>
      <td>${escapeHtml(String(x.qty||0))}</td>
      <td>${escapeHtml(String(x.before??""))}</td>
      <td>${escapeHtml(String(x.after??""))}</td>
      <td><small>${escapeHtml(x.ref||"")}</small></td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Sales / Shipments / Checkout ----------
async function nextReceiptNo(){
  const meta = await idbGet("meta","receiptNo");
  const n = meta?.value ? Number(meta.value) : 1;
  await idbPut("meta",{key:"receiptNo", value:n+1});
  return n;
}
function requireClientIfShipping(){
  const type = $("saleType").value;
  if(type==="ENVIO"){
    const c = state.selectedClient;
    if(!c || !c.phone || !c.names || !c.last || !c.addr){
      return {ok:false, msg:"En ENV√çO es obligatorio seleccionar/crear un cliente con tel√©fono, nombre y direcci√≥n."};
    }
  }
  return {ok:true};
}
async function validateStockForCart(){
  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    if(!p) return {ok:false, msg:"Producto no existe: " + it.code};
    if(Number(p.stock||0) < it.qty) return {ok:false, msg:`Stock insuficiente para "${p.name}". Stock:${p.stock} Cant:${it.qty}`};
  }
  return {ok:true};
}
async function deductStockForCart(refText=""){
  // refText ejemplo: "VENTA #000123" o "ENVIO PENDIENTE #000123"

  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    const before = Number(p.stock||0);
    p.stock = before - it.qty;
    p.updatedAt = Date.now();
    await idbPut("products", p);

    await logKardex({
      type:"OUT",
      code: p.code,
      name: p.name,
      qty: it.qty,
      before,
      after: Number(p.stock||0),
      ref: refText || ""
    });
  }
}
async function restoreStockForItems(items, refText=""){
  for(const it of (items||[])){
    const p = await getProductByCode(it.code);
    if(!p) continue;
    const before = Number(p.stock||0);
    p.stock = before + Number(it.qty||0);
    p.updatedAt = Date.now();
    await idbPut("products", p);

    await logKardex({
      type:"IN",
      code: p.code,
      name: p.name,
      qty: Number(it.qty||0),
      before,
      after: Number(p.stock||0),
      ref: refText || ""
    });
  }
}

async function checkout(){
  if(state.cart.length===0) return alert("No hay productos en la venta.");
  const clientRule = requireClientIfShipping();
  if(!clientRule.ok) return alert(clientRule.msg);

  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;

  const subtotal = cartSubtotal();
  const discountAmount = cartDiscountAmount(subtotal);
  const total = Math.max(subtotal - discountAmount, 0);

  // Stock
  const st = await validateStockForCart();
  if(!st.ok) return alert(st.msg);
  await deductStockForCart(`${saleType} ${(saleType==="ENVIO" ? "PENDIENTE" : "PAGADO")} #${pad(receiptNo,6)}`);

  const ts = Date.now();
  const receiptNo = await nextReceiptNo();

  const client = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);

  if(saleType === "ENVIO"){
    const shipment = {
      id: "E-" + ts + "-" + Math.random().toString(16).slice(2,8),
      ts,
      dateKey: todayKey(ts),
      weekKey: weekKey(ts),
      monthKey: monthKey(ts),
      saleType, payMethod,
      status: "PENDIENTE",
      client: client ? { phone:client.phone, names:client.names, last:client.last, addr:client.addr } : null,
      items: state.cart.map(x=>({...x})),
      subtotal: Number(subtotal.toFixed(2)),
      discountType: state.discount.type,
      discountValue: Number(state.discount.value||0),
      discountAmount: Number(discountAmount.toFixed(2)),
      total: Number(total.toFixed(2)),
      receiptNo: pad(receiptNo, 6),
      shop: state.settings.shopName || "Tienda de Ropa",
      stockDeducted: true,
      paidAt: null,
      saleId: null
    };

    await idbPut("shipments", shipment);
    state.lastReceipt = shipment;

    state.discount = {type:"NONE", value:0};
    syncDiscUI();
    cartClear();

    await refreshKPIs();
    refreshProductPicker();
    if(state.view==="inventory") renderInventory();
    updateReceiptPreview();
    if(state.view==="shipments") renderShipments();

    if(state.settings.autoPDF) setTimeout(()=>{ try{ generatePDF(); }catch(e){} }, 200);
    if(state.settings.autoPNG) setTimeout(()=>{ try{ downloadReceiptPNG(); }catch(e){} }, 700);

    alert("Env√≠o creado como PENDIENTE. En 'Env√≠os pendientes' puedes marcarlo como PAGADO para que cuente como venta.");
    return;
  }

  // Venta directa
  const sale = {
    id: "S-" + ts + "-" + Math.random().toString(16).slice(2,8),
    ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType, payMethod,
    client: client ? { phone:client.phone, names:client.names, last:client.last, addr:client.addr } : null,
    items: state.cart.map(x=>({...x})),
    subtotal: Number(subtotal.toFixed(2)),
    discountType: state.discount.type,
    discountValue: Number(state.discount.value||0),
    discountAmount: Number(discountAmount.toFixed(2)),
    total: Number(total.toFixed(2)),
    receiptNo: pad(receiptNo, 6),
    shop: state.settings.shopName || "Tienda de Ropa",
    source: "DIRECT"
  };

  await idbPut("sales", sale);
  state.lastReceipt = sale;

  state.discount = {type:"NONE", value:0};
  syncDiscUI();
  cartClear();

  await refreshKPIs();
  refreshProductPicker();
  if(state.view==="inventory") renderInventory();
  updateReceiptPreview();

  if(state.settings.autoPDF) setTimeout(()=>{ try{ generatePDF(); }catch(e){} }, 200);
  if(state.settings.autoPNG) setTimeout(()=>{ try{ downloadReceiptPNG(); }catch(e){} }, 700);

  alert("Venta registrada. Recibo listo para WhatsApp/PDF/PNG.");
}

// ---------- Shipments ----------
function shipmentClientName(s){ return s.client ? `${s.client.names} ${s.client.last}` : "‚Äî"; }
function shipmentSearchKey(s){
  return normKey(`${s.receiptNo||""} ${s.client?.phone||""} ${shipmentClientName(s)} ${s.client?.addr||""}`);
}
async function renderShipments(){
  const q = normKey($("shipSearch").value);
  const f = $("shipFilter").value || "ALL";
  const all = await idbAll("shipments");

  let list = all;
  if(f !== "ALL") list = list.filter(s => (s.status||"PENDIENTE") === f);
  if(q) list = list.filter(s => shipmentSearchKey(s).includes(q));

  list.sort((a,b)=>b.ts-a.ts);

  const tb = $("shipBody");
  tb.innerHTML = "";

  for(const s of list){
    const d = new Date(s.ts).toLocaleString();
    const status = s.status || "PENDIENTE";
    const statusHtml = status==="PAGADO"
      ? `<span style="font-weight:1000;color:#0e5b2a">‚úÖ PAGADO</span>`
      : `<span style="font-weight:1000;color:#7a4b00">‚è≥ PENDIENTE</span>`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(d)}</small></td>
      <td><b>#${escapeHtml(s.receiptNo||"")}</b></td>
      <td>${escapeHtml(shipmentClientName(s))}<br><small>${escapeHtml(s.client?.phone||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
      <td>${statusHtml}</td>
      <td>
        <button class="btn small" data-viewship="${escapeHtml(s.id)}">Ver</button>
        <button class="btn ok small" data-payship="${escapeHtml(s.id)}">Marcar PAGADO</button>
        <button class="btn danger small" data-delship="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}
async function markShipmentPaid(id){
  const s = await idbGet("shipments", id);
  if(!s) return alert("Env√≠o no encontrado.");
  if((s.status||"PENDIENTE")==="PAGADO") return alert("Ya est√° PAGADO.");

  const ts = Date.now();
  const saleId = "S-" + ts + "-" + Math.random().toString(16).slice(2,8);

  const sale = {
    id: saleId,
    ts: ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType: "ENVIO",
    payMethod: s.payMethod,
    client: s.client || null,
    items: (s.items||[]).map(x=>({...x})),
    subtotal: Number((s.subtotal ?? s.total ?? 0).toFixed(2)),
    discountType: s.discountType || "NONE",
    discountValue: Number(s.discountValue||0),
    discountAmount: Number((s.discountAmount ?? 0).toFixed(2)),
    total: Number((s.total ?? 0).toFixed(2)),
    receiptNo: s.receiptNo,
    shop: s.shop || state.settings.shopName || "Tienda de Ropa",
    source: "SHIPMENT",
    shipmentId: s.id,
    paidAt: ts
  };

  await idbPut("sales", sale);

  s.status = "PAGADO";
  s.paidAt = ts;
  s.saleId = saleId;
  await idbPut("shipments", s);

  state.lastReceipt = sale;
  await refreshKPIs();
  if(state.view==="shipments") renderShipments();
  if(state.view==="reports") renderReport("daily");
  updateReceiptPreview();
  buildClose();

  alert("Env√≠o marcado como PAGADO. Ya cuenta como venta en Reportes y Cierres.");
}
async function deleteShipment(id){
  if(!requireCode("borrar env√≠o")) return;
  const s = await idbGet("shipments", id);
  if(!s) return;
  if(!confirm("¬øBorrar env√≠o #"+(s.receiptNo||"") + "?")) return;

  if(s.stockDeducted && !s.saleId){
    await restoreStockForItems(s.items||[], `RESTOCK ENVIO #${s.receiptNo||""}`);
  }
  await idbDel("shipments", id);
  await refreshKPIs();
  renderShipments();
  renderInventory();
  refreshProductPicker();
  alert("Env√≠o borrado.");
}

// ---------- Reports ----------
async function renderReport(mode){
  const all = await idbAll("sales");
  const now = Date.now();
  let list = [];

  if(mode==="daily"){
    const k = todayKey(now);
    list = all.filter(s=>s.dateKey===k);
  }else if(mode==="weekly"){
    const k = weekKey(now);
    list = all.filter(s=>s.weekKey===k);
  }else{
    const k = monthKey(now);
    list = all.filter(s=>s.monthKey===k);
  }

  const total = list.reduce((a,s)=>a+Number(s.total||0),0);
  $("repCount").textContent = list.length;
  $("repTotal").textContent = money(total);

  const tb = $("salesBody");
  tb.innerHTML = "";
  for(const s of list.sort((a,b)=>b.ts-a.ts)){
    const when = new Date(s.ts).toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total)}</td>
      <td>
        <button class="btn small" data-viewsale="${escapeHtml(s.id)}">Ver</button>
        <button class="btn danger small" data-delsale="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Receipt ----------
function applyEnvReceiptSizing(saleType){
  const node = $("receiptBox");
  if(!node) return;
  if(saleType === "ENVIO"){
    const w = Number(state.settings.envPngWidth || 360);
    node.style.width = Math.max(260, Math.min(520, w)) + "px";
  }else{
    node.style.width = "";
  }
}
function makeLiveReceipt(){
  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;
  const c = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);
  return {
    ts: Date.now(),
    receiptNo: state.lastReceipt?.receiptNo || String($("rNo").textContent||"").replace("#","") || "------",
    shop: state.settings.shopName,
    saleType, payMethod,
    status: (saleType==="ENVIO") ? "PENDIENTE" : "PAGADO",
    client: c ? {phone:c.phone, names:c.names, last:c.last, addr:c.addr} : null,
    items: state.cart.map(x=>({...x})),
    subtotal: cartSubtotal(),
    discountAmount: cartDiscountAmount(cartSubtotal()),
    total: cartTotal()
  };
}
function saleToReceiptText(s){
  if(!s) return "No hay recibo todav√≠a.";
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr || "‚Äî";
  const status = s.status ? `Estatus: ${s.status}` : "";
  const lines = [];
  lines.push(`üßæ *${s.shop}*`);
  lines.push(`Recibo #${s.receiptNo}`);
  lines.push(`Fecha: ${d}`);
  if(status) lines.push(status);
  lines.push(`Tipo: ${s.saleType} | Pago: ${s.payMethod}`);
  lines.push(`Cliente: ${client}`);
  lines.push(`Tel: ${phone}`);
  lines.push(`Dir: ${addr}`);
  lines.push(`--------------------------------`);
  for(const it of (s.items||[])){
    lines.push(`${it.qty} x ${it.name} = ${money(it.qty*it.price)}`);
  }
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(s.subtotal ?? s.total)}`);
  lines.push(`DESCUENTO: ${money(s.discountAmount ?? 0)}`);
  lines.push(`TOTAL: *${money(s.total)}*`);
  lines.push(`Gracias por tu compra üíó`);
  return lines.join("\n");
}
function updateReceiptPreview(){
  const s = state.lastReceipt || makeLiveReceipt();
  const saleType = s.saleType || $("saleType").value;

  applyEnvReceiptSizing(saleType);

  $("rShop").textContent = s.shop || state.settings.shopName || "Tienda de Ropa";
  $("rMeta").textContent = `Recibo ‚Ä¢ ${s.saleType || "MOSTRADOR"} ‚Ä¢ ${s.payMethod || "EFECTIVO"}`;
  $("rNo").textContent = "#" + (s.receiptNo || "------");
  $("rDate").textContent = new Date(s.ts || Date.now()).toLocaleString();

  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  $("rClient").textContent = client;
  $("rPhone").textContent = s.client?.phone || "‚Äî";
  $("rAddr").textContent  = s.client?.addr || "‚Äî";
  $("rPay").textContent   = s.payMethod || $("payMethod").value;

  const badge = $("rStatusBadge");
  const status = s.status || (saleType==="ENVIO" ? "PENDIENTE" : "PAGADO");
  badge.classList.remove("hide","pending","paid");
  if(status === "PENDIENTE"){
    badge.textContent = "‚è≥ PENDIENTE";
    badge.classList.add("pending");
  }else{
    badge.textContent = "‚úÖ PAGADO";
    badge.classList.add("paid");
  }

  const itemsDiv = $("rItems");
  itemsDiv.innerHTML = "";
  for(const it of (s.items||[])){
    const line = document.createElement("div");
    line.className="line";
    line.innerHTML = `<span>${it.qty} x ${escapeHtml(it.name)}</span><span>${money(it.qty*it.price)}</span>`;
    itemsDiv.appendChild(line);
  }

  $("rSub").textContent = money(s.subtotal ?? cartSubtotal());
  $("rDisc").textContent = money(s.discountAmount ?? cartDiscountAmount(s.subtotal ?? cartSubtotal()));
  $("rTotal").textContent = money(s.total ?? cartTotal());
}
async function copyReceipt(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  try{
    await navigator.clipboard.writeText(text);
    alert("Recibo copiado. P√©galo en WhatsApp.");
  }catch{
    alert("No se pudo copiar autom√°ticamente.");
  }
}
function openWhatsApp(){
  const s = state.lastReceipt || makeLiveReceipt();
  const url = "https://wa.me/?text=" + encodeURIComponent(saleToReceiptText(s));
  window.open(url, "_blank");
}

// --- Seguridad (c√≥digo para borrar/editar) ---
function requireCode(action){
  const code = prompt(`Ingrese el c√≥digo para ${action}:`);
  if(code===null) return false;
  if(String(code).trim() !== "363534"){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}
// --- Seguridad (c√≥digo para backup/restore) ---
function requireBackupCode(action){
  const code = prompt(`Ingrese el c√≥digo para ${action}:`);
  if(code===null) return false;
  if(String(code).trim() !== "22782522"){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}

// --- Captura PNG ---
async function capturePNG(node, filename, scaleOverride=null){
  if(!node) throw new Error("Nodo no encontrado.");
  if(!window.html2canvas) throw new Error("html2canvas no disponible.");

  document.body.classList.add("capture-mode");
  await new Promise(r=>requestAnimationFrame(r));

  const scale = scaleOverride ? Number(scaleOverride) : 2;

  try{
    const canvas = await html2canvas(node, {
      backgroundColor:"#ffffff",
      scale: Math.max(1, Math.min(4, scale)),
      useCORS: true,
      allowTaint: true,
      logging: false,
      removeContainer: true
    });

    return await new Promise((resolve,reject)=>{
      canvas.toBlob((blob)=>{
        if(!blob) return reject(new Error("PNG bloqueado o en blanco."));
        const a = document.createElement("a");
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
        resolve(true);
      }, "image/png");
    });
  }finally{
    document.body.classList.remove("capture-mode");
  }
}
async function downloadReceiptPNG(){
  const node = $("receiptBox");
  if(!node) return;

  const s = state.lastReceipt || makeLiveReceipt();
  const isEnv = (s.saleType === "ENVIO");
  const scale = isEnv ? Number(state.settings.envPngScale||2) : 2;

  if(window.html2canvas){
    try{
      await capturePNG(node, `recibo_${(s.receiptNo||"----")}.png`, scale);
      return;
    }catch(e){
      // fallback: aviso
    }
  }
  alert("PNG no disponible sin html2canvas. Usa PDF o Copiar texto.");
}
function receiptToPrintableHTML(s){
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const clientName = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr  || "‚Äî";

  const isEnv = (s.saleType === "ENVIO");
  const itemsForPrint = isEnv ? (s.items||[]).slice(0,8) : (s.items||[]);
  const extraCount = isEnv ? Math.max(0, (s.items||[]).length - itemsForPrint.length) : 0;

  const rows = (itemsForPrint).map(it=>{
    const line = (it.qty||0) * (it.price||0);
    return `
      <tr>
        <td style="text-align:center">${it.qty}</td>
        <td>${escapeHtml(it.name)}</td>
        <td style="text-align:right">${money(it.price)}</td>
        <td style="text-align:right">${money(line)}</td>
      </tr>
    `;
  }).join("") + (extraCount>0 ? `<tr><td colspan="4" style="font-weight:800;color:#555">+ ${extraCount} item(s) m√°s‚Ä¶</td></tr>` : "");

  const sub = Number(s.subtotal ?? 0);
  const disc = Number(s.discountAmount ?? 0);
  const total = Number(s.total ?? 0);

  const isEnv = (s.saleType === "ENVIO");
  const pageW = isEnv ? Number(state.settings.envPdfWidthMM||80) : null;
  const pageM = isEnv ? Number(state.settings.envPdfMarginMM||6) : 10;

  const pageCss = isEnv
    ? `@page{ size: 100mm 100mm; margin: ${pageM}mm; }`
    : `@page{ margin: 12mm; }`;

  const boxWidth = isEnv ? `max-width: ${Math.max(50,Math.min(120,pageW))}mm;` : `max-width: 820px;`;

  const statusLine = s.status ? `<div class="meta" style="margin-top:6px;color:#a16207;font-weight:900">Estatus: ${escapeHtml(s.status)}</div>` : ``;

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Recibo ${escapeHtml(s.receiptNo || "")}</title>
    <style>
      ${pageCss}
      body{ font-family: Arial, sans-serif; margin: 0; color:#111; background:#fff7fb; }
      .box{ position:relative; ${boxWidth} margin: 0 auto; border:2px solid #fbcfe8; border-radius:16px; padding:16px; background:#fff; }
      .cornerLogo{ position:absolute; top:12px; right:12px; width:60px; height:60px; object-fit:contain; border-radius:14px; border:1px solid #eee; padding:4px; background:#fff; }
      .bar{ height:8px; border-radius:999px; background: linear-gradient(90deg, #ff4fb7, #a855f7); margin-bottom:12px; }
      h1{ margin:0; font-size:18px; color:#7b2fb4; padding-right:70px; }
      .meta{ margin-top:4px; color:#444; font-size:12px; font-weight:700; }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
      .card{ border:1px solid #eee; border-radius:12px; padding:12px; }
      .label{ color:#666; font-size:12px; font-weight:700; }
      .val{ font-size:13px; font-weight:800; margin-top:3px; }
      table{ width:100%; border-collapse:collapse; margin-top:14px; }
      th,td{ border-bottom:1px solid #eee; padding:8px; font-size:13px; }
      th{ background:#ffe4f1; text-align:left; }
      .totalRow{ display:flex; justify-content:space-between; margin-top:10px; font-weight:900; font-size:14px; }
      .foot{ margin-top:12px; color:#444; font-size:12px; font-weight:700; }
      @media print{ body{ background:#fff; } .box{ border:none; border-radius:0; } }
    </style>
  </head>
  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
      <div class="bar"></div>
      <h1>${escapeHtml(s.shop || "Tienda de Ropa")} ‚Äî Recibo #${escapeHtml(s.receiptNo || "")}</h1>
      <div class="meta">${escapeHtml(d)} ‚Ä¢ Tipo: ${escapeHtml(s.saleType || "MOSTRADOR")} ‚Ä¢ Pago: ${escapeHtml(s.payMethod || "EFECTIVO")}</div>
      ${statusLine}

      <div class="grid">
        <div class="card">
          <div class="label">Cliente</div>
          <div class="val">${escapeHtml(clientName)}</div>
          <div class="label" style="margin-top:10px">Tel√©fono</div>
          <div class="val">${escapeHtml(phone)}</div>
        </div>
        <div class="card">
          <div class="label">Direcci√≥n</div>
          <div class="val">${escapeHtml(addr)}</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:70px;text-align:center">Cant</th>
            <th>Producto</th>
            <th style="width:120px;text-align:right">Precio</th>
            <th style="width:120px;text-align:right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="4">Sin items</td></tr>`}
        </tbody>
      </table>

      <div class="totalRow"><div>SUBTOTAL</div><div>${money(sub)}</div></div>
      <div class="totalRow"><div>DESCUENTO</div><div>${money(disc)}</div></div>
      <div class="totalRow"><div>TOTAL</div><div>${money(total)}</div></div>

      <div class="foot">Gracias por tu compra üíó</div>
    </div>
  </body>
  </html>`;
}
function generatePDF(){
  const s = state.lastReceipt || makeLiveReceipt();
  if(s.saleType === "ENVIO"){
    const ok = s.client && s.client.phone && s.client.names && s.client.last && s.client.addr;
    if(!ok) return alert("Para ENV√çO debes tener cliente completo antes de generar el PDF.");
  }
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para generar PDF.");
  w.document.open();
  w.document.write(receiptToPrintableHTML(s));
  w.document.close();
}

// ---------- Cierre ----------
function closeToText(c){
  if(!c) return "No hay cierre todav√≠a.";
  const lines = [];
  lines.push(`üßæ *${c.shop}*`);
  lines.push(`CIERRE DE VENTAS ‚Äî ${c.dateKey} (${c.fromHHMM} - ${c.toHHMM})`);
  lines.push(`Generado: ${new Date(c.ts).toLocaleString()}`);
  lines.push(`--------------------------------`);
  lines.push(`Ventas: ${c.salesCount}`);
  lines.push(`Mostrador: ${c.mostradorCount} | Env√≠os: ${c.envioCount}`);
  lines.push(`--------------------------------`);
  lines.push(`EFECTIVO: ${money(c.pay.EFECTIVO)}`);
  lines.push(`TARJETA: ${money(c.pay.TARJETA)}`);
  lines.push(`TRANSFERENCIA: ${money(c.pay.TRANSFERENCIA)}`);
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(c.subtotal)}`);
  lines.push(`DESCUENTOS: ${money(c.discounts)}`);
  lines.push(`TOTAL: *${money(c.total)}*`);
  return lines.join("\n");
}
async function buildClose(){
  const dateKey = $("closeDate").value || todayKey();
  const fromHHMM = $("closeFrom").value || "00:00";
  const toHHMM   = $("closeTo").value || "23:59";

  const all = await idbAll("sales");
  const list = all.filter(s=> isWithinDateRange(s.ts, dateKey, fromHHMM, toHHMM)).sort((a,b)=>a.ts-b.ts);

  const pay = {EFECTIVO:0, TARJETA:0, TRANSFERENCIA:0};
  let subtotal = 0, discounts = 0, total = 0, envioCount = 0, mostradorCount = 0;

  const prodMap = new Map();
  for(const s of list){
    subtotal += Number(s.subtotal ?? s.total ?? 0);
    discounts += Number(s.discountAmount ?? 0);
    total += Number(s.total ?? 0);
    if(s.saleType==="ENVIO") envioCount++; else mostradorCount++;
    pay[s.payMethod] = (pay[s.payMethod]||0) + Number(s.total||0);
    for(const it of (s.items||[])){
      const key = it.code;
      const cur = prodMap.get(key) || {code:it.code, name:it.name, qty:0};
      cur.qty += Number(it.qty||0);
      cur.name = it.name;
      prodMap.set(key, cur);
    }
  }
  const products = [...prodMap.values()].sort((a,b)=>b.qty-a.qty);

  // historial
  const hb = $("closeHistBody");
  hb.innerHTML = "";
  for(const s of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(new Date(s.ts).toLocaleTimeString())}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR")}</td>
      <td>${escapeHtml(s.saleType||"")}</td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
    `;
    hb.appendChild(tr);
  }

  const realCash = Number($("realCash").value||0);
  const realCard = Number($("realCard").value||0);
  const realTrans= Number($("realTrans").value||0);

  const diff = {
    EFECTIVO: Number((realCash - (pay.EFECTIVO||0)).toFixed(2)),
    TARJETA: Number((realCard - (pay.TARJETA||0)).toFixed(2)),
    TRANSFERENCIA: Number((realTrans - (pay.TRANSFERENCIA||0)).toFixed(2))
  };
  const diffTotal = Number((diff.EFECTIVO + diff.TARJETA + diff.TRANSFERENCIA).toFixed(2));

  $("diffCash").textContent = money(diff.EFECTIVO);
  $("diffCard").textContent = money(diff.TARJETA);
  $("diffTrans").textContent = money(diff.TRANSFERENCIA);
  $("diffTotal").textContent = money(diffTotal);

  const close = {
    id: "C-TMP",
    ts: Date.now(),
    dateKey, fromHHMM, toHHMM,
    shop: state.settings.shopName || "Tienda de Ropa",
    salesCount: list.length, envioCount, mostradorCount,
    pay,
    subtotal: Number(subtotal.toFixed(2)),
    discounts: Number(discounts.toFixed(2)),
    total: Number(total.toFixed(2)),
    products,
    real: {EFECTIVO: realCash, TARJETA: realCard, TRANSFERENCIA: realTrans},
    diff,
    diffTotal
  };
  state.lastClose = close;

  $("cShop").textContent = close.shop;
  $("cMeta").textContent = `Cierre ‚Ä¢ ${close.fromHHMM}-${close.toHHMM}`;
  $("cDate").textContent = close.dateKey;
  $("cTime").textContent = new Date(close.ts).toLocaleString();

  $("cSales").textContent = String(close.salesCount);
  $("cMost").textContent = String(close.mostradorCount);
  $("cEnv").textContent = String(close.envioCount);

  $("cCash").textContent = money(close.pay.EFECTIVO||0);
  $("cCard").textContent = money(close.pay.TARJETA||0);
  $("cTrans").textContent = money(close.pay.TRANSFERENCIA||0);

  $("cSub").textContent = money(close.subtotal);
  $("cDisc").textContent = money(close.discounts);
  $("cTotal").textContent = money(close.total);

  const cp = $("cProducts");
  cp.innerHTML = "";
  if(close.products.length===0){
    const div = document.createElement("div");
    div.className="muted";
    div.textContent = "Sin ventas en este rango.";
    cp.appendChild(div);
  }else{
    for(const p of close.products.slice(0,50)){
      const div = document.createElement("div");
      div.className="line";
      div.innerHTML = `<span>${p.qty} x ${escapeHtml(p.name)}</span><span><small>${escapeHtml(p.code)}</small></span>`;
      cp.appendChild(div);
    }
  }
}
async function saveClose(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  if(!requireCode("guardar cierre")) return;
  const c = {...state.lastClose};
  c.id = "C-" + c.ts + "-" + Math.random().toString(16).slice(2,8);
  await idbPut("closes", c);
  await renderSavedCloses();
  renderKardex();
  alert("Cierre guardado ‚úÖ");
}
async function renderSavedCloses(){
  const dateKey = $("closeDate").value || todayKey();
  const all = await idbAll("closes");
  const list = all.filter(x=>x.dateKey===dateKey).sort((a,b)=>b.ts-a.ts);

  const tb = $("closeSavedBody");
  tb.innerHTML = "";
  for(const c of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(c.dateKey)}</small><br><small>${escapeHtml(new Date(c.ts).toLocaleString())}</small></td>
      <td><b>${escapeHtml(c.fromHHMM||"")}</b> - <b>${escapeHtml(c.toHHMM||"")}</b></td>
      <td>${escapeHtml(String(c.salesCount||0))}</td>
      <td>${money(c.total||0)}</td>
      <td>
        <button class="btn small" data-viewclose="${escapeHtml(c.id)}">Ver</button>
        <button class="btn danger small" data-delclose="${escapeHtml(c.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}
async function viewSavedClose(id){
  const c = await idbGet("closes", id);
  if(!c) return;
  state.lastClose = c;
  $("closeDate").value = c.dateKey;
  $("closeFrom").value = c.fromHHMM;
  $("closeTo").value = c.toHHMM;

  $("realCash").value = c.real?.EFECTIVO ?? 0;
  $("realCard").value = c.real?.TARJETA ?? 0;
  $("realTrans").value = c.real?.TRANSFERENCIA ?? 0;

  $("diffCash").textContent = money(c.diff?.EFECTIVO||0);
  $("diffCard").textContent = money(c.diff?.TARJETA||0);
  $("diffTrans").textContent = money(c.diff?.TRANSFERENCIA||0);
  $("diffTotal").textContent = money(c.diffTotal||0);

  $("cShop").textContent = c.shop;
  $("cMeta").textContent = `Cierre ‚Ä¢ ${c.fromHHMM}-${c.toHHMM}`;
  $("cDate").textContent = c.dateKey;
  $("cTime").textContent = new Date(c.ts).toLocaleString();
  $("cSales").textContent = String(c.salesCount);
  $("cMost").textContent = String(c.mostradorCount);
  $("cEnv").textContent = String(c.envioCount);
  $("cCash").textContent = money(c.pay?.EFECTIVO||0);
  $("cCard").textContent = money(c.pay?.TARJETA||0);
  $("cTrans").textContent = money(c.pay?.TRANSFERENCIA||0);
  $("cSub").textContent = money(c.subtotal||0);
  $("cDisc").textContent = money(c.discounts||0);
  $("cTotal").textContent = money(c.total||0);

  const cp = $("cProducts");
  cp.innerHTML = "";
  for(const p of (c.products||[]).slice(0,50)){
    const div = document.createElement("div");
    div.className="line";
    div.innerHTML = `<span>${p.qty} x ${escapeHtml(p.name)}</span><span><small>${escapeHtml(p.code)}</small></span>`;
    cp.appendChild(div);
  }
}
async function deleteSavedClose(id){
  if(!requireCode("borrar cierre")) return;
  if(!confirm("¬øBorrar cierre guardado?")) return;
  await idbDel("closes", id);
  await renderSavedCloses();
  renderKardex();
  alert("Cierre borrado.");
}
async function copyClose(){
  const text = closeToText(state.lastClose);
  try{ await navigator.clipboard.writeText(text); alert("Cierre copiado."); }
  catch{ alert("No se pudo copiar autom√°ticamente."); }
}
function openCloseWhatsApp(){
  const text = closeToText(state.lastClose);
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
}
function generateClosePDF(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  // imprimimos el ticket actual del cierre usando print() simple:
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><title>Cierre</title>
    <style>@page{margin:12mm} body{font-family:Arial;margin:0;background:#fff} .wrap{padding:12mm}</style>
    </head><body onload="setTimeout(()=>window.print(),250)"><div class="wrap">${$("closeBox").outerHTML}</div></body></html>`;
  const w = window.open("", "_blank");
  if(!w) return alert("Permite popups para PDF.");
  w.document.open(); w.document.write(html); w.document.close();
}
async function downloadClosePNG(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  if(!window.html2canvas) return alert("PNG no disponible sin html2canvas. Usa PDF.");
  await capturePNG($("closeBox"), `cierre_${state.lastClose.dateKey}.png`, 2);
}

// ---------- Backup / Restore / Settings / KPIs ----------
async function exportJSON(){
  const clients = await idbAll("clients");
  const products= await idbAll("products");
  const sales   = await idbAll("sales");
  const shipments = await idbAll("shipments");
  const closes = await idbAll("closes");
  const meta    = await idbAll("meta");

  const data = {
    exportedAt: new Date().toISOString(),
    settings: state.settings,
    clients, products, sales, shipments, closes, meta
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pos_boutique_backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
async function importJSON(file){
  const text = await file.text();
  const data = JSON.parse(text);
  if(!data || typeof data!=="object") throw new Error("JSON inv√°lido.");

  await idbClearAll();
  if(data.clients) for(const c of data.clients) await idbPut("clients", c);
  if(data.products)for(const p of data.products) await idbPut("products", p);
  if(data.sales)   for(const s of data.sales) await idbPut("sales", s);
  if(data.shipments) for(const s of data.shipments) await idbPut("shipments", s);
  if(data.closes) for(const c of data.closes) await idbPut("closes", c);
  if(data.meta)    for(const m of data.meta) await idbPut("meta", m);
  if(data.settings) state.settings = data.settings;

  await loadSettings();
  await refreshKPIs();
  await refreshProductPicker();
  renderCart();
  renderProducts();
  renderInventory();
  renderClients();
  renderReport("daily");
  renderShipments();
  updateReceiptPreview();
  buildClose();
  syncDiscUI();
  renderSavedCloses();
  renderKardex();
  alert("Backup importado.");
}
async function refreshKPIs(){
  const clients = await idbAll("clients");
  const products= await idbAll("products");
  const sales   = await idbAll("sales");
  const shipments = await idbAll("shipments");
  const tKey = todayKey(Date.now());
  const today = sales.filter(s=>s.dateKey===tKey);
  const total = today.reduce((a,s)=>a+Number(s.total||0),0);
  const pending = shipments.filter(s=> (s.status||"PENDIENTE")==="PENDIENTE").length;

  $("kClients").textContent = clients.length;
  $("kProducts").textContent = products.length;
  $("kSalesToday").textContent = today.length;
  $("kTotalToday").textContent = money(total);
  $("kShipPending").textContent = pending;
}
function sanitizeSettings(){
  if(state.settings.envPngWidth===undefined) state.settings.envPngWidth = 360;
  if(state.settings.envPngScale===undefined) state.settings.envPngScale = 2;
  if(state.settings.envPdfWidthMM===undefined) state.settings.envPdfWidthMM = 100;
  if(state.settings.envPdfMarginMM===undefined) state.settings.envPdfMarginMM = 4;
}
async function loadSettings(){
  const meta = await idbGet("meta","settings");
  if(meta?.value) state.settings = meta.value;

  if(state.settings.autoPDF===undefined) state.settings.autoPDF = true;
  if(state.settings.autoPNG===undefined) state.settings.autoPNG = true;
  sanitizeSettings();

  $("sShopName").value = state.settings.shopName || "Tienda de Ropa";
  $("sAutoPDF").value = state.settings.autoPDF ? "1" : "0";
  $("sAutoPNG").value = state.settings.autoPNG ? "1" : "0";
  $("sEnvPngWidth").value = state.settings.envPngWidth;
  $("sEnvPngScale").value = state.settings.envPngScale;
  $("sEnvPdfWidth").value = state.settings.envPdfWidthMM;
  $("sEnvPdfMargin").value = state.settings.envPdfMarginMM;
  // Bloquear tama√±os de ENV√çO (Etiqueta 10x10cm)
  ["sEnvPngWidth","sEnvPngScale","sEnvPdfWidth","sEnvPdfMargin"].forEach(id=>{
    const el = $(id);
    if(el){ el.disabled = true; el.title = "Fijo: etiqueta 10x10cm"; }
  });


  $("rShop").textContent = state.settings.shopName || "Tienda de Ropa";
  $("cShop").textContent = state.settings.shopName || "Tienda de Ropa";
}
async function saveSettings(){
  const prev = {...state.settings};

  const shopName = $("sShopName").value.trim() || "Tienda de Ropa";
  const autoPDF = $("sAutoPDF").value==="1";
  const autoPNG = $("sAutoPNG").value==="1";

  const envPngWidth = 378; // fijo 10cm
  const envPngScale = 2; // fijo
  const envPdfWidthMM = 100; // fijo 10cm
  const envPdfMarginMM = 4; // fijo

  const advancedChanged =
    Number(prev.envPngWidth||360) !== envPngWidth ||
    Number(prev.envPngScale||2) !== envPngScale ||
    Number(prev.envPdfWidthMM||80) !== envPdfWidthMM ||
    Number(prev.envPdfMarginMM||6) !== envPdfMarginMM;

  if(advancedChanged){
    if(!requireCode("cambiar tama√±os de impresi√≥n (ENV√çO)")) return;
  }

  state.settings.shopName = shopName;
  state.settings.autoPDF = autoPDF;
  state.settings.autoPNG = autoPNG;

  state.settings.envPngWidth = Math.max(260, Math.min(520, envPngWidth));
  state.settings.envPngScale = Math.max(1, Math.min(4, envPngScale));
  state.settings.envPdfWidthMM = Math.max(50, Math.min(120, envPdfWidthMM));
  state.settings.envPdfMarginMM = Math.max(0, Math.min(20, envPdfMarginMM));

  await idbPut("meta",{key:"settings", value: state.settings});
  alert("Ajustes guardados.");
  updateReceiptPreview();
  buildClose();
}

// ---------- Events ----------
function wireEvents(){
  // Nav
  $("nav").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-view]");
    if(!btn) return;
    setView(btn.dataset.view);
  });

  $("btnToggle").addEventListener("click", ()=>{
    $("nav").classList.toggle("hide");
  });

  // Descuento
  $("btnApplyDisc").addEventListener("click", ()=>{
    const type = $("discType").value;
    const value = Number($("discValue").value||0);
    if(type==="NONE"){ state.discount = {type:"NONE", value:0}; syncDiscUI(); renderCart(); return; }
    if(value<0) return alert("Descuento inv√°lido.");
    if(type==="PCT" && value>100) return alert("Porcentaje m√°ximo 100%.");
    state.discount = {type, value};
    renderCart();
  });
  $("btnClearDisc").addEventListener("click", ()=>{
    state.discount = {type:"NONE", value:0};
    syncDiscUI();
    renderCart();
  });

  // Inventory
  $("invSearch").addEventListener("input", ()=>{ if(state.view==="inventory") renderInventory(); });
  $("btnInvRefresh").addEventListener("click", renderInventory);

  // Kardex
  $("kdxSearch")?.addEventListener("input", renderKardex);
  $("kdxType")?.addEventListener("change", renderKardex);
  $("kdxFrom")?.addEventListener("change", renderKardex);
  $("kdxTo")?.addEventListener("change", renderKardex);
  $("btnKdxRefresh")?.addEventListener("click", renderKardex);

  // Shipments
  $("shipSearch").addEventListener("input", renderShipments);
  $("shipFilter").addEventListener("change", renderShipments);
  $("btnShipRefresh").addEventListener("click", renderShipments);
  $("shipBody").addEventListener("click", async (e)=>{
    const view = e.target.closest("button[data-viewship]");
    const pay  = e.target.closest("button[data-payship]");
    const del  = e.target.closest("button[data-delship]");

    if(view){
      const s = await idbGet("shipments", view.dataset.viewship);
      if(s){
        state.lastReceipt = s;
        updateReceiptPreview();
        setView("pos");
        alert("Env√≠o cargado en vista POS. Puedes generar WhatsApp/PDF/PNG. (No cuenta como venta hasta PAGADO)");
      }
    }
    if(pay) await markShipmentPaid(pay.dataset.payship);
    if(del) await deleteShipment(del.dataset.delship);
  });

  // Cierre
  $("btnBuildClose").addEventListener("click", async ()=>{ await buildClose(); alert("Cierre generado ‚úÖ"); });
  $("btnSaveClose").addEventListener("click", saveClose);
  $("closeDate").addEventListener("change", async ()=>{ if(state.view==="close"){ await buildClose(); await renderSavedCloses();
  renderKardex(); } });
  $("closeFrom").addEventListener("change", ()=>{ if(state.view==="close") buildClose(); });
  $("closeTo").addEventListener("change", ()=>{ if(state.view==="close") buildClose(); });
  ["realCash","realCard","realTrans"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ if(state.view==="close") buildClose(); });
  });

  $("btnCloseListRefresh").addEventListener("click", renderSavedCloses);
  $("closeSavedBody").addEventListener("click", async (e)=>{
    const v = e.target.closest("button[data-viewclose]");
    const d = e.target.closest("button[data-delclose]");
    if(v) await viewSavedClose(v.dataset.viewclose);
    if(d) await deleteSavedClose(d.dataset.delclose);
  });

  $("btnCloseCopy").addEventListener("click", copyClose);
  $("btnClosePDF").addEventListener("click", generateClosePDF);
  $("btnClosePNG").addEventListener("click", downloadClosePNG);
  $("btnCloseWA").addEventListener("click", openCloseWhatsApp);

  // Scan button
  $("btnScan").addEventListener("click", async ()=>{
    const code = $("scanInput").value.trim();
    const qty = Number($("qtyInput").value||1);
    if(!code){ $("scanInput").focus(); $("scanInput").select(); return; }
    const p = await getProductByCode(code);
    if(!p) return alert("No existe producto con c√≥digo: " + code);
    cartAdd(p, qty);
    $("scanInput").value="";
    $("qtyInput").value=1;
    $("scanInput").focus();
  });

  // Scan enter
  $("scanInput").addEventListener("keydown", async (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const code = $("scanInput").value.trim();
      const qty = Number($("qtyInput").value||1);
      if(!code) return;
      const p = await getProductByCode(code);
      if(!p) return alert("No existe producto con c√≥digo: " + code);
      cartAdd(p, qty);
      $("scanInput").value="";
      $("qtyInput").value=1;
      $("scanInput").focus();
    }
  });

  // Product search picker
  $("productSearch").addEventListener("input", refreshProductPicker);
  $("btnAddPicked").addEventListener("click", async ()=>{
    const code = $("productPicker").value;
    if(!code) return;
    const p = await getProductByCode(code);
    if(!p) return alert("Producto no existe.");
    cartAdd(p, Number($("qtyInput").value||1));
    $("qtyInput").value=1;
    $("scanInput").focus();
  });

  // NUEVO: filtro carrito + agregar por Enter (si es c√≥digo)
  $("cartSearch").addEventListener("input", ()=>{
    cartFilterText = $("cartSearch").value;
    renderCart();
  });
  $("btnCartFocus").addEventListener("click", ()=>{
    $("cartSearch").focus();
    $("cartSearch").select();
  });
  $("cartSearch").addEventListener("keydown", async (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const v = $("cartSearch").value.trim();
      if(!v) return;
      const qty = Number($("qtyInput").value||1);

      // si existe por c√≥digo exacto, agrega al carrito (ideal para lector)
      const p = await getProductByCode(v);
      if(p){
        cartAdd(p, qty);
        $("cartSearch").value="";
        cartFilterText="";
        renderCart();
        $("scanInput").focus();
        return;
      }
      // si no existe exacto, se queda como filtro
      cartFilterText = v;
      renderCart();
    }
  });

  // Cart actions
  $("cartBody").addEventListener("click",(e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const code = b.dataset.code;
    const act = b.dataset.act;
    if(act==="minus") cartInc(code,-1);
    if(act==="plus")  cartInc(code, 1);
    if(act==="del")   { state.cart = state.cart.filter(x=>x.code!==code); renderCart(); }
  });

  $("btnClearCart").addEventListener("click", cartClear);
  $("btnCheckout").addEventListener("click", checkout);

  // Client find/save
  $("btnFindClient").addEventListener("click", async ()=>{
    const phone = $("cPhone").value.trim();
    if(!phone) return alert("Ingrese tel√©fono.");
    const c = await findClientByPhone(phone);
    if(!c){
      alert("No existe. Completa los datos y presiona Guardar.");
      state.selectedClient = null;
      updateReceiptPreview();
      return;
    }
    state.selectedClient = c;
    $("cNames").value = c.names || "";
    $("cLast").value  = c.last || "";
    $("cAddr").value  = c.addr || "";
    alert("Cliente cargado.");
    updateReceiptPreview();
  });
  $("btnSaveClient").addEventListener("click", saveClientFromForm);
  $("btnUseWalkIn").addEventListener("click", ()=>{
    if($("saleType").value==="ENVIO"){
      alert("En ENV√çO no se permite venta sin cliente.");
      return;
    }
    state.selectedClient = null;
    $("cPhone").value=""; $("cNames").value=""; $("cLast").value=""; $("cAddr").value="";
    alert("Listo: venta MOSTRADOR sin cliente.");
    updateReceiptPreview();
  });

  $("saleType").addEventListener("change", ()=>{
    if($("saleType").value==="ENVIO") $("cPhone").focus();
    updateReceiptPreview();
  });
  $("payMethod").addEventListener("change", updateReceiptPreview);

  // Receipt buttons
  $("btnCopyReceipt").addEventListener("click", copyReceipt);
  $("btnPDF").addEventListener("click", generatePDF);
  $("btnDownloadReceipt").addEventListener("click", downloadReceiptPNG);
  $("btnWhatsApp").addEventListener("click", openWhatsApp);

  // Clients table actions
  $("clientsBody").addEventListener("click", async (e)=>{
    const use = e.target.closest("button[data-useclient]");
    const del = e.target.closest("button[data-delclient]");
    if(use){
      const c = await findClientByPhone(use.dataset.useclient);
      if(c){
        state.selectedClient = c;
        $("cPhone").value=c.phone; $("cNames").value=c.names; $("cLast").value=c.last; $("cAddr").value=c.addr;
        setView("pos");
        updateReceiptPreview();
      }
    }
    if(del){
      if(!requireCode("borrar cliente")) return;
      const phone = del.dataset.delclient;
      if(confirm("¬øBorrar cliente "+phone+"?")){
        await idbDel("clients", phone);
        await refreshKPIs();
        renderClients();
      }
    }
  });
  $("clientSearch").addEventListener("input", renderClients);
  $("btnClientRefresh").addEventListener("click", renderClients);

  // Products actions
  $("btnSaveProduct").addEventListener("click", saveProductFromForm);
  $("prodSearch").addEventListener("input", renderProducts);
  $("btnProdRefresh").addEventListener("click", ()=>{ renderProducts(); refreshProductPicker(); });

  $("productsBody").addEventListener("click", async (e)=>{
    const fill = e.target.closest("button[data-fillprod]");
    const del  = e.target.closest("button[data-delprod]");
    if(fill){
      if(!requireCode("editar producto")) return;
      const p = await getProductByCode(fill.dataset.fillprod);
      if(!p) return;
      $("pCode").value = p.code;
      $("pName").value = p.name;
      $("pPrice").value= p.price;
      $("pStock").value= p.stock;
      $("pCode").focus();
    }
    if(del){
      if(!requireCode("borrar producto")) return;
      const code = del.dataset.delprod;
      if(confirm("¬øBorrar producto "+code+"?")){
        await idbDel("products", code);
        await refreshKPIs();
        renderProducts();
        refreshProductPicker();
        renderInventory();
      }
    }
  });

  // Reports actions
  $("btnRepDaily").addEventListener("click", ()=>renderReport("daily"));
  $("btnRepWeekly").addEventListener("click", ()=>renderReport("weekly"));
  $("btnRepMonthly").addEventListener("click", ()=>renderReport("monthly"));

  $("salesBody").addEventListener("click", async (e)=>{
    const view = e.target.closest("button[data-viewsale]");
    const del  = e.target.closest("button[data-delsale]");
    if(view){
      const s = await idbGet("sales", view.dataset.viewsale);
      if(s){
        state.lastReceipt = s;
        updateReceiptPreview();
        setView("pos");
        alert("Recibo cargado en vista POS. Puedes copiar/WhatsApp/PNG/PDF.");
      }
    }
    if(del){
      if(!requireCode("borrar venta")) return;
      if(confirm("¬øBorrar venta?")){
        await idbDel("sales", del.dataset.delsale);
        await refreshKPIs();
        renderReport("daily");
        buildClose();
      }
    }
  });

  // Backup / restore
  $("btnBackup").addEventListener("click", async ()=>{
    if(!requireBackupCode("exportar backup")) return;
    await exportJSON();
  });
  $("btnRestore").addEventListener("click", ()=>{
    if(!requireBackupCode("importar backup")) return;
    $("restoreFile").click();
  });
  $("restoreFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{ await importJSON(file); }
    catch(err){ alert("Error importando: " + err.message); }
    e.target.value="";
  });

  // Live updates on receipt when typing client fields (solo ENV√çO)
  ["cPhone","cNames","cLast","cAddr"].forEach(id=>{
    $(id).addEventListener("input", ()=>{
      if($("saleType").value==="ENVIO"){
        const phone = $("cPhone").value.trim();
        const names = $("cNames").value.trim();
        const last  = $("cLast").value.trim();
        const addr  = $("cAddr").value.trim();
        state.selectedClient = (phone||names||last||addr) ? {phone,names,last,addr} : null;
      }
      updateReceiptPreview();
    });
  });

  // Focus scan input by F2
  window.addEventListener("keydown",(e)=>{
    if(e.key==="F2"){
      e.preventDefault();
      $("scanInput").focus();
      $("scanInput").select();
    }
  });

  // Settings save
  $("btnSaveSettings").addEventListener("click", saveSettings);
}

// ---------- Init ----------
(async function init(){
  try{
  db = await openDB();
  await loadSettings();
  await refreshKPIs();
  await refreshProductPicker();
  cartFilterText = "";
  renderCart();
  syncDiscUI();
  wireEvents();

  $("closeDate").value = todayKey();
  $("closeFrom").value = "00:00";
  $("closeTo").value = "23:59";

  setView("pos");

  const meta = await idbGet("meta","receiptNo");
  const n = meta?.value ? (meta.value-1) : 1;
  $("rNo").textContent = "#"+pad(Math.max(1,n),6);

  updateReceiptPreview();
  buildClose();
  renderShipments();
  renderSavedCloses();
  renderKardex();

  // Enfoca scan de una vez
  setTimeout(()=>{ try{$("scanInput").focus();}catch(e){} }, 200);
})();
</script>
</body>
</html>
